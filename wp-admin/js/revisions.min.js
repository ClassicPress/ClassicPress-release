window.wp=window.wp||{},function(e){var t,i,s,o=document.getElementById("from-slider"),n=document.getElementById("to-slider"),r=document.querySelector(".from-slider-wrapper"),d=document.querySelectorAll("#ticks option"),a=location.href;function l(e){return!!(e.offsetWidth||e.offsetHeight||e.getClientRects().length)}o.addEventListener("input",(function(){l(o)&&o.value>=n.value&&(o.value=parseInt(n.value,10)-1,o.setAttribute("value",o.value)),s.set({from:l(o)?s.revisions._byId[t[o.value]]:s.revisions._byId[t[0]],to:s.revisions._byId[t[n.value]]}),history.pushState("Title","",a.replace(parseInt(a.substring(a.indexOf("=")+1),10).toString(),t[o.value]))})),n.addEventListener("input",(function(){l(o)&&n.value<=o.value&&(n.value=parseInt(o.value,10)+1,n.setAttribute("value",n.value)),s.set({from:l(o)?s.revisions._byId[t[o.value]]:s.revisions._byId[t[parseInt(n.value)-1]],to:s.revisions._byId[t[n.value]]}),history.pushState("Title","",a.replace(a.split("&to=")[1],t[n.value]))})),document.addEventListener("change",(function(){a=location.href,n.setAttribute("value",t.indexOf(parseInt(a.substring(a.indexOf("&to=")+4),10).toString())),document.querySelector(".compare-two-revisions").checked?(r.style.display="inline",o.setAttribute("value",parseInt(n.value,10)-1)):r.style.display="none"})),t=document.getElementById("revisions-list").value.split(", "),o.value=t.indexOf(parseInt(a.substring(a.indexOf("=")+1),10).toString()),o.setAttribute("value",o.value),a.includes("&to=")&&(r.style.display="inline",o.value=t.indexOf(location.href.split("&from=")[1]),o.setAttribute("value",o.value)),document.addEventListener("click",(function(e){"button"===e.target.className&&("revisions-previous"===e.target.parentNode.className?n.value=parseInt(n.value,10)-1:n.value=parseInt(n.value,10)+1,n.setAttribute("value",n.value))})),d.forEach((function(e){var t=document.getElementById("current-tooltip");e.addEventListener("mouseover",(function(){t.style.backgroundColor="#fff",t.innerHTML=e.dataset.tooltip.replace("{{",'<span style="color:#d63638">').replace("}}","</span>").replace("[[","<strong>").replace("]]","</strong><br>")})),e.addEventListener("mouseout",(function(){t.style.backgroundColor="transparent",t.innerHTML=""}))})),(i=wp.revisions={model:{},view:{},controller:{}}).settings=window._wpRevisionsSettings||{},i.debug=!1,i.log=function(){window.console&&i.debug&&window.console.log.apply(window.console,arguments)},e.fn.allOffsets=function(){var t=this.offset()||{top:0,left:0},i=e(window);return _.extend(t,{right:i.width()-t.left-this.outerWidth(),bottom:i.height()-t.top-this.outerHeight()})},e.fn.allPositions=function(){var e=this.position()||{top:0,left:0},t=this.parent();return _.extend(e,{right:t.outerWidth()-e.left-this.outerWidth(),bottom:t.outerHeight()-e.top-this.outerHeight()})},i.model.Slider=Backbone.Model.extend({defaults:{value:null,values:null,min:0,max:1,step:1,range:!1,compareTwoMode:!1},initialize:function(e){this.frame=s=e.frame,this.revisions=e.revisions,this.listenTo(this.frame,"update:revisions",this.receiveRevisions),this.listenTo(this.frame,"change:compareTwoMode",this.updateMode),this.on("change:compareTwoMode",this.updateSliderSettings),this.on("update:revisions",this.updateSliderSettings),this.set({max:this.revisions.length-1,compareTwoMode:this.frame.get("compareTwoMode"),from:this.frame.get("from"),to:this.frame.get("to")}),this.updateSliderSettings()},getSliderValue:function(e,t){return isRtl?this.revisions.length-this.revisions.indexOf(this.get(e))-1:this.revisions.indexOf(this.get(t))},updateSliderSettings:function(){this.get("compareTwoMode")?this.set({values:[this.getSliderValue("to","from"),this.getSliderValue("from","to")],value:null,range:!0}):this.set({value:this.getSliderValue("to","to"),values:null,range:!1}),this.trigger("update:slider")},updateMode:function(e,t){this.set({compareTwoMode:t})},receiveRevisions:function(e,t){this.get("from")===e&&this.get("to")===t||(this.set({from:e,to:t},{silent:!0}),this.trigger("update:revisions",e,t))}}),i.model.Tooltip=Backbone.Model.extend({defaults:{revision:null,offset:{},hovering:!1,scrubbing:!1},initialize:function(e){this.frame=e.frame,this.revisions=e.revisions,this.slider=e.slider,this.listenTo(this.slider,"change:scrubbing",this.setScrubbing)},updateRevision:function(e){this.set({revision:e})},setHovering:function(e,t){this.set({hovering:t})},setScrubbing:function(e,t){this.set({scrubbing:t})}}),i.model.Revision=Backbone.Model.extend({}),i.model.Revisions=Backbone.Collection.extend({model:i.model.Revision,initialize:function(){_.bindAll(this,"next","prev")},next:function(e){var t=this.indexOf(e);if(-1!==t&&t!==this.length-1)return this.at(t+1)},prev:function(e){var t=this.indexOf(e);if(-1!==t&&0!==t)return this.at(t-1)}}),i.model.Field=Backbone.Model.extend({}),i.model.Fields=Backbone.Collection.extend({model:i.model.Field}),i.model.Diff=Backbone.Model.extend({initialize:function(){var e=this.get("fields");this.unset("fields"),this.fields=new i.model.Fields(e)}}),i.model.Diffs=Backbone.Collection.extend({initialize:function(e,t){_.bindAll(this,"getClosestUnloaded"),this.loadAll=_.once(this._loadAll),this.revisions=t.revisions,this.postId=t.postId,this.requests={}},model:i.model.Diff,ensure:function(t,i){var s=this.get(t),o=this.requests[t],n=e.Deferred(),r={},d=t.split(":")[0],a=t.split(":")[1];return r[t]=!0,wp.revisions.log("ensure",t),this.trigger("ensure",r,d,a,n.promise()),s?n.resolveWith(i,[s]):(this.trigger("ensure:load",r,d,a,n.promise()),_.each(r,_.bind((function(e){this.requests[e]&&delete r[e],this.get(e)&&delete r[e]}),this)),o||(r[t]=!0,o=this.load(_.keys(r))),o.done(_.bind((function(){n.resolveWith(i,[this.get(t)])}),this)).fail(_.bind((function(){n.reject()})))),n.promise()},getClosestUnloaded:function(e,t){var i=this;return _.chain([0].concat(e)).initial().zip(e).sortBy((function(e){return Math.abs(t-e[1])})).map((function(e){return e.join(":")})).filter((function(e){return _.isUndefined(i.get(e))&&!i.requests[e]})).value()},_loadAll:function(t,i,s){var o=this,n=e.Deferred(),r=_.first(this.getClosestUnloaded(t,i),s);return _.size(r)>0?this.load(r).done((function(){o._loadAll(t,i,s).done((function(){n.resolve()}))})).fail((function(){1===s?n.reject():o._loadAll(t,i,Math.ceil(s/2)).done((function(){n.resolve()}))})):n.resolve(),n},load:function(e){return wp.revisions.log("load",e),this.fetch({data:{compare:e},remove:!1}).done((function(){wp.revisions.log("load:complete",e)}))},sync:function(e,t,i){if("read"===e){(i=i||{}).context=this,i.data=_.extend(i.data||{},{action:"get-revision-diffs",post_id:this.postId});var s=wp.ajax.send(i),o=this.requests;return i.data.compare&&_.each(i.data.compare,(function(e){o[e]=s})),s.always((function(){i.data.compare&&_.each(i.data.compare,(function(e){delete o[e]}))})),s}return Backbone.Model.prototype.sync.apply(this,arguments)}}),i.model.FrameState=Backbone.Model.extend({defaults:{loading:!1,error:!1,compareTwoMode:!1},initialize:function(e,t){var s=this.get("initialDiffState");_.bindAll(this,"receiveDiff"),this._debouncedEnsureDiff=_.debounce(this._ensureDiff,200),this.revisions=t.revisions,this.diffs=new i.model.Diffs([],{revisions:this.revisions,postId:this.get("postId")}),this.diffs.set(this.get("diffData")),this.listenTo(this,"change:from",this.changeRevisionHandler),this.listenTo(this,"change:to",this.changeRevisionHandler),this.listenTo(this,"change:compareTwoMode",this.changeMode),this.listenTo(this,"update:revisions",this.updatedRevisions),this.listenTo(this.diffs,"ensure:load",this.updateLoadingStatus),this.listenTo(this,"update:diff",this.updateLoadingStatus),this.set({to:this.revisions.get(s.to),from:this.revisions.get(s.from),compareTwoMode:s.compareTwoMode})},updateLoadingStatus:function(){this.set("error",!1),this.set("loading",!this.diff())},changeMode:function(e,t){var i=this.revisions.indexOf(this.get("to"));t&&0===i&&this.set({from:this.revisions.at(i),to:this.revisions.at(i+1)}),t||0===i||this.set({from:this.revisions.at(i-1),to:this.revisions.at(i)})},updatedRevisions:function(e,t){this.get("compareTwoMode")||this.diffs.loadAll(this.revisions.pluck("id"),t.id,40)},diff:function(){return this.diffs.get(this._diffId)},updateDiff:function(t){var i,s,o,n;return t=t||{},i=this.get("from"),s=this.get("to"),o=(i?i.id:0)+":"+s.id,this._diffId===o?e.Deferred().reject().promise():(this._diffId=o,this.trigger("update:revisions",i,s),(n=this.diffs.get(o))?(this.receiveDiff(n),e.Deferred().resolve().promise()):t.immediate?this._ensureDiff():(this._debouncedEnsureDiff(),e.Deferred().reject().promise()))},changeRevisionHandler:function(){this.updateDiff()},receiveDiff:function(e){_.isUndefined(e)||_.isUndefined(e.id)?this.set({loading:!1,error:!0}):this._diffId===e.id&&this.trigger("update:diff",e)},_ensureDiff:function(){return this.diffs.ensure(this._diffId,this).always(this.receiveDiff)}}),i.view.Frame=wp.Backbone.View.extend({className:"revisions",template:wp.template("revisions-frame"),initialize:function(){this.listenTo(this.model,"update:diff",this.renderDiff),this.listenTo(this.model,"change:compareTwoMode",this.updateCompareTwoMode),this.listenTo(this.model,"change:loading",this.updateLoadingStatus),this.listenTo(this.model,"change:error",this.updateErrorStatus),this.views.set(".revisions-control-frame",new i.view.Controls({model:this.model}))},render:function(){return wp.Backbone.View.prototype.render.apply(this,arguments),e("html").css("overflow-y","scroll"),e("#wpbody-content .wrap").append(this.el),this.updateCompareTwoMode(),this.renderDiff(this.model.diff()),this.views.ready(),this},renderDiff:function(e){this.views.set(".revisions-diff-frame",new i.view.Diff({model:e}))},updateLoadingStatus:function(){this.$el.toggleClass("loading",this.model.get("loading"))},updateErrorStatus:function(){this.$el.toggleClass("diff-error",this.model.get("error"))},updateCompareTwoMode:function(){this.$el.toggleClass("comparing-two-revisions",this.model.get("compareTwoMode"))}}),i.view.Controls=wp.Backbone.View.extend({className:"revisions-controls",initialize:function(){_.bindAll(this,"setWidth"),this.views.add(new i.view.Buttons({model:this.model})),this.views.add(new i.view.Checkbox({model:this.model}));var e=new i.model.Slider({frame:this.model,revisions:this.model.revisions});this.views.add(new i.view.Slider({model:e})),this.views.add(new i.view.Metabox({model:this.model}))},ready:function(){this.top=this.$el.offset().top,this.window=e(window),this.window.on("scroll.wp.revisions",{controls:this},(function(e){var t=e.data.controls,i=t.$el.parent(),s=t.window.scrollTop(),o=t.views.parent;s>=t.top?(o.$el.hasClass("pinned")||(t.setWidth(),i.css("height",i.height()+"px"),t.window.on("resize.wp.revisions.pinning click.wp.revisions.pinning",{controls:t},(function(e){e.data.controls.setWidth()}))),o.$el.addClass("pinned")):o.$el.hasClass("pinned")?(t.window.off(".wp.revisions.pinning"),t.$el.css("width","auto"),o.$el.removeClass("pinned"),i.css("height","auto"),t.top=t.$el.offset().top):t.top=t.$el.offset().top}))},setWidth:function(){this.$el.css("width",this.$el.parent().width()+"px")}}),i.view.Metabox=wp.Backbone.View.extend({className:"revisions-meta",initialize:function(){this.views.add(new i.view.MetaFrom({model:this.model,className:"diff-meta diff-meta-from"})),this.views.add(new i.view.MetaTo({model:this.model}))}}),i.view.Meta=wp.Backbone.View.extend({template:wp.template("revisions-meta"),events:{"click .restore-revision":"restoreRevision"},initialize:function(){this.listenTo(this.model,"update:revisions",this.render)},prepare:function(){return _.extend(this.model.toJSON()[this.type]||{},{type:this.type})},restoreRevision:function(){document.location=this.model.get("to").attributes.restoreUrl}}),i.view.MetaFrom=i.view.Meta.extend({className:"diff-meta diff-meta-from",type:"from"}),i.view.MetaTo=i.view.Meta.extend({className:"diff-meta diff-meta-to",type:"to"}),i.view.Checkbox=wp.Backbone.View.extend({className:"revisions-checkbox",template:wp.template("revisions-checkbox"),events:{"click .compare-two-revisions":"compareTwoToggle"},initialize:function(){this.listenTo(this.model,"change:compareTwoMode",this.updateCompareTwoMode)},ready:function(){this.model.revisions.length<3&&e(".revision-toggle-compare-mode").hide()},updateCompareTwoMode:function(){this.$(".compare-two-revisions").prop("checked",this.model.get("compareTwoMode"))},compareTwoToggle:function(){this.model.set({compareTwoMode:e(".compare-two-revisions").prop("checked")})}}),i.view.Buttons=wp.Backbone.View.extend({className:"revisions-buttons",template:wp.template("revisions-buttons"),events:{"click .revisions-next .button":"nextRevision","click .revisions-previous .button":"previousRevision"},initialize:function(){this.listenTo(this.model,"update:revisions",this.disabledButtonCheck)},ready:function(){this.disabledButtonCheck()},gotoModel:function(e){var t={to:this.model.revisions.at(e)};e?t.from=this.model.revisions.at(e-1):this.model.unset("from",{silent:!0}),this.model.set(t)},nextRevision:function(){var e=this.model.revisions.indexOf(this.model.get("to"))+1;this.gotoModel(e)},previousRevision:function(){var e=this.model.revisions.indexOf(this.model.get("to"))-1;this.gotoModel(e)},disabledButtonCheck:function(){var t=this.model.revisions.length-1,i=e(".revisions-next .button"),s=e(".revisions-previous .button"),o=this.model.revisions.indexOf(this.model.get("to"));i.prop("disabled",t===o),s.prop("disabled",0===o)}}),i.view.Slider=wp.Backbone.View.extend({initialize:function(){this.listenTo(this.model,"update:slider",this.applySliderSettings)},ready:function(){this.applySliderSettings()},applySliderSettings:function(){this.model.get("compareTwoMode")?(o.value=this.model.toJSON().values[0],n.value=this.model.toJSON().values[1]):o.value=this.model.toJSON().value}}),i.view.Diff=wp.Backbone.View.extend({className:"revisions-diff",template:wp.template("revisions-diff"),prepare:function(){return _.extend({fields:this.model.fields.toJSON()},this.options)}}),i.init=function(){var e;window.adminpage&&"revision-php"===window.adminpage&&(e=new i.model.FrameState({initialDiffState:{to:parseInt(i.settings.to,10),from:parseInt(i.settings.from,10),compareTwoMode:"1"===i.settings.compareTwoMode},diffData:i.settings.diffData,baseUrl:i.settings.baseUrl,postId:parseInt(i.settings.postId,10)},{revisions:new i.model.Revisions(i.settings.revisionData)}),i.view.frame=new i.view.Frame({model:e}).render())},e(i.init)}(jQuery);