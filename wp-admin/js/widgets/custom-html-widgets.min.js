wp.customHtmlWidgets=function(e){"use strict";var t={idBases:["custom_html"],codeEditorSettings:{},l10n:{errorNotice:{singular:"",plural:""}}};return t.CustomHtmlWidgetControl=Backbone.View.extend({events:{},initialize:function(i){var n=this;if(!i.el)throw new Error("Missing options.el");if(!i.syncContainer)throw new Error("Missing options.syncContainer");Backbone.View.prototype.initialize.call(n,i),n.syncContainer=i.syncContainer,n.widgetIdBase=n.syncContainer.parentNode.querySelector(".id_base").value,n.widgetNumber=n.syncContainer.parentNode.querySelector(".widget_number").value,n.customizeSettingId="widget_"+n.widgetIdBase+"["+String(n.widgetNumber)+"]",n.$el.addClass("custom-html-widget-fields"),n.$el.html(wp.template("widget-custom-html-control-fields")({codeEditorDisabled:t.codeEditorSettings.disabled})),n.errorNoticeContainer=n.$el.find(".code-editor-error-container"),n.currentErrorAnnotations=[],n.saveButton=e(n.syncContainer).add(e(n.syncContainer).parent().find(".widget-control-actions")).find(".widget-control-save, #savewidget"),n.saveButton.addClass("custom-html-widget-save-button"),n.fields={title:n.$el.find(".title"),content:n.$el.find(".content")},_.each(n.fields,(function(e,t){e.on("input change",(function(){var i=n.syncContainer.querySelector("."+t+".sync-input");i&&i.value!==e[0].value&&(i.value=e[0].value,i.dispatchEvent(new Event("change")))})),n.syncContainer.querySelector("."+t+".sync-input")&&(e[0].value=n.syncContainer.querySelector("."+t+".sync-input").value)}))},updateFields:function(){var e,t=this;t.fields.title.is(document.activeElement)||(e=t.syncContainer.querySelector(".title.sync-input"),t.fields.title.value=e.value),t.contentUpdateBypassed=t.fields.content.is(document.activeElement)||t.editor&&t.editor.codemirror.state.focused||0!==t.currentErrorAnnotations.length,t.contentUpdateBypassed||(e=t.syncContainer.querySelector(".content.sync-input"),t.fields.content.value=e.value)},updateErrorNotice:function(i){var n,o,r=this,d="";1===i.length?d=t.l10n.errorNotice.singular.replace("%d","1"):i.length>1&&(d=t.l10n.errorNotice.plural.replace("%d",String(i.length))),r.fields.content[0].setCustomValidity&&r.fields.content[0].setCustomValidity(d),wp.customize&&wp.customize.has(r.customizeSettingId)?((o=wp.customize(r.customizeSettingId)).notifications.remove("htmlhint_error"),0!==i.length&&o.notifications.add("htmlhint_error",new wp.customize.Notification("htmlhint_error",{message:d,type:"error"}))):0!==i.length?((n=e('<div class="inline notice notice-error notice-alt"></div>')).append(e("<p></p>",{text:d})),r.errorNoticeContainer.empty(),r.errorNoticeContainer.append(n),r.errorNoticeContainer.slideDown("fast"),wp.a11y.speak(d)):r.errorNoticeContainer.slideUp("fast")},initializeEditor:function(){var i,n=this;t.codeEditorSettings.disabled||(i=_.extend({},t.codeEditorSettings,{onTabPrevious:function(){n.fields.title.focus()},onTabNext:function(){n.syncContainer.add(n.syncContainer.parent().find(".widget-position, .widget-control-actions")).find(":tabbable").first().focus()},onChangeLintingErrors:function(e){n.currentErrorAnnotations=e},onUpdateErrorNotice:function(e){n.saveButton.toggleClass("validation-blocked disabled",e.length>0),n.updateErrorNotice(e)}}),n.editor=wp.codeEditor.initialize(n.fields.content,i),e(n.editor.codemirror.display.lineDiv).attr({role:"textbox","aria-multiline":"true","aria-labelledby":n.fields.content[0].id+"-label","aria-describedby":"editor-keyboard-trap-help-1 editor-keyboard-trap-help-2 editor-keyboard-trap-help-3 editor-keyboard-trap-help-4"}),e("#"+n.fields.content[0].id+"-label").on("click",(function(){n.editor.codemirror.focus()})),n.fields.content.on("change",(function(){this.value!==n.editor.codemirror.getValue()&&n.editor.codemirror.setValue(this.value)})),n.editor.codemirror.on("change",(function(){var e=n.editor.codemirror.getValue(),t=n.editor.codemirror.display.input.div.closest("li"),i=t.querySelector(".widget-control-save");e!==n.fields.content[0].value&&(n.fields.content[0].value=e,n.fields.content[0].dispatchEvent(new Event("change"))),t.classList.add("widget-dirty"),i.disabled=!1,i.value=wp.i18n.__("Save")})),n.editor.codemirror.on("blur",(function(){n.contentUpdateBypassed&&n.syncContainer.querySelector(".sync-input.content").dispatchEvent(new Event("change"))})),wp.customize&&n.editor.codemirror.on("keydown",(function(e,t){"Escape"===t.key&&t.stopPropagation()})))}}),t.widgetControls={},t.handleWidgetAdded=function(e){var i,n,o,r,d,a,l=e.detail.widget;null==l.querySelector(".widget-inside > .form")&&l.querySelector(".widget-inside > form"),i=l.querySelector(".id_base").value,-1!==t.idBases.indexOf(i)&&(o=l.querySelector(".widget-id").value,t.widgetControls[o]||(d=document.createElement("div"),(a=l.querySelector(".widget-content")).before(d),n=new t.CustomHtmlWidgetControl({el:d,syncContainer:a}),t.widgetControls[o]=n,(r=function(){l.querySelector("details").hasAttribute("open")?n.initializeEditor():setTimeout(r,50)})()))},t.setupAccessibleMode=function(){var e,i,n,o;null!=(e=document.querySelector(".editwidget > form"))&&(i=e.querySelector(".id_base").value,-1!==t.idBases.indexOf(i)&&(n=document.createElement("div"),(o=e.querySelector(".widget-inside")).before(n),new t.CustomHtmlWidgetControl({el:n,syncContainer:o}).initializeEditor()))},t.handleWidgetUpdated=function(e){var i,n,o,r=e.detail.widget;null==r.querySelector(".widget-inside > .form")&&r.querySelector(".widget-inside > form"),o=r.querySelector(".id_base").value,-1!==t.idBases.indexOf(o)&&(i=r.querySelector(".widget-id").value,(n=t.widgetControls[i])&&n.updateFields())},t.init=function(i){_.extend(t.codeEditorSettings,i),document.addEventListener("widget-added",t.handleWidgetAdded),document.addEventListener("widget-synced",t.handleWidgetUpdated),document.addEventListener("widget-updated",t.handleWidgetUpdated),e((function(){var e=[];"widgets"===window.pagenow&&(document.querySelectorAll(".widgets-holder-wrap:not(#available-widgets)").forEach((function(t){t.querySelectorAll("li.widget").forEach((function(t){e.push(t)}))})),e.forEach((function(e){e.querySelector("details").addEventListener("toggle",(function(){document.dispatchEvent(new CustomEvent("widget-added",{detail:{widget:e}}))}),{once:!0})})),"complete"===document.readyState?t.setupAccessibleMode():window.onload=function(){t.setupAccessibleMode()})}))},t}(jQuery);