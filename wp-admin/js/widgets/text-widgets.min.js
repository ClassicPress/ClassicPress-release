wp.textWidgets=function(r){"use strict";var u={dismissedPointers:[],idBases:["text"]};return u.TextWidgetControl=Backbone.View.extend({events:{},initialize:function(e){var n=this;if(!e.el)throw new Error("Missing options.el");if(!e.syncContainer)throw new Error("Missing options.syncContainer");Backbone.View.prototype.initialize.call(n,e),n.syncContainer=e.syncContainer,n.$el.addClass("text-widget-fields"),n.$el.html(wp.template("widget-text-control-fields")),n.customHtmlWidgetPointer=n.$el.find(".wp-pointer.custom-html-widget-pointer"),n.customHtmlWidgetPointer.length&&(n.customHtmlWidgetPointer.find(".close").on("click",function(e){e.preventDefault(),n.customHtmlWidgetPointer.hide(),r("#"+n.fields.text.attr("id")+"-html").focus(),n.dismissPointers(["text_widget_custom_html"])}),n.customHtmlWidgetPointer.find(".add-widget").on("click",function(e){e.preventDefault(),n.customHtmlWidgetPointer.hide(),n.openAvailableWidgetsPanel()})),n.pasteHtmlPointer=n.$el.find(".wp-pointer.paste-html-pointer"),n.pasteHtmlPointer.length&&n.pasteHtmlPointer.find(".close").on("click",function(e){e.preventDefault(),n.pasteHtmlPointer.hide(),n.editor.focus(),n.dismissPointers(["text_widget_custom_html","text_widget_paste_html"])}),n.fields={title:n.$el.find(".title"),text:n.$el.find(".text")},_.each(n.fields,function(t,i){t.on("input change",function(){var e=n.syncContainer.find(".sync-input."+i);e.val()!==t.val()&&(e.val(t.val()),e.trigger("change"))}),t.val(n.syncContainer.find(".sync-input."+i).val())})},dismissPointers:function(e){_.each(e,function(e){wp.ajax.post("dismiss-wp-pointer",{pointer:e}),u.dismissedPointers.push(e)})},openAvailableWidgetsPanel:function(){var t;wp.customize.section.each(function(e){e.extended(wp.customize.Widgets.SidebarSection)&&e.expanded()&&(t=wp.customize.control("sidebars_widgets["+e.params.sidebarId+"]"))}),t&&setTimeout(function(){wp.customize.Widgets.availableWidgetsPanel.open(t),wp.customize.Widgets.availableWidgetsPanel.$search.val("HTML").trigger("keyup")})},updateFields:function(){var e,t=this;t.fields.title.is(document.activeElement)||(e=t.syncContainer.find(".sync-input.title"),t.fields.title.val(e.val())),e=t.syncContainer.find(".sync-input.text"),t.fields.text.is(":visible")?t.fields.text.is(document.activeElement)||t.fields.text.val(e.val()):t.editor&&!t.editorFocused&&e.val()!==t.fields.text.val()&&t.editor.setContent(wp.editor.autop(e.val()))},initializeEditor:function(){var n,e,d,t,o=this,s=1e3,a=!1,l=!1;e=o.fields.text,n=e.attr("id"),t=e.val(),d=function(){o.editor.isDirty()&&(wp.customize&&wp.customize.state&&(wp.customize.state("processing").set(wp.customize.state("processing").get()+1),_.delay(function(){wp.customize.state("processing").set(wp.customize.state("processing").get()-1)},300)),o.editor.isHidden()||o.editor.save()),l&&t!==e.val()&&(e.trigger("change"),l=!1,t=e.val())},o.syncContainer.closest(".widget").find("[name=savewidget]:first").on("click",function(){d()}),function c(){var e,t,i;if(document.getElementById(n))if("undefined"!=typeof window.tinymce){if(tinymce.get(n)&&(a=tinymce.get(n).isHidden(),wp.editor.remove(n)),r(document).one("wp-before-tinymce-init.text-widget-init",function(e,t){t.plugins&&(/\bwpview\b/.test(t.plugins)||(t.plugins+=",wpview"))}),wp.editor.initialize(n,{tinymce:{wpautop:!0},quicktags:!0,mediaButtons:!0}),i=function(e){e.show(),e.find(".close").focus(),wp.a11y.speak(e.find("h3, p").map(function(){return r(this).text()}).get().join("\n\n"))},!(e=window.tinymce.get(n)))throw new Error("Failed to initialize editor");t=function(){r(e.getWin()).on("unload",function(){_.defer(c)}),a&&switchEditors.go(n,"html"),r("#"+n+"-html").on("click",function(){o.pasteHtmlPointer.hide(),-1===u.dismissedPointers.indexOf("text_widget_custom_html")&&i(o.customHtmlWidgetPointer)}),r("#"+n+"-tmce").on("click",function(){o.customHtmlWidgetPointer.hide()}),e.on("pastepreprocess",function(e){var t=e.content;-1===u.dismissedPointers.indexOf("text_widget_paste_html")&&t&&/&lt;\w+.*?&gt;/.test(t)&&_.delay(function(){i(o.pasteHtmlPointer)},250)})},e.initialized?t():e.on("init",t),o.editorFocused=!1,e.on("focus",function(){o.editorFocused=!0}),e.on("paste",function(){e.setDirty(!0),d()}),e.on("NodeChange",function(){l=!0}),e.on("NodeChange",_.debounce(d,s)),e.on("blur hide",function(){o.editorFocused=!1,d()}),o.editor=e}else wp.editor.initialize(n,{quicktags:!0,mediaButtons:!0})}()}}),u.widgetControls={},u.handleWidgetAdded=function(e,t){var i,n,d,o,s,a,l;n=(i=t.find("> .widget-inside > .form, > .widget-inside > form")).find("> .id_base").val(),-1!==u.idBases.indexOf(n)&&(o=i.find(".widget-id").val(),u.widgetControls[o]||i.find(".visual").val()&&(a=r("<div></div>"),(l=t.find(".widget-content:first")).before(a),d=new u.TextWidgetControl({el:a,syncContainer:l}),u.widgetControls[o]=d,(s=function(){t.hasClass("open")?d.initializeEditor():setTimeout(s,50)})()))},u.setupAccessibleMode=function(){var e,t,i,n;0!==(e=r(".editwidget > form")).length&&(t=e.find("> .widget-control-actions > .id_base").val(),-1!==u.idBases.indexOf(t)&&e.find(".visual").val()&&(i=r("<div></div>"),(n=e.find("> .widget-inside")).before(i),new u.TextWidgetControl({el:i,syncContainer:n}).initializeEditor()))},u.handleWidgetUpdated=function(e,t){var i,n,d,o;o=(i=t.find("> .widget-inside > .form, > .widget-inside > form")).find("> .id_base").val(),-1!==u.idBases.indexOf(o)&&(n=i.find("> .widget-id").val(),(d=u.widgetControls[n])&&d.updateFields())},u.init=function(){var e=r(document);e.on("widget-added",u.handleWidgetAdded),e.on("widget-synced widget-updated",u.handleWidgetUpdated),r(function(){"widgets"===window.pagenow&&(r(".widgets-holder-wrap:not(#available-widgets)").find("div.widget").one("click.toggle-widget-expanded",function(){var e=r(this);u.handleWidgetAdded(new jQuery.Event("widget-added"),e)}),r(window).on("load",function(){u.setupAccessibleMode()}))})},u}(jQuery);