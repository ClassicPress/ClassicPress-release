wp.textWidgets=function(e){"use strict";var t={dismissedPointers:[],idBases:["text"]};return t.TextWidgetControl=Backbone.View.extend({events:{},initialize:function(t){var i=this;if(!t.el)throw new Error("Missing options.el");if(!t.syncContainer)throw new Error("Missing options.syncContainer");Backbone.View.prototype.initialize.call(i,t),i.syncContainer=t.syncContainer,i.$el.addClass("text-widget-fields"),i.$el.html(wp.template("widget-text-control-fields")),i.customHtmlWidgetPointer=i.$el.find(".wp-pointer.custom-html-widget-pointer"),i.customHtmlWidgetPointer.length&&(i.customHtmlWidgetPointer.find(".close").on("click",(function(t){t.preventDefault(),i.customHtmlWidgetPointer.hide(),e("#"+i.fields.text.attr("id")+"-html").focus(),i.dismissPointers(["text_widget_custom_html"])})),i.customHtmlWidgetPointer.find(".add-widget").on("click",(function(e){e.preventDefault(),i.customHtmlWidgetPointer.hide(),i.openAvailableWidgetsPanel()}))),i.pasteHtmlPointer=i.$el.find(".wp-pointer.paste-html-pointer"),i.pasteHtmlPointer.length&&i.pasteHtmlPointer.find(".close").on("click",(function(e){e.preventDefault(),i.pasteHtmlPointer.hide(),i.editor.focus(),i.dismissPointers(["text_widget_custom_html","text_widget_paste_html"])})),i.fields={title:i.$el.find(".title"),text:i.$el.find(".text")},_.each(i.fields,(function(e,t){e.on("input change",(function(){var n=i.syncContainer.find(".sync-input."+t);n.val()!==e.val()&&(n.val(e.val()),n.trigger("change"))})),e.val(i.syncContainer.find(".sync-input."+t).val())}))},dismissPointers:function(e){_.each(e,(function(e){wp.ajax.post("dismiss-wp-pointer",{pointer:e}),t.dismissedPointers.push(e)}))},openAvailableWidgetsPanel:function(){var e;wp.customize.section.each((function(t){t.extended(wp.customize.Widgets.SidebarSection)&&t.expanded()&&(e=wp.customize.control("sidebars_widgets["+t.params.sidebarId+"]"))})),e&&setTimeout((function(){wp.customize.Widgets.availableWidgetsPanel.open(e),wp.customize.Widgets.availableWidgetsPanel.$search.val("HTML").trigger("keyup")}))},updateFields:function(){var e,t=this;t.fields.title.is(document.activeElement)||(e=t.syncContainer.find(".sync-input.title"),t.fields.title.val(e.val())),e=t.syncContainer.find(".sync-input.text"),t.fields.text.is(":visible")?t.fields.text.is(document.activeElement)||t.fields.text.val(e.val()):t.editor&&!t.editorFocused&&e.val()!==t.fields.text.val()&&t.editor.setContent(wp.editor.autop(e.val()))},initializeEditor:function(){var i,n,d,o,s=this,a=!1,l=!1;n=s.fields.text,i=n.attr("id"),o=n.val(),d=function(){s.editor.isDirty()&&(wp.customize&&wp.customize.state&&(wp.customize.state("processing").set(wp.customize.state("processing").get()+1),_.delay((function(){wp.customize.state("processing").set(wp.customize.state("processing").get()-1)}),300)),s.editor.isHidden()||s.editor.save()),l&&o!==n.val()&&(n.trigger("change"),l=!1,o=n.val())},s.syncContainer.closest(".widget").find("[name=savewidget]:first").on("click",(function(){d()})),function c(){var n,o,r;if(document.getElementById(i))if("undefined"!=typeof window.tinymce){if(tinymce.get(i)&&(a=tinymce.get(i).isHidden(),wp.editor.remove(i)),e(document).one("wp-before-tinymce-init.text-widget-init",(function(e,t){t.plugins&&(/\bwpview\b/.test(t.plugins)||(t.plugins+=",wpview"))})),wp.editor.initialize(i,{tinymce:{wpautop:!0},quicktags:!0,mediaButtons:!0}),r=function(t){t.show(),t.find(".close").focus(),wp.a11y.speak(t.find("h3, p").map((function(){return e(this).text()})).get().join("\n\n"))},!(n=window.tinymce.get(i)))throw new Error("Failed to initialize editor");o=function(){e(n.getWin()).on("unload",(function(){_.defer(c)})),a&&switchEditors.go(i,"html"),e("#"+i+"-html").on("click",(function(){s.pasteHtmlPointer.hide(),-1===t.dismissedPointers.indexOf("text_widget_custom_html")&&r(s.customHtmlWidgetPointer)})),e("#"+i+"-tmce").on("click",(function(){s.customHtmlWidgetPointer.hide()})),n.on("pastepreprocess",(function(e){var i=e.content;-1===t.dismissedPointers.indexOf("text_widget_paste_html")&&i&&/&lt;\w+.*?&gt;/.test(i)&&_.delay((function(){r(s.pasteHtmlPointer)}),250)}))},n.initialized?o():n.on("init",o),s.editorFocused=!1,n.on("focus",(function(){s.editorFocused=!0})),n.on("paste",(function(){n.setDirty(!0),d()})),n.on("NodeChange",(function(){l=!0})),n.on("NodeChange",_.debounce(d,1e3)),n.on("blur hide",(function(){s.editorFocused=!1,d()})),s.editor=n}else wp.editor.initialize(i,{quicktags:!0,mediaButtons:!0})}()}}),t.widgetControls={},t.handleWidgetAdded=function(i,n){var d,o,s,a,l,c,r;o=(d=n.find("> .widget-inside > .form, > .widget-inside > form")).find("> .id_base").val(),-1!==t.idBases.indexOf(o)&&(a=d.find(".widget-id").val(),t.widgetControls[a]||d.find(".visual").val()&&(c=e("<div></div>"),(r=n.find(".widget-content:first")).before(c),s=new t.TextWidgetControl({el:c,syncContainer:r}),t.widgetControls[a]=s,(l=function(){n.hasClass("open")?s.initializeEditor():setTimeout(l,50)})()))},t.setupAccessibleMode=function(){var i,n,d,o;0!==(i=e(".editwidget > form")).length&&(n=i.find("> .widget-control-actions > .id_base").val(),-1!==t.idBases.indexOf(n)&&i.find(".visual").val()&&(d=e("<div></div>"),(o=i.find("> .widget-inside")).before(d),new t.TextWidgetControl({el:d,syncContainer:o}).initializeEditor()))},t.handleWidgetUpdated=function(e,i){var n,d,o,s;s=(n=i.find("> .widget-inside > .form, > .widget-inside > form")).find("> .id_base").val(),-1!==t.idBases.indexOf(s)&&(d=n.find("> .widget-id").val(),(o=t.widgetControls[d])&&o.updateFields())},t.init=function(){var i=e(document);i.on("widget-added",t.handleWidgetAdded),i.on("widget-synced widget-updated",t.handleWidgetUpdated),e((function(){"widgets"===window.pagenow&&(e(".widgets-holder-wrap:not(#available-widgets)").find("div.widget").one("click.toggle-widget-expanded",(function(){var i=e(this);t.handleWidgetAdded(new jQuery.Event("widget-added"),i)})),e(window).on("load",(function(){t.setupAccessibleMode()})))}))},t}(jQuery);