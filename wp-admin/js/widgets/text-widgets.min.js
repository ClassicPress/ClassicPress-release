wp.textWidgets=function(e){"use strict";var t={dismissedPointers:[],idBases:["text"]};return t.TextWidgetControl=Backbone.View.extend({events:{},initialize:function(e){var t=this;if(!e.el)throw new Error("Missing options.el");if(!e.syncContainer)throw new Error("Missing options.syncContainer");Backbone.View.prototype.initialize.call(t,e),t.syncContainer=e.syncContainer,t.el.classList.add("text-widget-fields"),t.$el.html(wp.template("widget-text-control-fields")),t.customHtmlWidgetPointer=t.$el.find(".wp-pointer.custom-html-widget-pointer"),t.customHtmlWidgetPointer.length&&t.customHtmlWidgetPointer[0].querySelector(".close").addEventListener("click",(function(e){e.preventDefault(),t.customHtmlWidgetPointer[0].style.display="none",document.getElementById(t.fields.text.id+"-html").focus(),t.dismissPointers(["text_widget_custom_html"])})),t.pasteHtmlPointer=t.$el.find(".wp-pointer.paste-html-pointer"),t.pasteHtmlPointer.length&&t.pasteHtmlPointer[0].querySelector(".close").addEventListener("click",(function(e){e.preventDefault(),t.pasteHtmlPointer[0].style.display="none",t.editor.focus(),t.dismissPointers(["text_widget_custom_html","text_widget_paste_html"])})),t.fields={title:t.el.querySelector(".title"),text:t.el.querySelector(".text")},_.each(t.fields,(function(e,i){var n=t.syncContainer.closest(".widget").id,o=t.syncContainer.querySelector("."+i+".sync-input");function d(){o.value!==e.value&&(o.value=e.value,o.closest("li").classList.add("widget-dirty"),o.closest(".widget").dispatchEvent(new Event("change")))}document.addEventListener("widget-updated",(function(e){e.detail.widget.id===n&&(o=e.detail.widget.querySelector("."+i+".sync-input"))})),e.addEventListener("input",d),e.addEventListener("change",d),e.value=t.syncContainer.querySelector("."+i+".sync-input").value}))},dismissPointers:function(e){_.each(e,(function(e){wp.ajax.post("dismiss-wp-pointer",{pointer:e}),t.dismissedPointers.push(e)}))},openAvailableWidgetsPanel:function(){var e;wp.customize.section.each((function(t){t.extended(wp.customize.Widgets.SidebarSection)&&t.expanded()&&(e=wp.customize.control("sidebars_widgets["+t.params.sidebarId+"]"))})),e&&setTimeout((function(){wp.customize.Widgets.availableWidgetsPanel.open(e),wp.customize.Widgets.availableWidgetsPanel.$search.val("HTML").trigger("keyup")}))},updateFields:function(){var e,t,i=this;i.fields.title!==document.activeElement&&(e=i.syncContainer.querySelector(".title.sync-input"),i.fields.title.value=e.value),e=i.syncContainer.querySelector(".text.sync-input"),(t=i.fields.text).offsetWidth||t.offsetHeight||t.getClientRects().length?i.fields.text!==document.activeElement&&(i.fields.text.value=e.value):i.editor&&!i.editorFocused&&e.value!==i.fields.text.value&&i.editor.setContent(wp.oldEditor.autop(e.value))},initializeEditor:function(){var i,n,o,d,s=this,l=!1,c=!1;n=s.fields.text,i=n.id,d=n.value,o=function(){s.editor.isDirty()&&(wp.customize&&wp.customize.state&&(wp.customize.state("processing").set(wp.customize.state("processing").get()+1),_.delay((function(){wp.customize.state("processing").set(wp.customize.state("processing").get()-1)}),300)),s.editor.isHidden()||s.editor.save()),c&&d!==n.value&&(n.dispatchEvent(new Event("change")),c=!1,d=n.value)},s.syncContainer.closest(".widget").querySelector("[name=savewidget]").addEventListener("click",(function(){o()})),function r(){var n,d,a;if(document.getElementById(i))if("undefined"!=typeof window.tinymce){if(tinymce.get(i)&&(l=tinymce.get(i).isHidden(),wp.oldEditor.remove(i)),e(document).one("wp-before-tinymce-init.text-widget-init",(function(e,t){t.plugins&&(/\bwpview\b/.test(t.plugins)||(t.plugins+=",wpview"))})),wp.oldEditor.initialize(i,{tinymce:{wpautop:!0},quicktags:!0,mediaButtons:!0}),a=function(t){t.show(),t.find(".close").trigger("focus"),wp.a11y.speak(t.find("h3, p").map((function(){return e(this).text()})).get().join("\n\n"))},!(n=window.tinymce.get(i)))throw new Error("Failed to initialize editor");d=function(){e(n.getWin()).on("pagehide",(function(){_.defer(r)})),l&&switchEditors.go(i,"html"),e("#"+i+"-html").on("click",(function(){s.pasteHtmlPointer.hide(),-1===t.dismissedPointers.indexOf("text_widget_custom_html")&&a(s.customHtmlWidgetPointer)})),e("#"+i+"-tmce").on("click",(function(){s.customHtmlWidgetPointer.hide()})),n.on("pastepreprocess",(function(e){var i=e.content;-1===t.dismissedPointers.indexOf("text_widget_paste_html")&&i&&/&lt;\w+.*?&gt;/.test(i)&&_.delay((function(){a(s.pasteHtmlPointer)}),250)}))},n.initialized?d():n.on("init",d),s.editorFocused=!1,n.on("focus",(function(){s.editorFocused=!0})),n.on("paste",(function(){n.setDirty(!0),o()})),n.on("NodeChange",(function(){c=!0})),n.on("NodeChange",_.debounce(o,1e3)),n.on("blur hide",(function(){s.editorFocused=!1,o()})),s.editor=n}else wp.oldEditor.initialize(i,{quicktags:!0,mediaButtons:!0})}()}}),t.widgetControls={},t.handleWidgetAdded=function(e){var i,n,o,d,s,l=e.detail.widget;i=l.querySelector(".id_base").value,-1!==t.idBases.indexOf(i)&&(o=l.querySelector(".widget-id").value,t.widgetControls[o]||l.querySelector(".visual")&&(d=document.createElement("div"),(s=l.querySelector(".widget-content")).before(d),n=new t.TextWidgetControl({el:d,syncContainer:s}),t.widgetControls[o]=n,function c(){l.querySelector("details").hasAttribute("open")?n.initializeEditor():setTimeout(c,200)}()))},t.setupAccessibleMode=function(){var e,i,n,o;null!=(e=document.querySelector(".editwidget > form"))&&(i=e.querySelector(".id_base").value,-1!==t.idBases.indexOf(i)&&e.querySelector(".visual").value&&(n=document.createElement("div"),(o=e.querySelector(".widget-inside")).before(n),new t.TextWidgetControl({el:n,syncContainer:o}).initializeEditor()))},t.handleWidgetUpdated=function(e){var i,n,o,d=e.detail.widget;i=d.querySelector(".id_base").value,-1!==t.idBases.indexOf(i)&&(n=d.querySelector(".widget-id").value,(o=t.widgetControls[n])&&o.updateFields())},t.init=function(){document.addEventListener("widget-added",t.handleWidgetAdded),document.addEventListener("widget-synced",t.handleWidgetUpdated),document.addEventListener("widget-updated",t.handleWidgetUpdated),e((function(){var e=[];"widgets"===window.pagenow&&(document.querySelectorAll(".widgets-holder-wrap:not(#available-widgets)").forEach((function(t){t.querySelectorAll("li.widget").forEach((function(t){e.push(t)}))})),e.forEach((function(e){e.querySelector("details").addEventListener("toggle",(function(){document.dispatchEvent(new CustomEvent("widget-added",{detail:{widget:e}}))}),{once:!0})})),t.setupAccessibleMode())}))},t}(jQuery);