wp.textWidgets=function(e){"use strict";var t={dismissedPointers:[],idBases:["text"]};return t.TextWidgetControl=Backbone.View.extend({events:{},initialize:function(t){var i=this;if(!t.el)throw new Error("Missing options.el");if(!t.syncContainer)throw new Error("Missing options.syncContainer");Backbone.View.prototype.initialize.call(i,t),i.syncContainer=t.syncContainer,i.$el.addClass("text-widget-fields"),i.$el.html(wp.template("widget-text-control-fields")),i.customHtmlWidgetPointer=i.$el.find(".wp-pointer.custom-html-widget-pointer"),i.customHtmlWidgetPointer.length&&(i.customHtmlWidgetPointer.find(".close").on("click",(function(t){t.preventDefault(),i.customHtmlWidgetPointer.hide(),e("#"+i.fields.text.attr("id")+"-html").trigger("focus"),i.dismissPointers(["text_widget_custom_html"])})),i.customHtmlWidgetPointer.find(".add-widget").on("click",(function(e){e.preventDefault(),i.customHtmlWidgetPointer.hide(),i.openAvailableWidgetsPanel()}))),i.pasteHtmlPointer=i.$el.find(".wp-pointer.paste-html-pointer"),i.pasteHtmlPointer.length&&i.pasteHtmlPointer.find(".close").on("click",(function(e){e.preventDefault(),i.pasteHtmlPointer.hide(),i.editor.focus(),i.dismissPointers(["text_widget_custom_html","text_widget_paste_html"])})),i.fields={title:i.$el.find(".title"),text:i.$el.find(".text")},_.each(i.fields,(function(t,n){t.on("input change",(function(){var o=e(i.syncContainer).find(".sync-input."+n);o.val()!==t.val()&&(o.val(t.val()),o.trigger("change"))})),t.val(e(i.syncContainer).find(".sync-input."+n).val())}))},dismissPointers:function(e){_.each(e,(function(e){wp.ajax.post("dismiss-wp-pointer",{pointer:e}),t.dismissedPointers.push(e)}))},openAvailableWidgetsPanel:function(){var e;wp.customize.section.each((function(t){t.extended(wp.customize.Widgets.SidebarSection)&&t.expanded()&&(e=wp.customize.control("sidebars_widgets["+t.params.sidebarId+"]"))})),e&&setTimeout((function(){wp.customize.Widgets.availableWidgetsPanel.open(e),wp.customize.Widgets.availableWidgetsPanel.$search.val("HTML").trigger("keyup")}))},updateFields:function(){var e,t=this;t.fields.title.is(document.activeElement)||(e=t.syncContainer.find(".sync-input.title"),t.fields.title.val(e.val())),e=t.syncContainer.find(".sync-input.text"),t.fields.text.is(":visible")&&(t.fields.text.is(document.activeElement)||t.fields.text.val(e.val()))},initializeEditor:function(){var i,n,o,d,s=this,l=!1,a=!1;n=s.fields.text,i=n.attr("id"),d=n.val(),o=function(){s.editor.isDirty()&&(wp.customize&&wp.customize.state&&(wp.customize.state("processing").set(wp.customize.state("processing").get()+1),_.delay((function(){wp.customize.state("processing").set(wp.customize.state("processing").get()-1)}),300)),s.editor.isHidden()||s.editor.save()),a&&d!==n.val()&&(n.trigger("change"),a=!1,d=n.val())},s.syncContainer.closest(".widget").querySelector("[name=savewidget]").addEventListener("click",(function(){o()})),function c(){var n,d,r;if(document.getElementById(i))if("undefined"!=typeof window.tinymce){if(tinymce.get(i)&&(l=tinymce.get(i).isHidden(),wp.oldEditor.remove(i)),e(document).one("wp-before-tinymce-init.text-widget-init",(function(e,t){t.plugins&&(/\bwpview\b/.test(t.plugins)||(t.plugins+=",wpview"))})),wp.oldEditor.initialize(i,{tinymce:{wpautop:!0},quicktags:!0,mediaButtons:!0}),r=function(t){t.show(),t.find(".close").trigger("focus"),wp.a11y.speak(t.find("h3, p").map((function(){return e(this).text()})).get().join("\n\n"))},!(n=window.tinymce.get(i)))throw new Error("Failed to initialize editor");d=function(){e(n.getWin()).on("unload",(function(){_.defer(c)})),l&&switchEditors.go(i,"html"),e("#"+i+"-html").on("click",(function(){s.pasteHtmlPointer.hide(),-1===t.dismissedPointers.indexOf("text_widget_custom_html")&&r(s.customHtmlWidgetPointer)})),e("#"+i+"-tmce").on("click",(function(){s.customHtmlWidgetPointer.hide()})),n.on("pastepreprocess",(function(e){var i=e.content;-1===t.dismissedPointers.indexOf("text_widget_paste_html")&&i&&/&lt;\w+.*?&gt;/.test(i)&&_.delay((function(){r(s.pasteHtmlPointer)}),250)}))},n.initialized?d():n.on("init",d),s.editorFocused=!1,n.on("focus",(function(){s.editorFocused=!0})),n.on("paste",(function(){n.setDirty(!0),o()})),n.on("NodeChange",(function(){a=!0})),n.on("NodeChange",_.debounce(o,1e3)),n.on("blur hide",(function(){s.editorFocused=!1,o()})),s.editor=n}else wp.oldEditor.initialize(i,{quicktags:!0,mediaButtons:!0})}()}}),t.widgetControls={},t.handleWidgetAdded=function(e,i){var n,o,d,s,l,a;i.find("> .widget-inside > .form, > .widget-inside > form"),i instanceof jQuery&&(i=i[0]),n=i.querySelector(".id_base").value,-1!==t.idBases.indexOf(n)&&(d=i.querySelector(".widget-id").value,t.widgetControls[d]||i.querySelector(".visual").value&&(l=document.createElement("div"),(a=i.querySelector(".widget-content")).before(l),o=new t.TextWidgetControl({el:l,syncContainer:a}),t.widgetControls[d]=o,(s=function(){i.querySelector("details").hasAttribute("open")?o.initializeEditor():setTimeout(s,200)})()))},t.setupAccessibleMode=function(){var i,n,o,d;0!==(i=e(".editwidget > form")).length&&(n=undefined.find(".id_base").val(),-1!==t.idBases.indexOf(n)&&(o=e("<div></div>"),(d=i.find("> .widget-inside")).before(o),new t.TextWidgetControl({el:o,syncContainer:d}).initializeEditor()))},t.handleWidgetUpdated=function(e,i){var n,o,d,s;n=i.find("> .widget-inside > .form, > .widget-inside > form"),s=i.find(".id_base").val(),-1!==t.idBases.indexOf(s)&&(o=n.find(".widget-id").val(),(d=t.widgetControls[o])&&d.updateFields())},t.init=function(){var i=e(document);i.on("widget-added",t.handleWidgetAdded),i.on("widget-synced widget-updated",t.handleWidgetUpdated),e((function(){"widgets"===window.pagenow&&(e(".widgets-holder-wrap:not(#available-widgets)").find("li.widget").one("click.toggle-widget-expanded",(function(){var i=e(this);t.handleWidgetAdded(new jQuery.Event("widget-added"),i)})),t.setupAccessibleMode())}))},t}(jQuery);