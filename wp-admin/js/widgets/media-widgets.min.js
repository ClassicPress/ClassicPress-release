wp.mediaWidgets=function(e){"use strict";var t={controlConstructors:{},modelConstructors:{}};return t.PersistentDisplaySettingsLibrary=wp.media.controller.Library.extend({initialize:function(e){_.bindAll(this,"handleDisplaySettingChange"),wp.media.controller.Library.prototype.initialize.call(this,e)},handleDisplaySettingChange:function(e){this.get("selectedDisplaySettings").set(e.attributes)},display:function(e){var t,i=this.get("selectedDisplaySettings");return(t=wp.media.controller.Library.prototype.display.call(this,e)).off("change",this.handleDisplaySettingChange),t.set(i.attributes),"custom"===i.get("link_type")&&(t.linkUrl=i.get("link_url")),t.on("change",this.handleDisplaySettingChange),t}}),t.MediaEmbedView=wp.media.view.Embed.extend({initialize:function(e){var t,i=this;wp.media.view.Embed.prototype.initialize.call(i,e),"image"!==i.controller.options.mimeType&&(t=i.controller.states.get("embed")).off("scan",t.scanImage,t)},refresh:function(){var t;t="image"===this.controller.options.mimeType?wp.media.view.EmbedImage:wp.media.view.EmbedLink.extend({setAddToWidgetButtonDisabled:function(e){this.views.parent.views.parent.views.get(".media-frame-toolbar")[0].$el.find(".media-button-select").prop("disabled",e)},setErrorNotice:function(t){var i;i=this.views.parent.$el.find("> .notice:first-child"),t?(i.length||((i=e('<div class="media-widget-embed-notice notice notice-error notice-alt"></div>')).hide(),this.views.parent.$el.prepend(i)),i.empty(),i.append(e("<p>",{html:t})),i.slideDown("fast")):i.length&&i.slideUp("fast")},updateoEmbed:function(){var e,t=this;if(!(e=t.model.get("url")))return t.setErrorNotice(""),void t.setAddToWidgetButtonDisabled(!0);e.match(/^(http|https):\/\/.+\//)||(t.controller.$el.find("#embed-url-field").addClass("invalid"),t.setAddToWidgetButtonDisabled(!0)),wp.media.view.EmbedLink.prototype.updateoEmbed.call(t)},fetch:function(){var e,t,i,n,o,d,r=this;if(o=r.model.get("url"),r.dfd&&"pending"===r.dfd.state()&&r.dfd.abort(),e=function(e){r.renderoEmbed({data:{body:e}}),r.controller.$el.find("#embed-url-field").removeClass("invalid"),r.setErrorNotice(""),r.setAddToWidgetButtonDisabled(!1)},(n=document.createElement("a")).href=o,t=n.pathname.toLowerCase().match(/\.(\w+)$/))return i=t[1],void(wp.media.view.settings.embedMimes[i]?0!==wp.media.view.settings.embedMimes[i].indexOf(r.controller.options.mimeType)?r.renderFail():e("\x3c!--success--\x3e"):r.renderFail());(d=/https?:\/\/www\.youtube\.com\/embed\/([^/]+)/.exec(o))&&(o="https://www.youtube.com/watch?v="+d[1],r.model.attributes.url=o),r.dfd=wp.apiRequest({url:wp.media.view.settings.oEmbedProxyUrl,data:{url:o,maxwidth:r.model.get("width"),maxheight:r.model.get("height"),discover:!1},type:"GET",dataType:"json",context:r}),r.dfd.done((function(t){r.controller.options.mimeType===t.type?e(t.html):r.renderFail()})),r.dfd.fail(_.bind(r.renderFail,r))},renderFail:function(){var e=this;e.controller.$el.find("#embed-url-field").addClass("invalid"),e.setErrorNotice(e.controller.options.invalidEmbedTypeError||"ERROR"),e.setAddToWidgetButtonDisabled(!0)}}),this.settings(new t({controller:this.controller,model:this.model.props,priority:40}))}}),t.MediaFrameSelect=wp.media.view.MediaFrame.Post.extend({createStates:function(){var e=this.options.mimeType,i=[];_.each(wp.media.view.settings.embedMimes,(function(t){0===t.indexOf(e)&&i.push(t)})),i.length>0&&(e=i),this.states.add([new t.PersistentDisplaySettingsLibrary({id:"insert",title:this.options.title,selection:this.options.selection,priority:20,toolbar:"main-insert",filterable:"dates",library:wp.media.query({type:e}),multiple:!1,editable:!0,selectedDisplaySettings:this.options.selectedDisplaySettings,displaySettings:!!_.isUndefined(this.options.showDisplaySettings)||this.options.showDisplaySettings,displayUserSettings:!1}),new wp.media.controller.EditImage({model:this.options.editImage}),new wp.media.controller.Embed({metadata:this.options.metadata,type:"image"===this.options.mimeType?"image":"link",invalidEmbedTypeError:this.options.invalidEmbedTypeError})])},mainInsertToolbar:function(e){var t=this;e.set("insert",{style:"primary",priority:80,text:t.options.text,requires:{selection:!0},click:function(){var e=t.state(),i=e.get("selection");t.close(),e.trigger("insert",i).reset()}})},mainEmbedToolbar:function(e){e.view=new wp.media.view.Toolbar.Embed({controller:this,text:this.options.text,event:"insert"})},embedContent:function(){var e=new t.MediaEmbedView({controller:this,model:this.state()}).render();this.content.set(e)}}),t.MediaWidgetControl=Backbone.View.extend({l10n:{add_to_widget:"{{add_to_widget}}",add_media:"{{add_media}}"},id_base:"",mime_type:"",events:{"click .notice-missing-attachment a":"handleMediaLibraryLinkClick","click .select-media":"selectMedia","click .placeholder":"selectMedia","click .edit-media":"editMedia"},showDisplaySettings:!0,initialize:function(i){var n=this;if(Backbone.View.prototype.initialize.call(n,i),!(n.model instanceof t.MediaWidgetModel))throw new Error("Missing options.model");if(!i.el)throw new Error("Missing options.el");if(!i.syncContainer)throw new Error("Missing options.syncContainer");if(n.syncContainer=i.syncContainer,n.$el.addClass("media-widget-control"),_.bindAll(n,"syncModelToInputs","render","updateSelectedAttachment","renderPreview"),!n.id_base&&(_.find(t.controlConstructors,(function(e,t){return n instanceof e&&(n.id_base=t,!0)})),!n.id_base))throw new Error("Missing id_base.");n.previewTemplateProps=new Backbone.Model(n.mapModelToPreviewTemplateProps()),n.selectedAttachment=new wp.media.model.Attachment,n.renderPreview=_.debounce(n.renderPreview),n.listenTo(n.previewTemplateProps,"change",n.renderPreview),n.model.on("change:attachment_id",n.updateSelectedAttachment),n.model.on("change:url",n.updateSelectedAttachment),n.updateSelectedAttachment(),n.listenTo(n.model,"change",n.syncModelToInputs),n.listenTo(n.model,"change",n.syncModelToPreviewProps),n.listenTo(n.model,"change",n.render),n.$el.on("input change",".title",(function(){n.model.set({title:e(this).val().trim()})})),n.$el.on("input change",".link",(function(){var t=e(this).val().trim(),i="custom";n.selectedAttachment.get("linkUrl")===t||n.selectedAttachment.get("link")===t?i="post":n.selectedAttachment.get("url")===t&&(i="file"),n.model.set({link_url:t,link_type:i}),n.displaySettings.set({link:i,linkUrl:t})})),n.displaySettings=new Backbone.Model(_.pick(n.mapModelToMediaFrameProps(_.extend(n.model.defaults(),n.model.toJSON())),_.keys(wp.media.view.settings.defaultProps)))},updateSelectedAttachment:function(){var e,t=this;0===t.model.get("attachment_id")?(t.selectedAttachment.clear(),t.model.set("error",!1)):t.model.get("attachment_id")!==t.selectedAttachment.get("id")&&(e=new wp.media.model.Attachment({id:t.model.get("attachment_id")})).fetch().done((function(){t.model.set("error",!1),t.selectedAttachment.set(e.toJSON())})).fail((function(){t.model.set("error","missing_attachment")}))},syncModelToPreviewProps:function(){this.previewTemplateProps.set(this.mapModelToPreviewTemplateProps())},syncModelToInputs:function(){var e=this;e.syncContainer.querySelectorAll(".media-widget-instance-property").forEach((function(t){var i,n=t.dataset.property,o=e.model.get(n);_.isUndefined(o)||(o="array"===e.model.schema[n].type&&_.isArray(o)?o.join(","):"boolean"===e.model.schema[n].type?o?"1":"":String(o),t.value!==o&&(t.value=o,i=t.id.replace("widget-","").replace("-"+n,""),document.querySelector(".widget[id$="+i+"]").dispatchEvent(new Event("change"))))}))},template:function(){var t=this;if(!e("#tmpl-widget-media-"+t.id_base+"-control").length)throw new Error("Missing widget control template for "+t.id_base);return wp.template("widget-media-"+t.id_base+"-control")},render:function(){var e,t=this;t.templateRendered||(t.$el.html(t.template()(t.model.toJSON())),t.renderPreview(),t.templateRendered=!0),(e=t.$el.find(".title")).is(document.activeElement)||e.val(t.model.get("title")),t.$el.toggleClass("selected",t.isSelected())},renderPreview:function(){throw new Error("renderPreview must be implemented")},isSelected:function(){var e=this;return!e.model.get("error")&&Boolean(e.model.get("attachment_id")||e.model.get("url"))},handleMediaLibraryLinkClick:function(e){e.preventDefault(),this.selectMedia()},selectMedia:function(){var i,n,o,d,r=this,a=[];r.isSelected()&&0!==r.model.get("attachment_id")&&a.push(r.selectedAttachment),i=new wp.media.model.Selection(a,{multiple:!1}),(d=r.mapModelToMediaFrameProps(r.model.toJSON())).size&&r.displaySettings.set("size",d.size),n=new t.MediaFrameSelect({title:r.l10n.add_media,frame:"post",text:r.l10n.add_to_widget,selection:i,mimeType:r.mime_type,selectedDisplaySettings:r.displaySettings,showDisplaySettings:r.showDisplaySettings,metadata:d,state:r.isSelected()&&0===r.model.get("attachment_id")?"embed":"insert",invalidEmbedTypeError:r.l10n.unsupported_file_type}),wp.media.frame=n,n.on("insert",(function(){var e={},t=n.state();"embed"===t.get("id")?_.extend(e,{id:0},t.props.toJSON()):_.extend(e,t.get("selection").first().toJSON()),r.selectedAttachment.set(e),r.model.set("error",!1),r.model.set(r.getModelPropsFromMediaFrame(n))})),o=wp.media.model.Attachment.prototype.sync,wp.media.model.Attachment.prototype.sync=function(t){return"delete"===t?o.apply(this,arguments):e.Deferred().rejectWith(this).promise()},n.on("close",(function(){wp.media.model.Attachment.prototype.sync=o})),n.$el.addClass("media-widget"),n.open(),i&&i.on("destroy",(function(e){r.model.get("attachment_id")===e.get("id")&&r.model.set({attachment_id:0,url:""})})),n.$el.find(".media-frame-menu .media-menu-item.active").focus()},getModelPropsFromMediaFrame:function(e){var t,i,n,o=this;if("insert"===(t=e.state()).get("id"))(i=t.get("selection").first().toJSON()).postUrl=i.link,o.showDisplaySettings&&_.extend(i,e.content.get(".attachments-browser").sidebar.get("display").model.toJSON()),i.sizes&&i.size&&i.sizes[i.size]&&(i.url=i.sizes[i.size].url);else{if("embed"!==t.get("id"))throw new Error("Unexpected state: "+t.get("id"));i=_.extend(t.props.toJSON(),{attachment_id:0},o.model.getEmbedResetProps())}return i.id&&(i.attachment_id=i.id),n=o.mapMediaToModelProps(i),_.each(wp.media.view.settings.embedExts,(function(e){e in o.model.schema&&n.url!==n[e]&&(n[e]="")})),n},mapMediaToModelProps:function(e){var t,i=this,n={},o={};return _.each(i.model.schema,(function(e,t){"title"!==t&&(n[e.media_prop||t]=t)})),_.each(e,(function(e,t){var d=n[t]||t;i.model.schema[d]&&(o[d]=e)})),"custom"===e.size&&(o.width=e.customWidth,o.height=e.customHeight),"post"===e.link?o.link_url=e.postUrl||e.linkUrl:"file"===e.link&&(o.link_url=e.url),!e.attachment_id&&e.id&&(o.attachment_id=e.id),e.url&&(t=e.url.replace(/#.*$/,"").replace(/\?.*$/,"").split(".").pop().toLowerCase())in i.model.schema&&(o[t]=e.url),_.omit(o,"title")},mapModelToMediaFrameProps:function(e){var t=this,i={};return _.each(e,(function(e,n){var o=t.model.schema[n]||{};i[o.media_prop||n]=e})),i.attachment_id=i.id,"custom"===i.size&&(i.customWidth=t.model.get("width"),i.customHeight=t.model.get("height")),i},mapModelToPreviewTemplateProps:function(){var e=this,t={};return _.each(e.model.schema,(function(i,n){i.hasOwnProperty("should_preview_update")&&!i.should_preview_update||(t[n]=e.model.get(n))})),t.error=e.model.get("error"),t},editMedia:function(){throw new Error("editMedia not implemented")}}),t.MediaWidgetModel=Backbone.Model.extend({idAttribute:"widget_id",schema:{title:{type:"string","default":""},attachment_id:{type:"integer","default":0},url:{type:"string","default":""}},defaults:function(){var e={};return _.each(this.schema,(function(t,i){e[i]=t["default"]})),e},set:function(e,t,i){var n,o,d,r=this;return null===e?r:("object"==typeof e?(n=e,o=t):((n={})[e]=t,o=i),d={},_.each(n,(function(e,t){var i;r.schema[t]?"array"===(i=r.schema[t].type)?(d[t]=e,_.isArray(d[t])||(d[t]=d[t].split(/,/)),r.schema[t].items&&"integer"===r.schema[t].items.type&&(d[t]=_.filter(_.map(d[t],(function(e){return parseInt(e,10)}),(function(e){return"number"==typeof e}))))):d[t]="integer"===i?parseInt(e,10):"boolean"===i?!(!e||"0"===e||"false"===e):e:d[t]=e})),Backbone.Model.prototype.set.call(this,d,o))},getEmbedResetProps:function(){return{id:0}}}),t.modelCollection=new(Backbone.Collection.extend({model:t.MediaWidgetModel})),t.widgetControls={},t.handleWidgetAdded=function(e){var i,n,o,d,r,a,l,s,c,m,p=e.detail.widget;o=p.querySelector(".id_base").value,c=p.querySelector(".widget-id").value,t.widgetControls[c]||(d=t.controlConstructors[o])&&(r=t.modelConstructors[o]||t.MediaWidgetModel,i=document.createElement("div"),(n=p.querySelector(".widget-content")).before(i),a={},n.querySelectorAll(".media-widget-instance-property").forEach((function(e){a[e.dataset.property]=e.value})),a.widget_id=c,s=new r(a),l=new d({el:i,syncContainer:n,model:s}),(m=function(){p.querySelector("details").hasAttribute("open")?l.render():setTimeout(m,50)})(),t.modelCollection.add([s]),t.widgetControls[s.get("widget_id")]=l)},t.setupAccessibleMode=function(){var e,i,n,o,d,r,a,l,s;null!=(e=document.querySelector(".editwidget > form"))&&(n=e.querySelector(".id_base").value,(d=t.controlConstructors[n])&&(i=e.querySelector(".widget-control-actions .widget-id").value,r=t.modelConstructors[n]||t.MediaWidgetModel,l=document.createElement("div"),(s=e.querySelector(".widget-inside")).before(l),a={},s.querySelectorAll(".media-widget-instance-property").forEach((function(e){a[e.dataset.property]=e.value})),a.widget_id=i,o=new d({el:l,syncContainer:s,model:new r(a)}),t.modelCollection.add([o.model]),t.widgetControls[o.model.get("widget_id")]=o,o.render()))},t.handleWidgetUpdated=function(e){var i,n,o,d={},r=e.detail.widget;null==(i=r.querySelector(".widget-inside > .form"))&&(i=r.querySelector(".widget-inside > form")),n=r.querySelector(".widget-id").value,(o=t.widgetControls[n])&&(i.querySelector(".widget-content").querySelectorAll(".media-widget-instance-property").forEach((function(e){var t=e.dataset.property;d[t]=e.value})),o.stopListening(o.model,"change",o.syncModelToInputs),o.model.set(d),o.listenTo(o.model,"change",o.syncModelToInputs))},t.init=function(){document.addEventListener("widget-added",t.handleWidgetAdded),document.addEventListener("widget-synced",t.handleWidgetUpdated),document.addEventListener("widget-updated",t.handleWidgetUpdated),e((function(){var e=[];"widgets"===window.pagenow&&(document.querySelectorAll(".widgets-holder-wrap:not(#available-widgets)").forEach((function(t){t.querySelectorAll("li.widget").forEach((function(t){e.push(t)}))})),e.forEach((function(e){e.querySelector("details").addEventListener("toggle",(function(){document.dispatchEvent(new CustomEvent("widget-added",{detail:{widget:e}}))}),{once:!0})})),"complete"===document.readyState?t.setupAccessibleMode():window.onload=function(){t.setupAccessibleMode()})}))},t}(jQuery);