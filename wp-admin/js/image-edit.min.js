!function(i){var t=wp.i18n.__,e=window.imageEdit={iasapi:{},hold:{},postid:"",_view:!1,handleCropToolClick:function(t,a,o){var n=i("#image-preview-"+t),s=this.iasapi.getSelection();isNaN(s.x1)&&(this.setCropSelection(t,{x1:0,y1:0,x2:n.innerWidth(),y2:n.innerHeight(),width:n.innerWidth(),height:n.innerHeight()}),s=this.iasapi.getSelection()),0===s.x1&&0===s.y1&&0===s.x2&&0===s.y2?(this.iasapi.setSelection(0,0,n.innerWidth(),n.innerHeight(),!0),this.iasapi.setOptions({show:!0}),this.iasapi.update()):e.crop(t,a,o)},intval:function(i){return 0|i},setDisabled:function(i,t){t?i.removeClass("disabled").prop("disabled",!1):i.addClass("disabled").prop("disabled",!0)},init:function(t){var e=this,a=i("#image-editor-"+e.postid),o=e.intval(i("#imgedit-x-"+t).val()),n=e.intval(i("#imgedit-y-"+t).val());e.postid!==t&&a.length&&e.close(e.postid),e.hold.w=e.hold.ow=o,e.hold.h=e.hold.oh=n,e.hold.xy_ratio=o/n,e.hold.sizer=parseFloat(i("#imgedit-sizer-"+t).val()),e.postid=t,i("#imgedit-response-"+t).empty(),i("#imgedit-panel-"+t).on("keypress",'input[type="text"]',(function(t){var e=t.keyCode;if(36<e&&e<41&&i(this).trigger("blur"),13===e)return t.preventDefault(),t.stopPropagation(),!1})),i(document).on("image-editor-ui-ready",this.focusManager)},toggleEditor:function(t,e,a){var o=i("#imgedit-wait-"+t);e?o.fadeIn("fast"):o.fadeOut("fast",(function(){a&&i(document).trigger("image-editor-ui-ready")}))},toggleHelp:function(t){var e=i(t);return e.attr("aria-expanded","false"===e.attr("aria-expanded")?"true":"false").parents(".imgedit-group-top").toggleClass("imgedit-help-toggled").find(".imgedit-help").slideToggle("fast"),!1},getTarget:function(t){return i('input[name="imgedit-target-'+t+'"]:checked',"#imgedit-save-target-"+t).val()||"full"},scaleChanged:function(t,e,a){var o=i("#imgedit-scale-width-"+t),n=i("#imgedit-scale-height-"+t),s=i("#imgedit-scale-warn-"+t),r="",d="";!1!==this.validateNumeric(a)&&(e?(d=""!==o.val()?Math.round(o.val()/this.hold.xy_ratio):"",n.val(d)):(r=""!==n.val()?Math.round(n.val()*this.hold.xy_ratio):"",o.val(r)),d&&d>this.hold.oh||r&&r>this.hold.ow?s.css("visibility","visible"):s.css("visibility","hidden"))},getSelRatio:function(t){var e=this.hold.w,a=this.hold.h,o=this.intval(i("#imgedit-crop-width-"+t).val()),n=this.intval(i("#imgedit-crop-height-"+t).val());return o&&n?o+":"+n:e&&a?e+":"+a:"1:1"},filterHistory:function(t,e){var a,o,n,s,r=i("#imgedit-history-"+t).val(),d=[];if(""!==r){if(r=JSON.parse(r),(a=this.intval(i("#imgedit-undone-"+t).val()))>0)for(;a>0;)r.pop(),a--;if(e){if(!r.length)return this.hold.w=this.hold.ow,this.hold.h=this.hold.oh,"";(n=(n=r[r.length-1]).c||n.r||n.f||!1)&&(this.hold.w=n.fw,this.hold.h=n.fh)}for(o in r)(s=r[o]).hasOwnProperty("c")?d[o]={c:{x:s.c.x,y:s.c.y,w:s.c.w,h:s.c.h}}:s.hasOwnProperty("r")?d[o]={r:s.r.r}:s.hasOwnProperty("f")&&(d[o]={f:s.f.f});return JSON.stringify(d)}return""},refreshEditor:function(a,o,n){var s,r,d=this;d.toggleEditor(a,1),s={action:"imgedit-preview",_ajax_nonce:o,postid:a,history:d.filterHistory(a,1),rand:d.intval(1e6*Math.random())},r=i('<img id="image-preview-'+a+'" alt="" />').on("load",{history:s.history},(function(t){var o,s,d,l=i("#imgedit-crop-"+a),h=e;""!==t.data.history&&(d=JSON.parse(t.data.history))[d.length-1].hasOwnProperty("c")&&(h.setDisabled(i("#image-undo-"+a),!0),i("#image-undo-"+a).trigger("focus")),l.empty().append(r),o=Math.max(h.hold.w,h.hold.h),s=Math.max(i(r).width(),i(r).height()),h.hold.sizer=o>s?s/o:1,h.initCrop(a,r,l),null!=n&&n(),i("#imgedit-history-"+a).val()&&"0"===i("#imgedit-undone-"+a).val()?i("input.imgedit-submit-btn","#imgedit-panel-"+a).prop("disabled",!1):i("input.imgedit-submit-btn","#imgedit-panel-"+a).prop("disabled",!0),h.toggleEditor(a,0)})).on("error",(function(){var e=t("Could not load the preview image. Please reload the page and try again.");i("#imgedit-crop-"+a).empty().append('<div class="notice notice-error" tabindex="-1" role="alert"><p>'+e+"</p></div>"),d.toggleEditor(a,0,!0),wp.a11y.speak(e,"assertive")})).attr("src",ajaxurl+"?"+i.param(s))},action:function(t,e,a){var o,n,s,r,d,l=this;if(l.notsaved(t))return!1;if(o={action:"image-editor",_ajax_nonce:e,postid:t},"scale"===a){if(n=i("#imgedit-scale-width-"+t),s=i("#imgedit-scale-height-"+t),r=l.intval(n.val()),d=l.intval(s.val()),r<1)return n.trigger("focus"),!1;if(d<1)return s.trigger("focus"),!1;if(r===l.hold.ow||d===l.hold.oh)return!1;o["do"]="scale",o.fwidth=r,o.fheight=d}else{if("restore"!==a)return!1;o["do"]="restore"}l.toggleEditor(t,1),i.post(ajaxurl,o,(function(e){i("#image-editor-"+t).empty().append(e.data.html),l.toggleEditor(t,0,!0),l._view&&l._view.refresh()})).done((function(i){i&&i.data.message.msg?wp.a11y.speak(i.data.message.msg):i&&i.data.message.error&&wp.a11y.speak(i.data.message.error)}))},save:function(t,a){var o,n=this.getTarget(t),s=this.filterHistory(t,0),r=this;if(""===s)return!1;this.toggleEditor(t,1),o={action:"image-editor",_ajax_nonce:a,postid:t,history:s,target:n,context:i("#image-edit-context").length?i("#image-edit-context").val():null,"do":"save"},i.post(ajaxurl,o,(function(a){if(a.data.error)return i("#imgedit-response-"+t).html('<div class="notice notice-error" tabindex="-1" role="alert"><p>'+a.data.error+"</p></div>"),e.close(t),void wp.a11y.speak(a.data.error);a.data.fw&&a.data.fh&&i("#media-dims-"+t).html(a.data.fw+" &times; "+a.data.fh),a.data.thumbnail&&i(".thumbnail","#thumbnail-head-"+t).attr("src",""+a.data.thumbnail),a.data.msg&&(i("#imgedit-response-"+t).html('<div class="notice notice-success" tabindex="-1" role="alert"><p>'+a.data.msg+"</p></div>"),wp.a11y.speak(a.data.msg)),r._view?r._view.save():e.close(t)}))},open:function(a,o,n){this._view=n;var s,r=i("#image-editor-"+a),d=i("#media-head-"+a),l=i("#imgedit-open-btn-"+a),h=l.siblings(".spinner");if(!l.hasClass("button-activated"))return h.addClass("is-active"),s={action:"image-editor",_ajax_nonce:o,postid:a,"do":"open"},i.ajax({url:ajaxurl,type:"post",data:s,beforeSend:function(){l.addClass("button-activated")}}).done((function(o){var n;"-1"===o&&(n=t("Could not load the preview image."),r.html('<div class="notice notice-error" tabindex="-1" role="alert"><p>'+n+"</p></div>")),o.data&&o.data.html&&r.html(o.data.html),d.fadeOut("fast",(function(){r.fadeIn("fast",(function(){n&&i(document).trigger("image-editor-ui-ready")})),l.removeClass("button-activated"),h.removeClass("is-active")})),e.init(a)}))},imgLoaded:function(t){var e=i("#image-preview-"+t),a=i("#imgedit-crop-"+t);"undefined"==typeof this.hold.sizer&&this.init(t),this.initCrop(t,e,a),this.setCropSelection(t,{x1:0,y1:0,x2:0,y2:0,width:e.innerWidth(),height:e.innerHeight()}),this.toggleEditor(t,0,!0)},focusManager:function(){setTimeout((function(){var t=i('.notice[role="alert"]');t.length||(t=i(".imgedit-wrap").find(":tabbable:first")),t.trigger("focus")}),100)},initCrop:function(t,a,o){var n=this,s=i("#imgedit-sel-width-"+t),r=i("#imgedit-sel-height-"+t),d=i(a);d.data("imgAreaSelect")||(n.iasapi=d.imgAreaSelect({parent:o,instance:!0,handles:!0,keys:!0,minWidth:3,minHeight:3,onInit:function(e){i(e).next().css("position","absolute").nextAll(".imgareaselect-outer").css("position","absolute"),o.children().on("mousedown, touchstart",(function(i){var e,a,o=!1;i.shiftKey&&(e=n.iasapi.getSelection(),a=n.getSelRatio(t),o=e&&e.width&&e.height?e.width+":"+e.height:a),n.iasapi.setOptions({aspectRatio:o})}))},onSelectStart:function(){e.setDisabled(i("#imgedit-crop-sel-"+t),1)},onSelectEnd:function(i,a){e.setCropSelection(t,a)},onSelectChange:function(i,t){var a=e.hold.sizer;s.val(e.round(t.width/a)),r.val(e.round(t.height/a))}}))},setCropSelection:function(t,e){var a;if(!(e=e||0)||e.width<3&&e.height<3)return this.setDisabled(i(".imgedit-crop","#imgedit-panel-"+t),1),this.setDisabled(i("#imgedit-crop-sel-"+t),1),i("#imgedit-sel-width-"+t).val(""),i("#imgedit-sel-height-"+t).val(""),i("#imgedit-selection-"+t).val(""),!1;a={x:e.x1,y:e.y1,w:e.width,h:e.height},this.setDisabled(i(".imgedit-crop","#imgedit-panel-"+t),1),i("#imgedit-selection-"+t).val(JSON.stringify(a))},close:function(t,e){if((e=e||!1)&&this.notsaved(t))return!1;this.iasapi={},this.hold={},this._view?this._view.back():i("#image-editor-"+t).fadeOut("fast",(function(){i("#media-head-"+t).fadeIn("fast",(function(){i("#imgedit-open-btn-"+t).trigger("focus")})),i(this).empty()}))},notsaved:function(t){var e=i("#imgedit-history-"+t).val(),a=""!==e?JSON.parse(e):[];return this.intval(i("#imgedit-undone-"+t).val())<a.length&&!confirm(i("#imgedit-leaving-"+t).text())},addStep:function(t,e,a){for(var o=this,n=i("#imgedit-history-"+e),s=""!==n.val()?JSON.parse(n.val()):[],r=i("#imgedit-undone-"+e),d=o.intval(r.val());d>0;)s.pop(),d--;r.val(0),s.push(t),n.val(JSON.stringify(s)),o.refreshEditor(e,a,(function(){o.setDisabled(i("#image-undo-"+e),!0),o.setDisabled(i("#image-redo-"+e),!1)}))},rotate:function(t,e,a,o){if(i(o).hasClass("disabled"))return!1;this.addStep({r:{r:t,fw:this.hold.h,fh:this.hold.w}},e,a)},flip:function(t,e,a,o){if(i(o).hasClass("disabled"))return!1;this.addStep({f:{f:t,fw:this.hold.w,fh:this.hold.h}},e,a)},crop:function(t,e,a){var o=i("#imgedit-selection-"+t).val(),n=this.intval(i("#imgedit-sel-width-"+t).val()),s=this.intval(i("#imgedit-sel-height-"+t).val());if(i(a).hasClass("disabled")||""===o)return!1;(o=JSON.parse(o)).w>0&&o.h>0&&n>0&&s>0&&(o.fw=n,o.fh=s,this.addStep({c:o},t,e)),i("#imgedit-sel-width-"+t).val(""),i("#imgedit-sel-height-"+t).val("")},undo:function(t,e){var a=this,o=i("#image-undo-"+t),n=i("#imgedit-undone-"+t),s=a.intval(n.val())+1;o.hasClass("disabled")||(n.val(s),a.refreshEditor(t,e,(function(){var e=i("#imgedit-history-"+t),n=""!==e.val()?JSON.parse(e.val()):[];a.setDisabled(i("#image-redo-"+t),!0),a.setDisabled(o,s<n.length),n.length===s&&i("#image-redo-"+t).trigger("focus")})))},redo:function(t,e){var a=this,o=i("#image-redo-"+t),n=i("#imgedit-undone-"+t),s=a.intval(n.val())-1;o.hasClass("disabled")||(n.val(s),a.refreshEditor(t,e,(function(){a.setDisabled(i("#image-undo-"+t),!0),a.setDisabled(o,s>0),0===s&&i("#image-undo-"+t).trigger("focus")})))},setNumSelection:function(t,e){var a,o,n,s,r,d=i("#imgedit-sel-width-"+t),l=i("#imgedit-sel-height-"+t),h=this.intval(d.val()),g=this.intval(l.val()),c=i("#image-preview-"+t),p=c.height(),u=c.width(),v=this.hold.sizer,m=this.iasapi;if(!1!==this.validateNumeric(e))return h<1?(d.val(""),!1):g<1?(l.val(""),!1):void(h&&g&&(a=m.getSelection())&&(s=a.x1+Math.round(h*v),r=a.y1+Math.round(g*v),o=a.x1,n=a.y1,s>u&&(o=0,s=u,d.val(Math.round(s/v))),r>p&&(n=0,r=p,l.val(Math.round(r/v))),m.setSelection(o,n,s,r),m.update(),this.setCropSelection(t,m.getSelection())))},round:function(i){var t;return i=Math.round(i),this.hold.sizer>.6?i:"1"===(t=i.toString().slice(-1))?i-1:"9"===t?i+1:i},setRatioSelection:function(t,e,a){var o,n,s=this.intval(i("#imgedit-crop-width-"+t).val()),r=this.intval(i("#imgedit-crop-height-"+t).val()),d=i("#image-preview-"+t).height();!1!==this.validateNumeric(a)?s&&r&&(this.iasapi.setOptions({aspectRatio:s+":"+r}),(o=this.iasapi.getSelection(!0))&&((n=Math.ceil(o.y1+(o.x2-o.x1)/(s/r)))>d&&(n=d,e?i("#imgedit-crop-height-"+t).val(""):i("#imgedit-crop-width-"+t).val("")),this.iasapi.setSelection(o.x1,o.y1,o.x2,n),this.iasapi.update())):this.iasapi.setOptions({aspectRatio:null})},validateNumeric:function(t){if(!this.intval(i(t).val()))return i(t).val(""),!1}}}(jQuery);