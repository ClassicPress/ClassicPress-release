!function(t){var i=wp.i18n.__;var e=window.imageEdit={iasapi:{},hold:{},postid:"",_view:!1,handleCropToolClick:function(i,a,o){var n=t("#image-preview-"+i),r=this.iasapi.getSelection();isNaN(r.x1)&&(this.setCropSelection(i,{x1:0,y1:0,x2:n.innerWidth(),y2:n.innerHeight(),width:n.innerWidth(),height:n.innerHeight()}),r=this.iasapi.getSelection()),0===r.x1&&0===r.y1&&0===r.x2&&0===r.y2?(this.iasapi.setSelection(0,0,n.innerWidth(),n.innerHeight(),!0),this.iasapi.setOptions({show:!0}),this.iasapi.update()):e.crop(i,a,o)},intval:function(t){return 0|t},setDisabled:function(t,i){i?t.removeClass("disabled").prop("disabled",!1):t.addClass("disabled").prop("disabled",!0)},init:function(i){var e=this,a=t("#image-editor-"+e.postid);e.postid!==i&&a.length&&e.close(e.postid),e.hold.sizer=parseFloat(t("#imgedit-sizer-"+i).val()),e.postid=i,t("#imgedit-response-"+i).empty(),t("#imgedit-panel-"+i).on("keypress",'input[type="text"]',(function(i){var e=i.keyCode;if(36<e&&e<41&&t(this).trigger("blur"),13===e)return i.preventDefault(),i.stopPropagation(),!1})),t(document).on("image-editor-ui-ready",this.focusManager)},calculateImgSize:function(i){var e=this,a=e.intval(t("#imgedit-x-"+i).val()),o=e.intval(t("#imgedit-y-"+i).val());e.hold.w=e.hold.ow=a,e.hold.h=e.hold.oh=o,e.hold.xy_ratio=a/o,e.hold.sizer=parseFloat(t("#imgedit-sizer-"+i).val()),e.currentCropSelection=null},toggleEditor:function(i,e,a){var o=t("#imgedit-wait-"+i);e?o.fadeIn("fast"):o.fadeOut("fast",(function(){a&&t(document).trigger("image-editor-ui-ready")}))},toggleHelp:function(i){var e=t(i);return e.attr("aria-expanded","false"===e.attr("aria-expanded")?"true":"false").parents(".imgedit-group-top").toggleClass("imgedit-help-toggled").find(".imgedit-help").slideToggle("fast"),!1},getTarget:function(i){return t('input[name="imgedit-target-'+i+'"]:checked',"#imgedit-save-target-"+i).val()||"full"},scaleChanged:function(i,e,a){var o=t("#imgedit-scale-width-"+i),n=t("#imgedit-scale-height-"+i),r=t("#imgedit-scale-warn-"+i),s="",d="";!1!==this.validateNumeric(a)&&(e?(d=""!==o.val()?Math.round(o.val()/this.hold.xy_ratio):"",n.val(d)):(s=""!==n.val()?Math.round(n.val()*this.hold.xy_ratio):"",o.val(s)),d&&d>this.hold.oh||s&&s>this.hold.ow?r.css("visibility","visible"):r.css("visibility","hidden"))},getSelRatio:function(i){var e=this.hold.w,a=this.hold.h,o=this.intval(t("#imgedit-crop-width-"+i).val()),n=this.intval(t("#imgedit-crop-height-"+i).val());return o&&n?o+":"+n:e&&a?e+":"+a:"1:1"},filterHistory:function(i,e){var a,o,n,r,s=t("#imgedit-history-"+i).val(),d=[];if(""!==s){if(s=JSON.parse(s),(a=this.intval(t("#imgedit-undone-"+i).val()))>0)for(;a>0;)s.pop(),a--;if(e){if(!s.length)return this.hold.w=this.hold.ow,this.hold.h=this.hold.oh,"";(n=(n=s[s.length-1]).c||n.r||n.f||!1)&&(this.hold.w=n.fw,this.hold.h=n.fh)}for(o in s)(r=s[o]).hasOwnProperty("c")?d[o]={c:{x:r.c.x,y:r.c.y,w:r.c.w,h:r.c.h,r:r.c.r}}:r.hasOwnProperty("r")?d[o]={r:r.r.r}:r.hasOwnProperty("f")&&(d[o]={f:r.f.f});return JSON.stringify(d)}return""},refreshEditor:function(a,o,n){var r,s,d=this;d.toggleEditor(a,1),r={action:"imgedit-preview",_ajax_nonce:o,postid:a,history:d.filterHistory(a,1),rand:d.intval(1e6*Math.random())},s=t('<img id="image-preview-'+a+'" alt="" />').on("load",{history:r.history},(function(i){var o,r,d,l=t("#imgedit-crop-"+a),h=e;""!==i.data.history&&(d=JSON.parse(i.data.history))[d.length-1].hasOwnProperty("c")&&(h.setDisabled(t("#image-undo-"+a),!0),t("#image-undo-"+a).trigger("focus")),l.empty().append(s),o=Math.max(h.hold.w,h.hold.h),r=Math.max(t(s).width(),t(s).height()),h.hold.sizer=o>r?r/o:1,h.initCrop(a,s,l),null!=n&&n(),t("#imgedit-history-"+a).val()&&"0"===t("#imgedit-undone-"+a).val()?t("input.imgedit-submit-btn","#imgedit-panel-"+a).prop("disabled",!1):t("input.imgedit-submit-btn","#imgedit-panel-"+a).prop("disabled",!0),h.toggleEditor(a,0)})).on("error",(function(){var e=i("Could not load the preview image. Please reload the page and try again.");t("#imgedit-crop-"+a).empty().append('<div class="notice notice-error" tabindex="-1" role="alert"><p>'+e+"</p></div>"),d.toggleEditor(a,0,!0),wp.a11y.speak(e,"assertive")})).attr("src",ajaxurl+"?"+t.param(r))},action:function(i,e,a){var o,n,r,s,d,l=this;if(l.notsaved(i))return!1;if(o={action:"image-editor",_ajax_nonce:e,postid:i},"scale"===a){if(n=t("#imgedit-scale-width-"+i),r=t("#imgedit-scale-height-"+i),s=l.intval(n.val()),d=l.intval(r.val()),s<1)return n.trigger("focus"),!1;if(d<1)return r.trigger("focus"),!1;if(s===l.hold.ow||d===l.hold.oh)return!1;o["do"]="scale",o.fwidth=s,o.fheight=d}else{if("restore"!==a)return!1;o["do"]="restore"}l.toggleEditor(i,1),t.post(ajaxurl,o,(function(e){t("#image-editor-"+i).empty().append(e.data.html),l.toggleEditor(i,0,!0),l._view&&l._view.refresh()})).done((function(t){t&&t.data.message.msg?wp.a11y.speak(t.data.message.msg):t&&t.data.message.error&&wp.a11y.speak(t.data.message.error)}))},save:function(i,a){var o,n=this.getTarget(i),r=this.filterHistory(i,0),s=this;if(""===r)return!1;this.toggleEditor(i,1),o={action:"image-editor",_ajax_nonce:a,postid:i,history:r,target:n,context:t("#image-edit-context").length?t("#image-edit-context").val():null,"do":"save"},t.post(ajaxurl,o,(function(a){if(a.data.error)return t("#imgedit-response-"+i).html('<div class="notice notice-error" tabindex="-1" role="alert"><p>'+a.data.error+"</p></div>"),e.close(i),void wp.a11y.speak(a.data.error);a.data.fw&&a.data.fh&&t("#media-dims-"+i).html(a.data.fw+" &times; "+a.data.fh),a.data.thumbnail&&t(".thumbnail","#thumbnail-head-"+i).attr("src",""+a.data.thumbnail),a.data.msg&&(t("#imgedit-response-"+i).html('<div class="notice notice-success" tabindex="-1" role="alert"><p>'+a.data.msg+"</p></div>"),wp.a11y.speak(a.data.msg)),s._view?s._view.save():e.close(i)}))},open:function(a,o,n){this._view=n;var r,s=t("#image-editor-"+a),d=t("#media-head-"+a),l=t("#imgedit-open-btn-"+a),h=l.siblings(".spinner");if(!l.hasClass("button-activated"))return h.addClass("is-active"),r={action:"image-editor",_ajax_nonce:o,postid:a,"do":"open"},t.ajax({url:ajaxurl,type:"post",data:r,beforeSend:function(){l.addClass("button-activated")}}).done((function(o){var n;"-1"===o&&(n=i("Could not load the preview image."),s.html('<div class="notice notice-error" tabindex="-1" role="alert"><p>'+n+"</p></div>")),o.data&&o.data.html&&s.html(o.data.html),d.fadeOut("fast",(function(){s.fadeIn("fast",(function(){n&&t(document).trigger("image-editor-ui-ready")})),l.removeClass("button-activated"),h.removeClass("is-active")})),e.init(a)}))},imgLoaded:function(i){var e=t("#image-preview-"+i),a=t("#imgedit-crop-"+i);"undefined"==typeof this.hold.sizer&&this.init(i),this.calculateImgSize(i),this.initCrop(i,e,a),this.setCropSelection(i,{x1:0,y1:0,x2:0,y2:0,width:e.innerWidth(),height:e.innerHeight()}),this.toggleEditor(i,0,!0)},focusManager:function(){setTimeout((function(){var t,i,e=document.querySelector('.notice[role="alert"]'),a=document.querySelector(".imgedit-wrap"),o=0;if(null==e)for(e=(t=[...a.querySelectorAll("button")])[o];!((i=t[o]).offsetWidth||i.offsetHeight||i.getClientRects().length);)e=t[o+=1];e.focus()}),200)},initCrop:function(i,a,o){var n=this,r=t("#imgedit-sel-width-"+i),s=t("#imgedit-sel-height-"+i),d=t(a);d.data("imgAreaSelect")||(n.iasapi=d.imgAreaSelect({parent:o,instance:!0,handles:!0,keys:!0,minWidth:3,minHeight:3,onInit:function(e){t(e).next().css("position","absolute").nextAll(".imgareaselect-outer").css("position","absolute"),o.children().on("mousedown touchstart",(function(e){var a=!1,o=n.iasapi.getSelection(),r=n.intval(t("#imgedit-crop-width-"+i).val()),s=n.intval(t("#imgedit-crop-height-"+i).val());r&&s?a=n.getSelRatio(i):e.shiftKey&&o&&o.width&&o.height&&(a=o.width+":"+o.height),n.iasapi.setOptions({aspectRatio:a})}))},onSelectStart:function(){e.setDisabled(t("#imgedit-crop-sel-"+i),1)},onSelectEnd:function(t,a){e.setCropSelection(i,a)},onSelectChange:function(t,i){var a=e.hold.sizer,o=e.currentCropSelection;null!=o&&o.width==i.width&&o.height==i.height||(r.val(Math.min(e.hold.w,e.round(i.width/a))),s.val(Math.min(e.hold.h,e.round(i.height/a))),n.currentCropSelection=i)}}))},setCropSelection:function(i,e){var a,o=t("#imgedit-sel-width-"+i),n=t("#imgedit-sel-height-"+i),r=this.hold.sizer,s=this.hold;if(!(e=e||0)||e.width<3&&e.height<3)return this.setDisabled(t(".imgedit-crop","#imgedit-panel-"+i),1),this.setDisabled(t("#imgedit-crop-sel-"+i),1),t("#imgedit-sel-width-"+i).val(""),t("#imgedit-sel-height-"+i).val(""),t("#imgedit-selection-"+i).val(""),!1;var d=s.w-(Math.round(e.x1/r)+parseInt(o.val())),l=s.h-(Math.round(e.y1/r)+parseInt(n.val()));a={r:1,x:Math.round(e.x1/r)+Math.min(0,d),y:Math.round(e.y1/r)+Math.min(0,l),w:o.val(),h:n.val()},this.setDisabled(t(".imgedit-crop","#imgedit-panel-"+i),1),t("#imgedit-selection-"+i).val(JSON.stringify(a))},close:function(t,i){var e=new URLSearchParams(window.location.search);if((i=i||!1)&&this.notsaved(t))return!1;this.iasapi={},this.hold={},e["delete"]("mode"),history.replaceState(null,null,"?"+e.toString()),document.querySelector(".imgedit-wrap").remove(),document.querySelector(".attachment-details").removeAttribute("hidden"),document.querySelector(".attachment-details").removeAttribute("inert"),document.querySelector(".edit-attachment").focus()},notsaved:function(i){var e=t("#imgedit-history-"+i).val(),a=""!==e?JSON.parse(e):[];return this.intval(t("#imgedit-undone-"+i).val())<a.length&&!confirm(t("#imgedit-leaving-"+i).text())},addStep:function(i,e,a){for(var o=this,n=t("#imgedit-history-"+e),r=""!==n.val()?JSON.parse(n.val()):[],s=t("#imgedit-undone-"+e),d=o.intval(s.val());d>0;)r.pop(),d--;s.val(0),r.push(i),n.val(JSON.stringify(r)),o.refreshEditor(e,a,(function(){o.setDisabled(t("#image-undo-"+e),!0),o.setDisabled(t("#image-redo-"+e),!1)}))},rotate:function(i,e,a,o){if(t(o).hasClass("disabled"))return!1;this.addStep({r:{r:i,fw:this.hold.h,fh:this.hold.w}},e,a),t("#imgedit-sel-width-"+e).val(""),t("#imgedit-sel-height-"+e).val(""),this.currentCropSelection=null},flip:function(i,e,a,o){if(t(o).hasClass("disabled"))return!1;this.addStep({f:{f:i,fw:this.hold.w,fh:this.hold.h}},e,a),t("#imgedit-sel-width-"+e).val(""),t("#imgedit-sel-height-"+e).val(""),this.currentCropSelection=null},crop:function(i,e,a){var o=t("#imgedit-selection-"+i).val(),n=this.intval(t("#imgedit-sel-width-"+i).val()),r=this.intval(t("#imgedit-sel-height-"+i).val());if(t(a).hasClass("disabled")||""===o)return!1;(o=JSON.parse(o)).w>0&&o.h>0&&n>0&&r>0&&(o.fw=n,o.fh=r,this.addStep({c:o},i,e)),t("#imgedit-sel-width-"+i).val(""),t("#imgedit-sel-height-"+i).val(""),t("#imgedit-start-x-"+i).val("0"),t("#imgedit-start-y-"+i).val("0"),this.currentCropSelection=null},undo:function(i,e){var a=this,o=t("#image-undo-"+i),n=t("#imgedit-undone-"+i),r=a.intval(n.val())+1;o.hasClass("disabled")||(n.val(r),a.refreshEditor(i,e,(function(){var e=t("#imgedit-history-"+i),n=""!==e.val()?JSON.parse(e.val()):[];a.setDisabled(t("#image-redo-"+i),!0),a.setDisabled(o,r<n.length),n.length===r&&t("#image-redo-"+i).trigger("focus")})))},redo:function(i,e){var a=this,o=t("#image-redo-"+i),n=t("#imgedit-undone-"+i),r=a.intval(n.val())-1;o.hasClass("disabled")||(n.val(r),a.refreshEditor(i,e,(function(){a.setDisabled(t("#image-undo-"+i),!0),a.setDisabled(o,r>0),0===r&&t("#image-undo-"+i).trigger("focus")})))},setNumSelection:function(i,e){var a,o,n,r,s,d=t("#imgedit-sel-width-"+i),l=t("#imgedit-sel-height-"+i),h=this.intval(d.val()),g=this.intval(l.val()),c=t("#image-preview-"+i),u=c.height(),m=c.width(),p=this.hold.sizer,v=this.iasapi;if(this.currentCropSelection=null,!1!==this.validateNumeric(e))return h<1?(d.val(""),!1):g<1?(l.val(""),!1):void(h&&g&&(a=v.getSelection())&&(r=a.x1+Math.round(h*p),s=a.y1+Math.round(g*p),o=a.x1,n=a.y1,r>m&&(o=0,r=m,d.val(Math.min(this.hold.w,Math.round(r/p)))),s>u&&(n=0,s=u,l.val(Math.min(this.hold.h,Math.round(s/p)))),v.setSelection(o,n,r,s),v.update(),this.setCropSelection(i,v.getSelection()),this.currentCropSelection=v.getSelection()))},round:function(t){var i;return t=Math.round(t),this.hold.sizer>.6?t:"1"===(i=t.toString().slice(-1))?t-1:"9"===i?t+1:t},setRatioSelection:function(i,e,a){var o,n,r=this.intval(t("#imgedit-crop-width-"+i).val()),s=this.intval(t("#imgedit-crop-height-"+i).val()),d=t("#image-preview-"+i).height();!1!==this.validateNumeric(a)?r&&s&&(this.iasapi.setOptions({aspectRatio:r+":"+s}),(o=this.iasapi.getSelection(!0))&&((n=Math.ceil(o.y1+(o.x2-o.x1)/(r/s)))>d&&(n=d,e?t("#imgedit-crop-height-"+i).val(""):t("#imgedit-crop-width-"+i).val("")),this.iasapi.setSelection(o.x1,o.y1,o.x2,n),this.iasapi.update())):this.iasapi.setOptions({aspectRatio:null})},validateNumeric:function(i){if(!this.intval(t(i).val()))return t(i).val(""),!1}}}(jQuery);