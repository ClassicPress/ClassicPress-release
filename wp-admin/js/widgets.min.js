var wpWidgets;!function(p){var v=p(document);wpWidgets={hoveredSidebar:null,l10n:{save:"{save}",saved:"{saved}",saveAlert:"{saveAlert}"},dirtyWidgets:{},init:function(){var c,g,w=this,t=p(".widgets-chooser"),n=t.find(".widgets-chooser-sidebars"),e=p("div.widgets-sortables"),h=!("undefined"==typeof isRtl||!isRtl);p("#widgets-right .sidebar-name").click(function(){var e=p(this),i=e.closest(".widgets-holder-wrap "),t=e.find(".handlediv");i.hasClass("closed")?(i.removeClass("closed"),t.attr("aria-expanded","true"),e.parent().sortable("refresh")):(i.addClass("closed"),t.attr("aria-expanded","false")),v.triggerHandler("wp-pin-menu")}).find(".handlediv").each(function(e){0!==e&&p(this).attr("aria-expanded","false")}),p(window).on("beforeunload.widgets",function(e){var i,t=[];if(p.each(w.dirtyWidgets,function(e,i){i&&t.push(e)}),0!==t.length)return(i=p("#widgets-right").find(".widget").filter(function(){return-1!==t.indexOf(p(this).prop("id").replace(/^widget-\d+_/,""))})).each(function(){p(this).hasClass("open")||p(this).find(".widget-title-action:first").click()}),i.first().each(function(){this.scrollIntoViewIfNeeded?this.scrollIntoViewIfNeeded():this.scrollIntoView(),p(this).find(".widget-inside :tabbable:first").focus()}),e.returnValue=wpWidgets.l10n.saveAlert,e.returnValue}),p("#widgets-left .sidebar-name").click(function(){var e=p(this).closest(".widgets-holder-wrap");e.toggleClass("closed").find(".handlediv").attr("aria-expanded",!e.hasClass("closed")),v.triggerHandler("wp-pin-menu")}),p(document.body).bind("click.widgets-toggle",function(e){var i,t,d,s,a,n,r=p(e.target),o={"z-index":100},l=r.closest(".widget").find(".widget-top button.widget-action");r.parents(".widget-top").length&&!r.parents("#available-widgets").length?(t=(i=r.closest("div.widget")).children(".widget-inside"),d=parseInt(i.find("input.widget-width").val(),10),s=i.parent().width(),n=t.find(".widget-id").val(),i.data("dirty-state-initialized")||((a=t.find(".widget-control-save")).prop("disabled",!0).val(wpWidgets.l10n.saved),t.on("input change",function(){w.dirtyWidgets[n]=!0,i.addClass("widget-dirty"),a.prop("disabled",!1).val(wpWidgets.l10n.save)}),i.data("dirty-state-initialized",!0)),t.is(":hidden")?(250<d&&s<d+30&&i.closest("div.widgets-sortables").length&&(o[i.closest("div.widget-liquid-right").length?h?"margin-right":"margin-left":h?"margin-left":"margin-right"]=s-(d+30)+"px",i.css(o)),l.attr("aria-expanded","true"),t.slideDown("fast",function(){i.addClass("open")})):(l.attr("aria-expanded","false"),t.slideUp("fast",function(){i.attr("style",""),i.removeClass("open")})),e.preventDefault()):r.hasClass("widget-control-save")?(wpWidgets.save(r.closest("div.widget"),0,1,0),e.preventDefault()):r.hasClass("widget-control-remove")?(wpWidgets.save(r.closest("div.widget"),1,1,0),e.preventDefault()):r.hasClass("widget-control-close")?((i=r.closest("div.widget")).removeClass("open"),l.attr("aria-expanded","false"),wpWidgets.close(i),e.preventDefault()):"inactive-widgets-control-remove"===r.attr("id")&&(wpWidgets.removeInactiveWidgets(),e.preventDefault())}),e.children(".widget").each(function(){var e=p(this);wpWidgets.appendTitle(this),e.find("p.widget-error").length&&e.find(".widget-action").trigger("click").attr("aria-expanded","true")}),p("#widget-list").children(".widget").draggable({connectToSortable:"div.widgets-sortables",handle:"> .widget-top > .widget-title",distance:2,helper:"clone",zIndex:100,containment:"#wpwrap",refreshPositions:!0,start:function(e,i){var t=p(this).find(".widgets-chooser");i.helper.find("div.widget-description").hide(),g=this.id,t.length&&(p("#wpbody-content").append(t.hide()),i.helper.find(".widgets-chooser").remove(),w.clearWidgetSelection())},stop:function(){c&&p(c).hide(),c=""}}),e.droppable({tolerance:"intersect",over:function(e){var i=p(e.target).parent();wpWidgets.hoveredSidebar&&!i.is(wpWidgets.hoveredSidebar)&&wpWidgets.closeSidebar(e),i.hasClass("closed")&&(wpWidgets.hoveredSidebar=i).removeClass("closed").find(".handlediv").attr("aria-expanded","true"),p(this).sortable("refresh")},out:function(e){wpWidgets.hoveredSidebar&&wpWidgets.closeSidebar(e)}}),e.sortable({placeholder:"widget-placeholder",items:"> .widget",handle:"> .widget-top > .widget-title",cursor:"move",distance:2,containment:"#wpwrap",tolerance:"pointer",refreshPositions:!0,start:function(e,i){var t,d=p(this),s=d.parent(),a=i.item.children(".widget-inside");"block"===a.css("display")&&(i.item.removeClass("open"),i.item.find(".widget-top button.widget-action").attr("aria-expanded","false"),a.hide(),p(this).sortable("refreshPositions")),s.hasClass("closed")||(t=i.item.hasClass("ui-draggable")?d.height():1+d.height(),d.css("min-height",t+"px"))},stop:function(e,i){var t,d,s,a,n,r,o=i.item,l=g;if(wpWidgets.hoveredSidebar=null,o.hasClass("deleting"))return wpWidgets.save(o,1,0,1),void o.remove();t=o.find("input.add_new").val(),d=o.find("input.multi_number").val(),o.attr("style","").removeClass("ui-draggable"),g="",t&&("multi"===t?(o.html(o.html().replace(/<[^<>]+>/g,function(e){return e.replace(/__i__|%i%/g,d)})),o.attr("id",l.replace("__i__",d)),d++,p("div#"+l).find("input.multi_number").val(d)):"single"===t&&(o.attr("id","new-"+l),c="div#"+l),wpWidgets.save(o,0,0,1),o.find("input.add_new").val(""),v.trigger("widget-added",[o])),(s=o.parent()).parent().hasClass("closed")&&(s.parent().removeClass("closed").find(".handlediv").attr("aria-expanded","true"),1<(a=s.children(".widget")).length&&(n=a.get(0),r=o.get(0),n.id&&r.id&&n.id!==r.id&&p(n).before(o))),t?o.find(".widget-action").trigger("click"):wpWidgets.saveOrder(s.attr("id"))},activate:function(){p(this).parent().addClass("widget-hover")},deactivate:function(){p(this).css("min-height","").parent().removeClass("widget-hover")},receive:function(e,i){var t=p(i.sender);-1<this.id.indexOf("orphaned_widgets")?t.sortable("cancel"):-1<t.attr("id").indexOf("orphaned_widgets")&&!t.children(".widget").length&&t.parents(".orphan-sidebar").slideUp(400,function(){p(this).remove()})}}).sortable("option","connectWith","div.widgets-sortables"),p("#available-widgets").droppable({tolerance:"pointer",accept:function(e){return"widget-list"!==p(e).parent().attr("id")},drop:function(e,i){i.draggable.addClass("deleting"),p("#removing-widget").hide().children("span").empty()},over:function(e,i){i.draggable.addClass("deleting"),p("div.widget-placeholder").hide(),i.draggable.hasClass("ui-sortable-helper")&&p("#removing-widget").show().children("span").html(i.draggable.find("div.widget-title").children("h3").html())},out:function(e,i){i.draggable.removeClass("deleting"),p("div.widget-placeholder").show(),p("#removing-widget").hide().children("span").empty()}}),p("#widgets-right .widgets-holder-wrap").each(function(e,i){var t=p(i),d=t.find(".sidebar-name h2").text(),s=t.find(".widgets-sortables").attr("id"),a=p('<li tabindex="0">').text(p.trim(d));0===e&&a.addClass("widgets-chooser-selected"),n.append(a),a.data("sidebarId",s)}),p("#available-widgets .widget .widget-title").on("click.widgets-chooser",function(){var e=p(this).closest(".widget");e.hasClass("widget-in-question")||p("#widgets-left").hasClass("chooser")?w.closeChooser():(w.clearWidgetSelection(),p("#widgets-left").addClass("chooser"),e.addClass("widget-in-question").children(".widget-description").after(t),t.slideDown(300,function(){n.find(".widgets-chooser-selected").focus()}),n.find("li").on("focusin.widgets-chooser",function(){n.find(".widgets-chooser-selected").removeClass("widgets-chooser-selected"),p(this).addClass("widgets-chooser-selected")}))}),t.on("click.widgets-chooser",function(e){var i=p(e.target);i.hasClass("button-primary")?(w.addWidget(t),w.closeChooser()):i.hasClass("widgets-chooser-cancel")&&w.closeChooser()}).on("keyup.widgets-chooser",function(e){e.which===p.ui.keyCode.ENTER?(p(e.target).hasClass("widgets-chooser-cancel")||w.addWidget(t),w.closeChooser()):e.which===p.ui.keyCode.ESCAPE&&w.closeChooser()})},saveOrder:function(e){var i={action:"widgets-order",savewidgets:p("#_wpnonce_widgets").val(),sidebars:[]};e&&p("#"+e).find(".spinner:first").addClass("is-active"),p("div.widgets-sortables").each(function(){p(this).sortable&&(i["sidebars["+p(this).attr("id")+"]"]=p(this).sortable("toArray").join(","))}),p.post(ajaxurl,i,function(){p("#inactive-widgets-control-remove").prop("disabled",!p("#wp_inactive_widgets .widget").length),p(".spinner").removeClass("is-active")})},save:function(t,d,s,a){var e,i,n=this,r=t.closest("div.widgets-sortables").attr("id"),o=t.find("form"),l=t.find("input.add_new").val();(d||l||!o.prop("checkValidity")||o[0].checkValidity())&&(e=o.serialize(),t=p(t),p(".spinner",t).addClass("is-active"),i={action:"save-widget",savewidgets:p("#_wpnonce_widgets").val(),sidebar:r},d&&(i.delete_widget=1),e+="&"+p.param(i),p.post(ajaxurl,e,function(e){var i=p("input.widget-id",t).val();d?(p("input.widget_number",t).val()||p("#available-widgets").find("input.widget-id").each(function(){p(this).val()===i&&p(this).closest("div.widget").show()}),s?(a=0,t.slideUp("fast",function(){p(this).remove(),wpWidgets.saveOrder(),delete n.dirtyWidgets[i]})):(t.remove(),delete n.dirtyWidgets[i],"wp_inactive_widgets"===r&&p("#inactive-widgets-control-remove").prop("disabled",!p("#wp_inactive_widgets .widget").length))):(p(".spinner").removeClass("is-active"),e&&2<e.length&&(p("div.widget-content",t).html(e),wpWidgets.appendTitle(t),t.find(".widget-control-save").prop("disabled",!0).val(wpWidgets.l10n.saved),t.removeClass("widget-dirty"),delete n.dirtyWidgets[i],v.trigger("widget-updated",[t]),"wp_inactive_widgets"===r&&p("#inactive-widgets-control-remove").prop("disabled",!p("#wp_inactive_widgets .widget").length))),a&&wpWidgets.saveOrder()}))},removeInactiveWidgets:function(){var e,i,t=p(".remove-inactive-widgets"),d=this;p(".spinner",t).addClass("is-active"),e={action:"delete-inactive-widgets",removeinactivewidgets:p("#_wpnonce_remove_inactive_widgets").val()},i=p.param(e),p.post(ajaxurl,i,function(){p("#wp_inactive_widgets .widget").each(function(){var e=p(this);delete d.dirtyWidgets[e.find("input.widget-id").val()],e.remove()}),p("#inactive-widgets-control-remove").prop("disabled",!0),p(".spinner",t).removeClass("is-active")})},appendTitle:function(e){var i=p('input[id*="-title"]',e).val()||"";i&&(i=": "+i.replace(/<[^<>]+>/g,"").replace(/</g,"&lt;").replace(/>/g,"&gt;")),p(e).children(".widget-top").children(".widget-title").children().children(".in-widget-title").html(i)},close:function(e){e.children(".widget-inside").slideUp("fast",function(){e.attr("style","").find(".widget-top button.widget-action").attr("aria-expanded","false").focus()})},addWidget:function(e){var i,t,d,s,a,n,r,o=e.find(".widgets-chooser-selected").data("sidebarId"),l=p("#"+o);t=(i=p("#available-widgets").find(".widget-in-question").clone()).attr("id"),d=i.find("input.add_new").val(),s=i.find("input.multi_number").val(),i.find(".widgets-chooser").remove(),"multi"===d?(i.html(i.html().replace(/<[^<>]+>/g,function(e){return e.replace(/__i__|%i%/g,s)})),i.attr("id",t.replace("__i__",s)),s++,p("#"+t).find("input.multi_number").val(s)):"single"===d&&(i.attr("id","new-"+t),p("#"+t).hide()),l.closest(".widgets-holder-wrap").removeClass("closed").find(".handlediv").attr("aria-expanded","true"),l.append(i),l.sortable("refresh"),wpWidgets.save(i,0,0,1),i.find("input.add_new").val(""),v.trigger("widget-added",[i]),n=(a=p(window).scrollTop())+p(window).height(),(r=l.offset()).bottom=r.top+l.outerHeight(),(a>r.bottom||n<r.top)&&p("html, body").animate({scrollTop:r.top-130},200),window.setTimeout(function(){i.find(".widget-title").trigger("click")},250)},closeChooser:function(){var e=this;p(".widgets-chooser").slideUp(200,function(){p("#wpbody-content").append(this),e.clearWidgetSelection()})},clearWidgetSelection:function(){p("#widgets-left").removeClass("chooser"),p(".widget-in-question").removeClass("widget-in-question")},closeSidebar:function(e){this.hoveredSidebar.addClass("closed").find(".handlediv").attr("aria-expanded","false"),p(e.target).css("min-height",""),this.hoveredSidebar=null}},v.ready(function(){wpWidgets.init()})}(jQuery);