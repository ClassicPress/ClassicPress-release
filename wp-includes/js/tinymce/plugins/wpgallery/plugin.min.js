tinymce.PluginManager.add("wpgallery",(function(e){function t(e){return e.replace(/\[gallery([^\]]*)\]/g,(function(e){return t="wp-gallery",n=e,n=window.encodeURIComponent(n),'<img src="'+tinymce.Env.transparentSrc+'" class="wp-media mceItem '+t+'" data-wp-media="'+n+'" data-mce-resize="false" data-mce-placeholder="1" alt="" />';var t,n}))}function n(e){return e.replace(/(?:<p(?: [^>]+)?>)*(<img [^>]+>)(?:<\/p>)*/g,(function(e,t){var n,a,d=(n=t,a="data-wp-media",(a=new RegExp(a+'="([^"]+)"').exec(n))?window.decodeURIComponent(a[1]):"");return d?"<p>"+d+"</p>":e}))}function a(t){var n,a,d;"IMG"===t.nodeName&&"undefined"!=typeof wp&&wp.media&&(d=window.decodeURIComponent(e.dom.getAttrib(t,"data-wp-media")),e.dom.hasClass(t,"wp-gallery")&&wp.media.gallery&&(n=wp.media.gallery,(a=n.edit(d)).state("gallery-edit").on("update",(function(d){var o=n.shortcode(d).string();e.dom.setAttrib(t,"data-wp-media",window.encodeURIComponent(o)),a.detach()}))))}e.addCommand("WP_Gallery",(function(){a(e.selection.getNode())})),e.on("mouseup",(function(t){var n=e.dom,d=t.target;function o(){n.removeClass(n.select("img.wp-media-selected"),"wp-media-selected")}"IMG"===d.nodeName&&n.getAttrib(d,"data-wp-media")?2!==t.button&&(n.hasClass(d,"wp-media-selected")?a(d):(o(),n.addClass(d,"wp-media-selected"))):o()})),e.on("ResolveName",(function(t){var n=e.dom,a=t.target;"IMG"===a.nodeName&&n.getAttrib(a,"data-wp-media")&&n.hasClass(a,"wp-gallery")&&(t.name="gallery")})),e.on("BeforeSetContent",(function(n){e.plugins.wpview&&"undefined"!=typeof wp&&wp.mce||(n.content=t(n.content))})),e.on("PostProcess",(function(e){e.get&&(e.content=n(e.content))}))}));