tinymce.PluginManager.add("wpeditimage",(function(e){var t,n,a,i,o,r=tinymce.each,c=tinymce.trim,d=tinymce.Env.iOS;function l(t){return!(!e.dom.getAttrib(t,"data-mce-placeholder")&&!e.dom.getAttrib(t,"data-mce-object"))}function s(t){var n=e.$(t).parents("[contenteditable]");return n&&"false"===n.attr("contenteditable")}function m(t){return t.replace(/(?:<p>)?\[(?:wp_)?caption([^\]]+)\]([\s\S]+?)\[\/(?:wp_)?caption\](?:<\/p>)?/g,(function(t,n,a){var i,o,r,d,l,s;return(i=n.match(/id=['"]([^'"]*)['"] ?/))&&(n=n.replace(i[0],"")),(o=n.match(/align=['"]([^'"]*)['"] ?/))&&(n=n.replace(o[0],"")),(r=n.match(/class=['"]([^'"]*)['"] ?/))&&(n=n.replace(r[0],"")),(s=n.match(/width=['"]([0-9]*)['"] ?/))&&(n=n.replace(s[0],"")),(l=(a=c(a)).match(/((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)([\s\S]*)/i))&&l[2]?(d=c(l[2]),l=c(l[1])):(d=c(n).replace(/caption=['"]/,"").replace(/['"]$/,""),l=a),i=i&&i[1]?i[1].replace(/[<>&]+/g,""):"",o=o&&o[1]?o[1]:"alignnone",r=r&&r[1]?" "+r[1].replace(/[<>&]+/g,""):"",!s&&l&&(s=l.match(/width=['"]([0-9]*)['"]/)),s&&s[1]&&(s=s[1]),s&&d?(s=parseInt(s,10),e.getParam("wpeditimage_html5_captions")||(s+=10),'<div class="mceTemp"><dl id="'+i+'" class="wp-caption '+o+r+'" style="width: '+s+'px"><dt class="wp-caption-dt">'+l+'</dt><dd class="wp-caption-dd">'+d+"</dd></dl></div>"):a}))}function p(e){return e.replace(/(?:<div [^>]+mceTemp[^>]+>)?\s*(<dl [^>]+wp-caption[^>]+>[\s\S]+?<\/dl>)\s*(?:<\/div>)?/g,(function(e,t){var n="";return-1===t.indexOf("<img ")||-1!==t.indexOf("</p>")?t.replace(/<d[ldt]( [^>]+)?>/g,"").replace(/<\/d[ldt]>/g,""):(-1===(n=t.replace(/\s*<dl ([^>]+)>\s*<dt [^>]+>([\s\S]+?)<\/dt>\s*<dd [^>]+>([\s\S]*?)<\/dd>\s*<\/dl>\s*/gi,(function(e,t,n,a){var i,o,r,c;return c=(c=n.match(/width="([0-9]*)"/))&&c[1]?c[1]:"",r=(o=(o=t.match(/class="([^"]*)"/))&&o[1]?o[1]:"").match(/align[a-z]+/i)||"alignnone",c&&a?(i=(i=t.match(/id="([^"]*)"/))&&i[1]?i[1]:"",(o=o.replace(/wp-caption ?|align[a-z]+ ?/gi,""))&&(o=' class="'+o+'"'),a=a.replace(/\r\n|\r/g,"\n").replace(/<[a-zA-Z0-9]+( [^<>]+)?>/g,(function(e){return e.replace(/[\r\n\t]+/," ")})),'[caption id="'+i+'" align="'+r+'" width="'+c+'"'+o+"]"+n+" "+(a=a.replace(/\s*\n\s*/g,"<br />"))+"[/caption]"):("alignnone"!==r[0]&&(n=n.replace(/><img/,' class="'+r[0]+'"><img')),n)}))).indexOf("[caption")&&(n=t.replace(/[\s\S]*?((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)(<p>[\s\S]*<\/p>)?[\s\S]*/gi,"<p>$1</p>$2")),n)}))}function g(e){return e&&!!(e.textContent||e.innerText).replace(/\ufeff/g,"")}function u(t){var n=e.dom.getParent(t,"div.mceTemp");n||"IMG"!==t.nodeName||(n=e.dom.getParent(t,"a")),n?(n.nextSibling?e.selection.select(n.nextSibling):n.previousSibling?e.selection.select(n.previousSibling):e.selection.select(n.parentNode),e.selection.collapse(!0),e.dom.remove(n)):e.dom.remove(t),e.nodeChanged(),e.undoManager.add()}return e.addButton("wp_img_remove",{tooltip:"Remove",icon:"dashicon dashicons-no",onclick:function(){u(e.selection.getNode())}}),e.addButton("wp_img_edit",{tooltip:"Edit|button",icon:"dashicon dashicons-edit",onclick:function(){!function(t){var a,i,o,r;if("undefined"==typeof wp||!wp.media)return void e.execCommand("mceImage");o=function(t){var n,a,i,o,r,c,d,l,s=[],m=e.dom,p=/^\d+$/;i={attachment_id:!1,size:"custom",caption:"",align:"none",extraClasses:"",link:!1,linkUrl:"",linkClassName:"",linkTargetBlank:!1,linkRel:"",title:""},i.url=m.getAttrib(t,"src"),i.alt=m.getAttrib(t,"alt"),i.title=m.getAttrib(t,"title"),d=m.getAttrib(t,"width"),l=m.getAttrib(t,"height"),(!p.test(d)||parseInt(d,10)<1)&&(d=t.naturalWidth||t.width);(!p.test(l)||parseInt(l,10)<1)&&(l=t.naturalHeight||t.height);i.customWidth=i.width=d,i.customHeight=i.height=l,n=tinymce.explode(t.className," "),a=[],tinymce.each(n,(function(e){/^wp-image/.test(e)?i.attachment_id=parseInt(e.replace("wp-image-",""),10):/^align/.test(e)?i.align=e.replace("align",""):/^size/.test(e)?i.size=e.replace("size-",""):a.push(e)})),i.extraClasses=a.join(" "),o=m.getParents(t,".wp-caption"),o.length&&(n=(o=o[0]).className.split(" "),tinymce.each(n,(function(e){/^align/.test(e)?i.align=e.replace("align",""):e&&"wp-caption"!==e&&s.push(e)})),i.captionClassName=s.join(" "),(r=m.select("dd.wp-caption-dd",o)).length&&(r=r[0],i.caption=e.serializer.serialize(r).replace(/<br[^>]*>/g,"$&\n").replace(/^<p>/,"").replace(/<\/p>$/,"")));t.parentNode&&"A"===t.parentNode.nodeName&&(c=t.parentNode,i.linkUrl=m.getAttrib(c,"href"),i.linkTargetBlank="_blank"===m.getAttrib(c,"target"),i.linkRel=m.getAttrib(c,"rel"),i.linkClassName=c.className);return i}(t),e.$(t).attr("data-wp-editing",1),wp.media.events.trigger("editor:image-edit",{editor:e,metadata:o,image:t}),a=wp.media({frame:"image",state:"image-details",metadata:o}),wp.media.events.trigger("editor:frame-create",{frame:a}),i=function(t){e.undoManager.transact((function(){!function(t,a){var i,o,r,c,d,l,s,m,p,u,f,h,w,v,N,b,_,C,y=e.dom;if(!t||!t.length)return;m=t[0],i=tinymce.explode(a.extraClasses," "),i||(i=[]);a.caption||i.push("align"+a.align);a.attachment_id&&(i.push("wp-image-"+a.attachment_id),a.size&&"custom"!==a.size&&i.push("size-"+a.size));N=a.width,b=a.height,"custom"===a.size&&(N=a.customWidth,b=a.customHeight);w={src:a.url,width:N||null,height:b||null,title:a.title||null,"class":i.join(" ")||null},y.setAttribs(m,w),t.attr("alt",a.alt||""),v={href:a.linkUrl,rel:a.linkRel||null,target:a.linkTargetBlank?"_blank":null,"class":a.linkClassName||null},m.parentNode&&"A"===m.parentNode.nodeName&&!g(m.parentNode)?a.linkUrl?y.setAttribs(m.parentNode,v):y.remove(m.parentNode,!0):a.linkUrl&&((s=y.getParent(m,"a"))&&y.insertAfter(m,s),s=y.create("a",v),m.parentNode.insertBefore(s,m),s.appendChild(m));p=e.dom.getParent(m,".mceTemp"),r=m.parentNode&&"A"===m.parentNode.nodeName&&!g(m.parentNode)?m.parentNode:m;a.caption?(a.caption=function(t){if(!t||-1===t.indexOf("<")&&-1===t.indexOf(">"))return t;n||(n=new tinymce.html.Serializer({},e.schema));return n.serialize(e.parser.parse(t,{forced_root_block:!1}))}(a.caption),h=a.attachment_id?"attachment_"+a.attachment_id:null,o="wp-caption "+("align"+(a.align||"none")),a.captionClassName&&(o+=" "+a.captionClassName.replace(/[<>&]+/g,"")),e.getParam("wpeditimage_html5_captions")||(N=parseInt(N,10),N+=10),p?((f=y.select("dl.wp-caption",p)).length&&y.setAttribs(f,{id:h,"class":o,style:"width: "+N+"px"}),(u=y.select(".wp-caption-dd",p)).length&&y.setHTML(u[0],a.caption)):(c="<dl "+(h=h?'id="'+h+'" ':"")+'class="'+o+'" style="width: '+N+'px"><dt class="wp-caption-dt"></dt><dd class="wp-caption-dd">'+a.caption+"</dd></dl>",l=y.create("div",{"class":"mceTemp"},c),(d=y.getParent(r,"p"))?d.parentNode.insertBefore(l,d):r.parentNode.insertBefore(l,r),e.$(l).find("dt.wp-caption-dt").append(r),d&&y.isEmpty(d)&&y.remove(d))):p&&(d=y.create("p"),p.parentNode.insertBefore(d,p),d.appendChild(r),y.remove(p));t=e.$(m),_=t.attr("srcset"),C=t.attr("src"),_&&C&&(C=C.replace(/[?#].*/,""),-1===_.indexOf(C)&&t.attr("srcset",null).attr("sizes",null));wp.media.events&&wp.media.events.trigger("editor:image-update",{editor:e,metadata:a,image:m});e.nodeChanged()}(r,t)})),a.detach()},a.state("image-details").on("update",i),a.state("replace-image").on("replace",i),a.on("close",(function(){e.focus(),a.detach(),(r=e.$("img[data-wp-editing]")).removeAttr("data-wp-editing")})),a.open()}(e.selection.getNode())}}),r({alignleft:"Align left",aligncenter:"Align center",alignright:"Align right",alignnone:"No alignment"},(function(t,n){var a=n.slice(5);e.addButton("wp_img_"+n,{tooltip:t,icon:"dashicon dashicons-align-"+a,cmd:"alignnone"===n?"wpAlignNone":"Justify"+a.slice(0,1).toUpperCase()+a.slice(1),onPostRender:function(){var t=this;e.on("NodeChange",(function(a){var i;"IMG"===a.element.nodeName&&(i=e.dom.getParent(a.element,".wp-caption")||a.element,"alignnone"===n?t.active(!/\balign(left|center|right)\b/.test(i.className)):t.active(e.dom.hasClass(i,n)))}))}})})),e.once("preinit",(function(){e.wp&&e.wp._createToolbar&&(t=e.wp._createToolbar(["wp_img_alignleft","wp_img_aligncenter","wp_img_alignright","wp_img_alignnone","wp_img_edit","wp_img_remove"]))})),e.on("wptoolbar",(function(e){"IMG"!==e.element.nodeName||l(e.element)||(e.toolbar=t)})),d&&e.on("init",(function(){e.on("touchstart",(function(e){"IMG"!==e.target.nodeName||s(e.target)||(a=!0)})),e.dom.bind(e.getDoc(),"touchmove",(function(){a=!1})),e.on("touchend",(function(n){if(a&&"IMG"===n.target.nodeName&&!s(n.target)){var i=n.target;a=!1,window.setTimeout((function(){e.selection.select(i),e.nodeChanged()}),100)}else t&&t.hide()}))})),e.on("init",(function(){var t=e.dom,n=e.getParam("wpeditimage_html5_captions")?"html5-captions":"html4-captions";t.addClass(e.getBody(),n),tinymce.Env.ie&&tinymce.Env.ie>10&&t.bind(e.getBody(),"mscontrolselect",(function(n){"IMG"===n.target.nodeName&&t.getParent(n.target,".wp-caption")?e.getBody().focus():"DL"===n.target.nodeName&&t.hasClass(n.target,"wp-caption")&&n.target.focus()}))})),e.on("ObjectResized",(function(t){var n=t.target;"IMG"===n.nodeName&&e.undoManager.transact((function(){var a,i,o=e.dom;n.className=n.className.replace(/\bsize-[^ ]+/,""),(a=o.getParent(n,".wp-caption"))&&(i=t.width||o.getAttrib(n,"width"))&&(i=parseInt(i,10),e.getParam("wpeditimage_html5_captions")||(i+=10),o.setStyle(a,"width",i+"px"))}))})),e.on("pastePostProcess",(function(t){e.dom.getParent(e.selection.getNode(),"dd.wp-caption-dd")&&(e.$("img, audio, video, object, embed, iframe, script, style",t.node).remove(),e.$("*",t.node).each((function(t,n){e.dom.isBlock(n)&&(tinymce.trim(n.textContent||n.innerText)?(e.dom.insertAfter(e.dom.create("br"),n),e.dom.remove(n,!0)):e.dom.remove(n))})),e.$("br",t.node).each((function(t,n){n.nextSibling&&"BR"!==n.nextSibling.nodeName&&n.previousSibling&&"BR"!==n.previousSibling.nodeName||e.dom.remove(n)})),i=!0)})),e.on("BeforeExecCommand",(function(n){var a,o,r,d,l,s,m=n.command,p=e.dom;if("mceInsertContent"===m||"Indent"===m||"Outdent"===m){if(a=e.selection.getNode(),s=p.getParent(a,"div.mceTemp")){if("mceInsertContent"!==m)return n.preventDefault(),n.stopImmediatePropagation(),!1;if(i)return void(i=!1);o=p.create("p"),p.insertAfter(o,s),e.selection.setCursorLocation(o,0),"IMG"===a.nodeName&&e.$(s).remove(),e.nodeChanged()}}else if("JustifyLeft"===m||"JustifyRight"===m||"JustifyCenter"===m||"wpAlignNone"===m){if(a=e.selection.getNode(),d="align"+m.slice(7).toLowerCase(),r=e.dom.getParent(a,".wp-caption"),"IMG"!==a.nodeName&&!r)return;a=r||a,l=e.dom.hasClass(a,d)?" alignnone":" "+d,a.className=c(a.className.replace(/ ?align(left|center|right|none)/g,"")+l),e.nodeChanged(),n.preventDefault(),t&&t.reposition(),e.fire("ExecCommand",{command:m,ui:n.ui,value:n.value})}})),e.on("keydown",(function(t){var n,a,i,o,r=e.selection,c=t.keyCode,d=e.dom,l=tinymce.util.VK;if(c===l.ENTER)n=r.getNode(),(a=d.getParent(n,"div.mceTemp"))&&(d.events.cancel(t),tinymce.each(d.select("dt, dd",a),(function(e){d.isEmpty(e)&&d.remove(e)})),o=tinymce.Env.ie&&tinymce.Env.ie<11?"":'<br data-mce-bogus="1" />',i=d.create("p",null,o),"DD"===n.nodeName?d.insertAfter(i,a):a.parentNode.insertBefore(i,a),e.nodeChanged(),r.setCursorLocation(i,0));else if((c===l.DELETE||c===l.BACKSPACE)&&("DIV"===(n=r.getNode()).nodeName&&d.hasClass(n,"mceTemp")?a=n:"IMG"!==n.nodeName&&"DT"!==n.nodeName&&"A"!==n.nodeName||(a=d.getParent(n,"div.mceTemp")),a))return d.events.cancel(t),u(n),!1})),tinymce.Env.gecko&&e.on("undo redo",(function(){"IMG"===e.selection.getNode().nodeName&&e.selection.collapse()})),e.wpSetImgCaption=function(e){return m(e)},e.wpGetImgCaption=function(e){return p(e)},e.on("beforeGetContent",(function(t){"raw"!==t.format&&e.$('img[id="__wp-temp-img-id"]').removeAttr("id")})),e.on("BeforeSetContent",(function(t){"raw"!==t.format&&(t.content=e.wpSetImgCaption(t.content))})),e.on("PostProcess",(function(t){t.get&&(t.content=e.wpGetImgCaption(t.content))})),e.on("dragstart",(function(){var t=e.selection.getNode();"IMG"===t.nodeName&&((o=e.dom.getParent(t,".mceTemp"))||"A"!==t.parentNode.nodeName||g(t.parentNode)||(o=t.parentNode))})),e.on("drop",(function(t){var n=e.dom,a=tinymce.dom.RangeUtils.getCaretRangeFromPoint(t.clientX,t.clientY,e.getDoc());a&&n.getParent(a.startContainer,".mceTemp")?t.preventDefault():o&&(t.preventDefault(),e.undoManager.transact((function(){a&&e.selection.setRng(a),e.selection.setNode(o),n.remove(o)}))),o=null})),e.wp=e.wp||{},e.wp.isPlaceholder=l,{_do_shcode:m,_get_shcode:p}}));