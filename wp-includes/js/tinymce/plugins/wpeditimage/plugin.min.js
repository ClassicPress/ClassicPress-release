tinymce.PluginManager.add("wpeditimage",function(A){var d,P,n,s,a,e=tinymce.each,m=tinymce.trim,t=tinymce.Env.iOS;function i(e){return!(!A.dom.getAttrib(e,"data-mce-placeholder")&&!A.dom.getAttrib(e,"data-mce-object"))}function o(e){var t=A.$(e).parents("[contenteditable]");return t&&"false"===t.attr("contenteditable")}function r(e){return e.replace(/(?:<p>)?\[(?:wp_)?caption([^\]]+)\]([\s\S]+?)\[\/(?:wp_)?caption\](?:<\/p>)?/g,function(e,t,n){var a,i,o,r,c,l;return(a=t.match(/id=['"]([^'"]*)['"] ?/))&&(t=t.replace(a[0],"")),(i=t.match(/align=['"]([^'"]*)['"] ?/))&&(t=t.replace(i[0],"")),(o=t.match(/class=['"]([^'"]*)['"] ?/))&&(t=t.replace(o[0],"")),(l=t.match(/width=['"]([0-9]*)['"] ?/))&&(t=t.replace(l[0],"")),(c=(n=m(n)).match(/((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)([\s\S]*)/i))&&c[2]?(r=m(c[2]),c=m(c[1])):(r=m(t).replace(/caption=['"]/,"").replace(/['"]$/,""),c=n),a=a&&a[1]?a[1].replace(/[<>&]+/g,""):"",i=i&&i[1]?i[1]:"alignnone",o=o&&o[1]?" "+o[1].replace(/[<>&]+/g,""):"",!l&&c&&(l=c.match(/width=['"]([0-9]*)['"]/)),l&&l[1]&&(l=l[1]),l&&r?(l=parseInt(l,10),A.getParam("wpeditimage_html5_captions")||(l+=10),'<div class="mceTemp"><dl id="'+a+'" class="wp-caption '+i+o+'" style="width: '+l+'px"><dt class="wp-caption-dt">'+c+'</dt><dd class="wp-caption-dd">'+r+"</dd></dl></div>"):n})}function c(e){return e.replace(/(?:<div [^>]+mceTemp[^>]+>)?\s*(<dl [^>]+wp-caption[^>]+>[\s\S]+?<\/dl>)\s*(?:<\/div>)?/g,function(e,t){var n="";return-1===t.indexOf("<img ")||-1!==t.indexOf("</p>")?t.replace(/<d[ldt]( [^>]+)?>/g,"").replace(/<\/d[ldt]>/g,""):(-1===(n=t.replace(/\s*<dl ([^>]+)>\s*<dt [^>]+>([\s\S]+?)<\/dt>\s*<dd [^>]+>([\s\S]*?)<\/dd>\s*<\/dl>\s*/gi,function(e,t,n,a){var i,o,r,c;return c=(c=n.match(/width="([0-9]*)"/))&&c[1]?c[1]:"",r=(o=(o=t.match(/class="([^"]*)"/))&&o[1]?o[1]:"").match(/align[a-z]+/i)||"alignnone",c&&a?(i=(i=t.match(/id="([^"]*)"/))&&i[1]?i[1]:"",(o=o.replace(/wp-caption ?|align[a-z]+ ?/gi,""))&&(o=' class="'+o+'"'),'[caption id="'+i+'" align="'+r+'" width="'+c+'"'+o+"]"+n+" "+(a=(a=a.replace(/\r\n|\r/g,"\n").replace(/<[a-zA-Z0-9]+( [^<>]+)?>/g,function(e){return e.replace(/[\r\n\t]+/," ")})).replace(/\s*\n\s*/g,"<br />"))+"[/caption]"):("alignnone"!==r[0]&&(n=n.replace(/><img/,' class="'+r[0]+'"><img')),n)})).indexOf("[caption")&&(n=t.replace(/[\s\S]*?((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)(<p>[\s\S]*<\/p>)?[\s\S]*/gi,"<p>$1</p>$2")),n)})}function I(e){return e&&!!(e.textContent||e.innerText).replace(/\ufeff/g,"")}function p(e){var t=A.dom.getParent(e,"div.mceTemp");t||"IMG"!==e.nodeName||(t=A.dom.getParent(e,"a")),t?(t.nextSibling?A.selection.select(t.nextSibling):t.previousSibling?A.selection.select(t.previousSibling):A.selection.select(t.parentNode),A.selection.collapse(!0),A.dom.remove(t)):A.dom.remove(e),A.nodeChanged(),A.undoManager.add()}return A.addButton("wp_img_remove",{tooltip:"Remove",icon:"dashicon dashicons-no",onclick:function(){p(A.selection.getNode())}}),A.addButton("wp_img_edit",{tooltip:"Edit|button",icon:"dashicon dashicons-edit",onclick:function(){!function i(t){var n,e,a;if("undefined"==typeof wp||!wp.media)return void A.execCommand("mceImage");a=function p(e){var t,n,a,i,o,r,c,l,d=[],s=A.dom,m=/^\d+$/;(a={attachment_id:!1,size:"custom",caption:"",align:"none",extraClasses:"",link:!1,linkUrl:"",linkClassName:"",linkTargetBlank:!1,linkRel:"",title:""}).url=s.getAttrib(e,"src"),a.alt=s.getAttrib(e,"alt"),a.title=s.getAttrib(e,"title"),c=s.getAttrib(e,"width"),l=s.getAttrib(e,"height"),(!m.test(c)||parseInt(c,10)<1)&&(c=e.naturalWidth||e.width);(!m.test(l)||parseInt(l,10)<1)&&(l=e.naturalHeight||e.height);a.customWidth=a.width=c,a.customHeight=a.height=l,t=tinymce.explode(e.className," "),n=[],tinymce.each(t,function(e){/^wp-image/.test(e)?a.attachment_id=parseInt(e.replace("wp-image-",""),10):/^align/.test(e)?a.align=e.replace("align",""):/^size/.test(e)?a.size=e.replace("size-",""):n.push(e)}),a.extraClasses=n.join(" "),(i=s.getParents(e,".wp-caption")).length&&(i=i[0],t=i.className.split(" "),tinymce.each(t,function(e){/^align/.test(e)?a.align=e.replace("align",""):e&&"wp-caption"!==e&&d.push(e)}),a.captionClassName=d.join(" "),(o=s.select("dd.wp-caption-dd",i)).length&&(o=o[0],a.caption=A.serializer.serialize(o).replace(/<br[^>]*>/g,"$&\n").replace(/^<p>/,"").replace(/<\/p>$/,"")));e.parentNode&&"A"===e.parentNode.nodeName&&(r=e.parentNode,a.linkUrl=s.getAttrib(r,"href"),a.linkTargetBlank="_blank"===s.getAttrib(r,"target"),a.linkRel=s.getAttrib(r,"rel"),a.linkClassName=r.className);return a}(t),wp.media.events.trigger("editor:image-edit",{editor:A,metadata:a,image:t}),n=wp.media({frame:"image",state:"image-details",metadata:a}),wp.media.events.trigger("editor:frame-create",{frame:n}),e=function(e){A.focus(),A.undoManager.transact(function(){!function y(e,t){var n,a,i,o,r,c,l,d,s,m,p,g,u,f,h,w,N,v,b,_=A.dom;(n=tinymce.explode(t.extraClasses," "))||(n=[]);t.caption||n.push("align"+t.align);t.attachment_id&&(n.push("wp-image-"+t.attachment_id),t.size&&"custom"!==t.size&&n.push("size-"+t.size));f=t.width,h=t.height,"custom"===t.size&&(f=t.customWidth,h=t.customHeight);g={src:t.url,width:f||null,height:h||null,title:t.title||null,"class":n.join(" ")||null},_.setAttribs(e,g),A.$(e).attr("alt",t.alt||""),u={href:t.linkUrl,rel:t.linkRel||null,target:t.linkTargetBlank?"_blank":null,"class":t.linkClassName||null},e.parentNode&&"A"===e.parentNode.nodeName&&!I(e.parentNode)?t.linkUrl?_.setAttribs(e.parentNode,u):_.remove(e.parentNode,!0):t.linkUrl&&((l=_.getParent(e,"a"))&&_.insertAfter(e,l),l=_.create("a",u),e.parentNode.insertBefore(l,e),l.appendChild(e));d=A.dom.getParent(e,".mceTemp"),i=e.parentNode&&"A"===e.parentNode.nodeName&&!I(e.parentNode)?e.parentNode:e;t.caption?(t.caption=function C(e){if(!e||-1===e.indexOf("<")&&-1===e.indexOf(">"))return e;P||(P=new tinymce.html.Serializer({},A.schema));return P.serialize(A.parser.parse(e,{forced_root_block:!1}))}(t.caption),p=t.attachment_id?"attachment_"+t.attachment_id:null,w="align"+(t.align||"none"),a="wp-caption "+w,t.captionClassName&&(a+=" "+t.captionClassName.replace(/[<>&]+/g,"")),A.getParam("wpeditimage_html5_captions")||(f=parseInt(f,10),f+=10),d?((m=_.select("dl.wp-caption",d)).length&&_.setAttribs(m,{id:p,"class":a,style:"width: "+f+"px"}),(s=_.select(".wp-caption-dd",d)).length&&_.setHTML(s[0],t.caption)):(o="<dl "+(p=p?'id="'+p+'" ':"")+'class="'+a+'" style="width: '+f+'px"><dt class="wp-caption-dt"></dt><dd class="wp-caption-dd">'+t.caption+"</dd></dl>",c=_.create("div",{"class":"mceTemp"},o),(r=_.getParent(i,"p"))?r.parentNode.insertBefore(c,r):i.parentNode.insertBefore(c,i),A.$(c).find("dt.wp-caption-dt").append(i),r&&_.isEmpty(r)&&_.remove(r))):d&&(r=_.create("p"),d.parentNode.insertBefore(r,d),r.appendChild(i),_.remove(d));N=A.$(e),v=N.attr("srcset"),b=N.attr("src"),v&&b&&(b=b.replace(/[?#].*/,""),-1===v.indexOf(b)&&N.attr("srcset",null).attr("sizes",null));wp.media.events&&wp.media.events.trigger("editor:image-update",{editor:A,metadata:t,image:e});A.nodeChanged()}(t,e)}),n.detach()},n.state("image-details").on("update",e),n.state("replace-image").on("replace",e),n.on("close",function(){A.focus(),n.detach()}),n.open()}(A.selection.getNode())}}),e({alignleft:"Align left",aligncenter:"Align center",alignright:"Align right",alignnone:"No alignment"},function(e,a){var t=a.slice(5);A.addButton("wp_img_"+a,{tooltip:e,icon:"dashicon dashicons-align-"+t,cmd:"alignnone"===a?"wpAlignNone":"Justify"+t.slice(0,1).toUpperCase()+t.slice(1),onPostRender:function(){var n=this;A.on("NodeChange",function(e){var t;"IMG"===e.element.nodeName&&(t=A.dom.getParent(e.element,".wp-caption")||e.element,"alignnone"===a?n.active(!/\balign(left|center|right)\b/.test(t.className)):n.active(A.dom.hasClass(t,a)))})}})}),A.once("preinit",function(){A.wp&&A.wp._createToolbar&&(d=A.wp._createToolbar(["wp_img_alignleft","wp_img_aligncenter","wp_img_alignright","wp_img_alignnone","wp_img_edit","wp_img_remove"]))}),A.on("wptoolbar",function(e){"IMG"!==e.element.nodeName||i(e.element)||(e.toolbar=d)}),t&&A.on("init",function(){A.on("touchstart",function(e){"IMG"!==e.target.nodeName||o(e.target)||(n=!0)}),A.dom.bind(A.getDoc(),"touchmove",function(){n=!1}),A.on("touchend",function(e){if(n&&"IMG"===e.target.nodeName&&!o(e.target)){var t=e.target;n=!1,window.setTimeout(function(){A.selection.select(t),A.nodeChanged()},100)}else d&&d.hide()})}),A.on("init",function(){var t=A.dom,e=A.getParam("wpeditimage_html5_captions")?"html5-captions":"html4-captions";t.addClass(A.getBody(),e),tinymce.Env.ie&&10<tinymce.Env.ie&&t.bind(A.getBody(),"mscontrolselect",function(e){"IMG"===e.target.nodeName&&t.getParent(e.target,".wp-caption")?A.getBody().focus():"DL"===e.target.nodeName&&t.hasClass(e.target,"wp-caption")&&e.target.focus()})}),A.on("ObjectResized",function(a){var i=a.target;"IMG"===i.nodeName&&A.undoManager.transact(function(){var e,t,n=A.dom;i.className=i.className.replace(/\bsize-[^ ]+/,""),(e=n.getParent(i,".wp-caption"))&&(t=a.width||n.getAttrib(i,"width"))&&(t=parseInt(t,10),A.getParam("wpeditimage_html5_captions")||(t+=10),n.setStyle(e,"width",t+"px"))})}),A.on("pastePostProcess",function(e){A.dom.getParent(A.selection.getNode(),"dd.wp-caption-dd")&&(A.$("img, audio, video, object, embed, iframe, script, style",e.node).remove(),A.$("*",e.node).each(function(e,t){A.dom.isBlock(t)&&(tinymce.trim(t.textContent||t.innerText)?(A.dom.insertAfter(A.dom.create("br"),t),A.dom.remove(t,!0)):A.dom.remove(t))}),A.$("br",e.node).each(function(e,t){t.nextSibling&&"BR"!==t.nextSibling.nodeName&&t.previousSibling&&"BR"!==t.previousSibling.nodeName||A.dom.remove(t)}),s=!0)}),A.on("BeforeExecCommand",function(e){var t,n,a,i,o,r,c=e.command,l=A.dom;if("mceInsertContent"===c||"Indent"===c||"Outdent"===c){if(t=A.selection.getNode(),r=l.getParent(t,"div.mceTemp")){if("mceInsertContent"!==c)return e.preventDefault(),e.stopImmediatePropagation(),!1;if(s)return void(s=!1);n=l.create("p"),l.insertAfter(n,r),A.selection.setCursorLocation(n,0),"IMG"===t.nodeName&&A.$(r).remove(),A.nodeChanged()}}else if("JustifyLeft"===c||"JustifyRight"===c||"JustifyCenter"===c||"wpAlignNone"===c){if(t=A.selection.getNode(),i="align"+c.slice(7).toLowerCase(),a=A.dom.getParent(t,".wp-caption"),"IMG"!==t.nodeName&&!a)return;t=a||t,o=A.dom.hasClass(t,i)?" alignnone":" "+i,t.className=m(t.className.replace(/ ?align(left|center|right|none)/g,"")+o),A.nodeChanged(),e.preventDefault(),d&&d.reposition(),A.fire("ExecCommand",{command:c,ui:e.ui,value:e.value})}}),A.on("keydown",function(e){var t,n,a,i,o=A.selection,r=e.keyCode,c=A.dom,l=tinymce.util.VK;if(r===l.ENTER)t=o.getNode(),(n=c.getParent(t,"div.mceTemp"))&&(c.events.cancel(e),tinymce.each(c.select("dt, dd",n),function(e){c.isEmpty(e)&&c.remove(e)}),i=tinymce.Env.ie&&tinymce.Env.ie<11?"":'<br data-mce-bogus="1" />',a=c.create("p",null,i),"DD"===t.nodeName?c.insertAfter(a,n):n.parentNode.insertBefore(a,n),A.nodeChanged(),o.setCursorLocation(a,0));else if((r===l.DELETE||r===l.BACKSPACE)&&("DIV"===(t=o.getNode()).nodeName&&c.hasClass(t,"mceTemp")?n=t:"IMG"!==t.nodeName&&"DT"!==t.nodeName&&"A"!==t.nodeName||(n=c.getParent(t,"div.mceTemp")),n))return c.events.cancel(e),p(t),!1}),tinymce.Env.gecko&&A.on("undo redo",function(){"IMG"===A.selection.getNode().nodeName&&A.selection.collapse()}),A.wpSetImgCaption=function(e){return r(e)},A.wpGetImgCaption=function(e){return c(e)},A.on("beforeGetContent",function(e){"raw"!==e.format&&A.$('img[id="__wp-temp-img-id"]').attr("id",null)}),A.on("BeforeSetContent",function(e){"raw"!==e.format&&(e.content=A.wpSetImgCaption(e.content))}),A.on("PostProcess",function(e){e.get&&(e.content=A.wpGetImgCaption(e.content))}),A.on("dragstart",function(){var e=A.selection.getNode();"IMG"===e.nodeName&&((a=A.dom.getParent(e,".mceTemp"))||"A"!==e.parentNode.nodeName||I(e.parentNode)||(a=e.parentNode))}),A.on("drop",function(e){var t=A.dom,n=tinymce.dom.RangeUtils.getCaretRangeFromPoint(e.clientX,e.clientY,A.getDoc());n&&t.getParent(n.startContainer,".mceTemp")?e.preventDefault():a&&(e.preventDefault(),A.undoManager.transact(function(){n&&A.selection.setRng(n),A.selection.setNode(a),t.remove(a)})),a=null}),A.wp=A.wp||{},A.wp.isPlaceholder=i,{_do_shcode:r,_get_shcode:c}});