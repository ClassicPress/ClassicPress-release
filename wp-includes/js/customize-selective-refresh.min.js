wp.customize.selectiveRefresh=function(e,t){"use strict";var n,r,a;return n={ready:e.Deferred(),editShortcutVisibility:new t.Value,data:{partials:{},renderQueryVar:"",l10n:{shiftClickToEdit:""}},currentRequest:null},_.extend(n,t.Events),r=n.Partial=t.Class.extend({id:null,defaults:{selector:null,primarySetting:null,containerInclusive:!1,fallbackRefresh:!0},initialize:function(t,n){var r=this;n=n||{},r.id=t,r.params=_.extend({settings:[]},r.defaults,n.params||n),r.deferred={},r.deferred.ready=e.Deferred(),r.deferred.ready.done((function(){r.ready()}))},ready:function(){var t=this;_.each(t.placements(),(function(r){e(r.container).attr("title",n.data.l10n.shiftClickToEdit),t.createEditShortcutForPlacement(r)})),e(document).on("click",t.params.selector,(function(n){n.shiftKey&&(n.preventDefault(),_.each(t.placements(),(function(r){e(r.container).is(n.currentTarget)&&t.showControl()})))}))},createEditShortcutForPlacement:function(t){var n,r,a=this;t.container&&("head","area, audio, base, bdi, bdo, br, button, canvas, col, colgroup, command, datalist, embed, head, hr, html, iframe, img, input, keygen, label, link, map, math, menu, meta, noscript, object, optgroup, option, param, progress, rp, rt, ruby, script, select, source, style, svg, table, tbody, textarea, tfoot, thead, title, tr, track, video, wbr",!(r=e(t.container)).length||r.is("area, audio, base, bdi, bdo, br, button, canvas, col, colgroup, command, datalist, embed, head, hr, html, iframe, img, input, keygen, label, link, map, math, menu, meta, noscript, object, optgroup, option, param, progress, rp, rt, ruby, script, select, source, style, svg, table, tbody, textarea, tfoot, thead, title, tr, track, video, wbr")||r.closest("head").length||((n=a.createEditShortcut()).on("click",(function(e){e.preventDefault(),e.stopPropagation(),a.showControl()})),a.addEditShortcutToPlacement(t,n)))},addEditShortcutToPlacement:function(t,n){var r=e(t.container);r.prepend(n),r.is(":visible")&&"none"!==r.css("display")||n.addClass("customize-partial-edit-shortcut-hidden")},getEditShortcutClassName:function(){return"customize-partial-edit-shortcut-"+this.id.replace(/]/g,"").replace(/\[/g,"-")},getEditShortcutTitle:function(){var e=n.data.l10n;switch(this.getType()){case"widget":return e.clickEditWidget;case"blogname":case"blogdescription":return e.clickEditTitle;case"nav_menu":return e.clickEditMenu;default:return e.clickEditMisc}},getType:function(){var e,t=this;return e=t.params.primarySetting||_.first(t.settings())||"unknown",t.params.type?t.params.type:e.match(/^nav_menu_instance\[/)?"nav_menu":e.match(/^widget_.+\[\d+]$/)?"widget":e},createEditShortcut:function(){var t,n,r,a;return t=this.getEditShortcutTitle(),n=e("<span>",{"class":"customize-partial-edit-shortcut "+this.getEditShortcutClassName()}),r=e("<button>",{"aria-label":t,title:t,"class":"customize-partial-edit-shortcut-button"}),a=e('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M13.89 3.39l2.71 2.72c.46.46.42 1.24.03 1.64l-8.01 8.02-5.56 1.16 1.16-5.58s7.6-7.63 7.99-8.03c.39-.39 1.22-.39 1.68.07zm-2.73 2.79l-5.59 5.61 1.11 1.11 5.54-5.65zm-2.97 8.23l5.58-5.6-1.07-1.08-5.59 5.6z"/></svg>'),r.append(a),n.append(r),n},placements:function(){var t,n=this;return(t=n.params.selector||"")&&(t+=", "),t+='[data-customize-partial-id="'+n.id+'"]',e(t).map((function(){var t,r=e(this);if(t=r.data("customize-partial-placement-context"),_.isString(t)&&"{"===t.substr(0,1))throw new Error("context JSON parse error");return new a({partial:n,container:r,context:t})})).get()},settings:function(){var e=this;return e.params.settings&&0!==e.params.settings.length?e.params.settings:e.params.primarySetting?[e.params.primarySetting]:[e.id]},isRelatedSetting:function(e){return _.isString(e)&&(e=t(e)),!!e&&-1!==_.indexOf(this.settings(),e.id)},showControl:function(){var e=this,n=e.params.primarySetting;n||(n=_.first(e.settings())),"nav_menu"===e.getType()&&(e.params.navMenuArgs.theme_location?n="nav_menu_locations["+e.params.navMenuArgs.theme_location+"]":e.params.navMenuArgs.menu&&(n="nav_menu["+String(e.params.navMenuArgs.menu)+"]")),t.preview.send("focus-control-for-setting",n)},preparePlacement:function(t){e(t.container).addClass("customize-partial-refreshing")},_pendingRefreshPromise:null,refresh:function(){var e,t=this;return e=n.requestPartial(t),t._pendingRefreshPromise||(_.each(t.placements(),(function(e){t.preparePlacement(e)})),e.done((function(e){_.each(e,(function(e){t.renderContent(e)}))})),e.fail((function(e,n){t.fallback(e,n)})),t._pendingRefreshPromise=e,e.always((function(){t._pendingRefreshPromise=null}))),e},renderContent:function(t){var r,a,i=this;if(!t.container)return i.fallback(new Error("no_container"),[t]),!1;if(t.container=e(t.container),!1===t.addedContent)return i.fallback(new Error("missing_render"),[t]),!1;if(!_.isString(t.addedContent))return i.fallback(new Error("non_string_content"),[t]),!1;n.orginalDocumentWrite=document.write,document.write=function(){throw new Error(n.data.l10n.badDocumentWrite)};try{if(r=t.addedContent,wp.emoji&&wp.emoji.parse&&!e.contains(document.head,t.container[0])&&(r=wp.emoji.parse(r)),i.params.containerInclusive)a=e(r),t.context=_.extend(t.context,a.data("customize-partial-placement-context")||{}),a.data("customize-partial-placement-context",t.context),t.removedNodes=t.container,t.container=a,t.removedNodes.replaceWith(t.container),t.container.attr("title",n.data.l10n.shiftClickToEdit);else{for(t.removedNodes=document.createDocumentFragment();t.container[0].firstChild;)t.removedNodes.appendChild(t.container[0].firstChild);t.container.html(r)}t.container.removeClass("customize-render-content-error")}catch(o){"undefined"!=typeof console&&console.error&&console.error(i.id,o),i.fallback(o,[t])}return document.write=n.orginalDocumentWrite,n.orginalDocumentWrite=null,i.createEditShortcutForPlacement(t),t.container.removeClass("customize-partial-refreshing"),t.container.data("customize-partial-content-rendered",!0),wp.mediaelement&&wp.mediaelement.initialize(),wp.playlist&&wp.playlist.initialize(),n.trigger("partial-content-rendered",t),!0},fallback:function(){this.params.fallbackRefresh&&n.requestFullRefresh()}}),n.Placement=a=t.Class.extend({partial:null,container:null,startNode:null,endNode:null,context:null,addedContent:null,removedNodes:null,initialize:function(t){if(!(t=_.extend({},t||{})).partial||!t.partial.extended(r))throw new Error("Missing partial");t.context=t.context||{},t.container&&(t.container=e(t.container)),_.extend(this,t)}}),n.partialConstructor={},n.partial=new t.Values({defaultConstructor:r}),n.getCustomizeQuery=function(){var e={};return t.each((function(t,n){t._dirty&&(e[n]=t())})),{wp_customize:"on",nonce:t.settings.nonce.preview,customize_theme:t.settings.theme.stylesheet,customized:JSON.stringify(e),customize_changeset_uuid:t.settings.changeset.uuid}},n._pendingPartialRequests={},n._debouncedTimeoutId=null,n._currentRequest=null,n.requestFullRefresh=function(){t.preview.send("refresh")},n.requestPartial=function(r){var i;return n._debouncedTimeoutId&&(clearTimeout(n._debouncedTimeoutId),n._debouncedTimeoutId=null),n._currentRequest&&(n._currentRequest.abort(),n._currentRequest=null),(i=n._pendingPartialRequests[r.id])&&"pending"===i.deferred.state()||(i={deferred:e.Deferred(),partial:r},n._pendingPartialRequests[r.id]=i),r=null,n._debouncedTimeoutId=setTimeout((function(){var e,r,i,o;n._debouncedTimeoutId=null,e=n.getCustomizeQuery(),i={},r={},_.each(n._pendingPartialRequests,(function(e,t){i[t]=e.partial.placements(),n.partial.has(t)?r[t]=_.map(i[t],(function(e){return e.context||{}})):e.deferred.rejectWith(e.partial,[new Error("partial_removed"),i[t]])})),e.partials=JSON.stringify(r),e[n.data.renderQueryVar]="1",(o=n._currentRequest=wp.ajax.send(null,{data:e,url:t.settings.url.self})).done((function(e){n.trigger("render-partials-response",e),e.errors&&"undefined"!=typeof console&&console.warn&&_.each(e.errors,(function(e){console.warn(e)})),_.each(n._pendingPartialRequests,(function(t,n){var r;_.isArray(e.contents[n])?(r=_.map(e.contents[n],(function(e,r){var o=i[n][r];return o?o.addedContent=e:o=new a({partial:t.partial,addedContent:e}),o})),t.deferred.resolveWith(t.partial,[r])):t.deferred.rejectWith(t.partial,[new Error("unrecognized_partial"),i[n]])})),n._pendingPartialRequests={}})),o.fail((function(e,t){"abort"!==t&&(_.each(n._pendingPartialRequests,(function(t,n){t.deferred.rejectWith(t.partial,[e,i[n]])})),n._pendingPartialRequests={})}))}),t.settings.timeouts.selectiveRefresh),i.deferred.promise()},n.addPartials=function(t,r){var i;t||(t=document.documentElement),t=e(t),r=_.extend({triggerRendered:!0},r||{}),i=t.find("[data-customize-partial-id]"),t.is("[data-customize-partial-id]")&&(i=i.add(t)),i.each((function(){var t,i,o,s,c,d=e(this);(o=d.data("customize-partial-id"))&&(c=d.data("customize-partial-placement-context")||{},(t=n.partial(o))||((s=d.data("customize-partial-options")||{}).constructingContainerContext=d.data("customize-partial-placement-context")||{},t=new(n.partialConstructor[d.data("customize-partial-type")]||n.Partial)(o,s),n.partial.add(t)),r.triggerRendered&&!d.data("customize-partial-content-rendered")&&(i=new a({partial:t,context:c,container:d}),e(i.container).attr("title",n.data.l10n.shiftClickToEdit),t.createEditShortcutForPlacement(i),n.trigger("partial-content-rendered",i)),d.data("customize-partial-content-rendered",!0))}))},t.bind("preview-ready",(function(){var r,a,i;_.extend(n.data,_customizePartialRefreshExports),_.each(n.data.partials,(function(e,t){var r=n.partial(t);r?_.extend(r.params,e):(r=new(n.partialConstructor[e.type]||n.Partial)(t,_.extend({params:e},e)),n.partial.add(r))})),r=function(e,t){var r=this;n.partial.each((function(n){n.isRelatedSetting(r,e,t)&&n.refresh()}))},a=function(e){r.call(e,e(),null),e.bind(r)},i=function(e){r.call(e,null,e()),e.unbind(r)},t.bind("add",a),t.bind("remove",i),t.each((function(e){e.bind(r)})),n.addPartials(document.documentElement,{triggerRendered:!1}),"undefined"!=typeof MutationObserver&&(n.mutationObserver=new MutationObserver((function(t){_.each(t,(function(t){n.addPartials(e(t.target))}))})),n.mutationObserver.observe(document.documentElement,{childList:!0,subtree:!0})),t.selectiveRefresh.bind("partial-content-rendered",(function(e){e.container&&n.addPartials(e.container)})),t.selectiveRefresh.bind("render-partials-response",(function(e){e.setting_validities&&t.preview.send("selective-refresh-setting-validities",e.setting_validities)})),t.preview.bind("edit-shortcut-visibility",(function(e){t.selectiveRefresh.editShortcutVisibility.set(e)})),t.selectiveRefresh.editShortcutVisibility.bind((function(t){var n,r=e(document.body);n="hidden"===t&&r.hasClass("customize-partial-edit-shortcuts-shown")&&!r.hasClass("customize-partial-edit-shortcuts-hidden"),r.toggleClass("customize-partial-edit-shortcuts-hidden",n),r.toggleClass("customize-partial-edit-shortcuts-shown","visible"===t)})),t.preview.bind("active",(function(){n.partial.each((function(e){e.deferred.ready.resolve()})),n.partial.bind("add",(function(e){e.deferred.ready.resolve()}))}))})),n}(jQuery,wp.customize);