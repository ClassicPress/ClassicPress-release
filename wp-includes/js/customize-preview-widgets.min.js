wp.customize.widgetsPreview=wp.customize.WidgetCustomizerPreview=function(e,t,i,r){var n;return(n={renderedSidebars:{},renderedWidgets:{},registeredSidebars:[],registeredWidgets:{},widgetSelectors:[],preview:null,l10n:{widgetTooltip:""},selectiveRefreshableWidgets:{}}).init=function(){var e=this;e.preview=r.preview,t.isEmpty(e.selectiveRefreshableWidgets)||e.addPartials(),e.buildWidgetSelectors(),e.highlightControls(),e.preview.bind("highlight-widget",e.highlightWidget),r.preview.bind("active",(function(){e.highlightControls()})),r.preview.bind("refresh-widget-partial",(function(t){var i="widget["+t+"]";r.selectiveRefresh.partial.has(i)?r.selectiveRefresh.partial(i).refresh():e.renderedWidgets[t]&&r.preview.send("refresh")}))},n.WidgetPartial=r.selectiveRefresh.Partial.extend({initialize:function(e,i){var a,d=this;if(!(a=e.match(/^widget\[(.+)]$/)))throw new Error("Illegal id for widget partial.");d.widgetId=a[1],d.widgetIdParts=n.parseWidgetId(d.widgetId),(i=i||{}).params=t.extend({settings:[n.getWidgetSettingId(d.widgetId)],containerInclusive:!0},i.params||{}),r.selectiveRefresh.Partial.prototype.initialize.call(d,e,i)},refresh:function(){var t,i=this;return n.selectiveRefreshableWidgets[i.widgetIdParts.idBase]?r.selectiveRefresh.Partial.prototype.refresh.call(i):((t=e.Deferred()).reject(),i.fallback(),t.promise())},renderContent:function(e){var t=this;r.selectiveRefresh.Partial.prototype.renderContent.call(t,e)&&(r.preview.send("widget-updated",t.widgetId),r.selectiveRefresh.trigger("widget-updated",t))}}),n.SidebarPartial=r.selectiveRefresh.Partial.extend({initialize:function(e,i){var n,a=this;if(!(n=e.match(/^sidebar\[(.+)]$/)))throw new Error("Illegal id for sidebar partial.");if(a.sidebarId=n[1],(i=i||{}).params=t.extend({settings:["sidebars_widgets["+a.sidebarId+"]"]},i.params||{}),r.selectiveRefresh.Partial.prototype.initialize.call(a,e,i),!a.params.sidebarArgs)throw new Error("The sidebarArgs param was not provided.");if(a.params.settings.length>1)throw new Error("Expected SidebarPartial to only have one associated setting")},ready:function(){var e=this;t.each(e.settings(),(function(i){r(i).bind(t.bind(e.handleSettingChange,e))})),r.selectiveRefresh.bind("partial-content-rendered",(function(i){i.partial.extended(n.WidgetPartial)&&-1!==t.indexOf(e.getWidgetIds(),i.partial.widgetId)&&r.selectiveRefresh.trigger("sidebar-updated",e)})),r.bind("change",(function(i){var r,a;(a=n.parseWidgetSettingId(i.id))&&(r=a.idBase,a.number&&(r+="-"+String(a.number)),-1!==t.indexOf(e.getWidgetIds(),r)&&e.ensureWidgetPlacementContainers(r))}))},findDynamicSidebarBoundaryNodes:function(){var e,i,r=this,n={};return e=/^(dynamic_sidebar_before|dynamic_sidebar_after):(.+):(\d+)$/,(i=function(a){t.each(a,(function(a){var d;if(8===a.nodeType){if(!(d=a.nodeValue.match(e))||d[2]!==r.sidebarId)return;t.isUndefined(n[d[3]])&&(n[d[3]]={before:null,after:null,instanceNumber:parseInt(d[3],10)}),"dynamic_sidebar_before"===d[1]?n[d[3]].before=a:n[d[3]].after=a}else 1===a.nodeType&&i(a.childNodes)}))})(document.body.childNodes),t.values(n)},placements:function(){var e=this;return t.map(e.findDynamicSidebarBoundaryNodes(),(function(t){return new r.selectiveRefresh.Placement({partial:e,container:null,startNode:t.before,endNode:t.after,context:{instanceNumber:t.instanceNumber}})}))},getWidgetIds:function(){var e,i;if(!(e=this.settings()[0]))throw new Error("Missing associated setting.");if(!r.has(e))throw new Error("Setting does not exist.");if(i=r(e).get(),!t.isArray(i))throw new Error("Expected setting to be array of widget IDs");return i.slice(0)},reflowWidgets:function(){var e,i,n,a=this,d=[];return i=a.getWidgetIds(),e=a.placements(),n={},t.each(i,(function(e){var t=r.selectiveRefresh.partial("widget["+e+"]");t&&(n[e]=t)})),t.each(e,(function(e){var i,a=[],s=!1,o=-1;t.each(n,(function(r){t.each(r.placements(),(function(t){e.context.instanceNumber===t.context.sidebar_instance_number&&(i=t.container.index(),a.push({partial:r,placement:t,position:i}),i<o&&(s=!0),o=i)}))})),s&&(t.each(a,(function(t){e.endNode.parentNode.insertBefore(t.placement.container[0],e.endNode),r.selectiveRefresh.trigger("partial-content-moved",t.placement)})),d.push(e))})),d.length>0&&r.selectiveRefresh.trigger("sidebar-updated",a),d},ensureWidgetPlacementContainers:function(i){var a,d=this,s=!1,o="widget["+i+"]";return(a=r.selectiveRefresh.partial(o))||(a=new n.WidgetPartial(o,{params:{}})),t.each(d.placements(),(function(r){var n;t.find(a.placements(),(function(e){return e.context.sidebar_instance_number===r.context.instanceNumber}))||(n=e(d.params.sidebarArgs.before_widget.replace(/%1\$s/g,i).replace(/%2\$s/g,"widget")+d.params.sidebarArgs.after_widget))[0]&&(n.attr("data-customize-partial-id",a.id),n.attr("data-customize-partial-type","widget"),n.attr("data-customize-widget-id",i),n.data("customize-partial-placement-context",{sidebar_id:d.sidebarId,sidebar_instance_number:r.context.instanceNumber}),r.endNode.parentNode.insertBefore(n[0],r.endNode),s=!0)})),r.selectiveRefresh.partial.add(a),s&&d.reflowWidgets(),a},handleSettingChange:function(e,i){var a,d,s=this,o=[];i.length>0&&0===e.length||e.length>0&&0===i.length?s.fallback():(a=t.difference(i,e),t.each(a,(function(e){var i=r.selectiveRefresh.partial("widget["+e+"]");i&&t.each(i.placements(),(function(e){(e.context.sidebar_id===s.sidebarId||e.context.sidebar_args&&e.context.sidebar_args.id===s.sidebarId)&&e.container.remove()})),delete n.renderedWidgets[e]})),d=t.difference(e,i),t.each(d,(function(e){var t=s.ensureWidgetPlacementContainers(e);o.push(t),n.renderedWidgets[e]=!0})),t.each(o,(function(e){e.refresh()})),r.selectiveRefresh.trigger("sidebar-updated",s))},refresh:function(){var i=this,n=e.Deferred();return n.fail((function(){i.fallback()})),0===i.placements().length?n.reject():(t.each(i.reflowWidgets(),(function(e){r.selectiveRefresh.trigger("partial-content-rendered",e)})),n.resolve()),n.promise()}}),r.selectiveRefresh.partialConstructor.sidebar=n.SidebarPartial,r.selectiveRefresh.partialConstructor.widget=n.WidgetPartial,n.addPartials=function(){t.each(n.registeredSidebars,(function(e){var t,i="sidebar["+e.id+"]";(t=r.selectiveRefresh.partial(i))||(t=new n.SidebarPartial(i,{params:{sidebarArgs:e}}),r.selectiveRefresh.partial.add(t))}))},n.buildWidgetSelectors=function(){var t=this;e.each(t.registeredSidebars,(function(i,r){var n,a,d,s=[r.before_widget,r.before_title,r.after_title,r.after_widget].join("");a=(n=e(s)).prop("tagName")||"",(d=n.prop("className")||"")&&((d=(d=d.replace(/\S*%[12]\$s\S*/g,"")).replace(/^\s+|\s+$/g,""))&&(a+="."+d.split(/\s+/).join(".")),t.widgetSelectors.push(a))}))},n.highlightWidget=function(t){var i=e(document.body),r=e("#"+t);i.find(".widget-customizer-highlighted-widget").removeClass("widget-customizer-highlighted-widget"),r.addClass("widget-customizer-highlighted-widget"),setTimeout((function(){r.removeClass("widget-customizer-highlighted-widget")}),500)},n.highlightControls=function(){var t=this,i=this.widgetSelectors.join(",");r.settings.channel&&(e(i).attr("title",this.l10n.widgetTooltip),e(document).on("mouseenter",i,(function(){t.preview.send("highlight-widget-control",e(this).prop("id"))})),e(document).on("click",i,(function(i){i.shiftKey&&(i.preventDefault(),t.preview.send("focus-widget-control",e(this).prop("id")))})))},n.parseWidgetId=function(e){var t,i={idBase:"",number:null};return(t=e.match(/^(.+)-(\d+)$/))?(i.idBase=t[1],i.number=parseInt(t[2],10)):i.idBase=e,i},n.parseWidgetSettingId=function(e){var t,i={idBase:"",number:null};return(t=e.match(/^widget_([^\[]+?)(?:\[(\d+)])?$/))?(i.idBase=t[1],t[2]&&(i.number=parseInt(t[2],10)),i):null},n.getWidgetSettingId=function(e){var t,i=this.parseWidgetId(e);return t="widget_"+i.idBase,i.number&&(t+="["+String(i.number)+"]"),t},r.bind("preview-ready",(function(){e.extend(n,_wpWidgetCustomizerPreviewSettings),n.init()})),n}(jQuery,_,wp,wp.customize);