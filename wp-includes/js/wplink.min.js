var wpLink;!function(c,u,h){var s,e,t,n,i,l,o=/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,63}$/i,p=/^(https?|ftp):\/\/[A-Z0-9.-]+\.[A-Z]{2,63}[^ "]*$/i,d={},a={},r="ontouchend"in document;function k(){return l||s.dom.getParent(s.selection.getNode(),"a[href]")}wpLink={timeToTriggerRiver:150,minRiverAJAXDuration:200,riverBottomThreshold:5,keySensitivity:100,lastSearch:"",textarea:"",modalOpen:!1,init:function(){d.wrap=c("#wp-link-wrap"),d.dialog=c("#wp-link"),d.backdrop=c("#wp-link-backdrop"),d.submit=c("#wp-link-submit"),d.close=c("#wp-link-close"),d.text=c("#wp-link-text"),d.url=c("#wp-link-url"),d.nonce=c("#_ajax_linking_nonce"),d.openInNewTab=c("#wp-link-target"),d.search=c("#wp-link-search"),a.search=new t(c("#search-results")),a.recent=new t(c("#most-recent-results")),a.elements=d.dialog.find(".query-results"),d.queryNotice=c("#query-notice-message"),d.queryNoticeTextDefault=d.queryNotice.find(".query-notice-default"),d.queryNoticeTextHint=d.queryNotice.find(".query-notice-hint"),d.dialog.keydown(wpLink.keydown),d.dialog.keyup(wpLink.keyup),d.submit.click(function(e){e.preventDefault(),wpLink.update()}),d.close.add(d.backdrop).add("#wp-link-cancel button").click(function(e){e.preventDefault(),wpLink.close()}),a.elements.on("river-select",wpLink.updateFields),d.search.on("focus.wplink",function(){d.queryNoticeTextDefault.hide(),d.queryNoticeTextHint.removeClass("screen-reader-text").show()}).on("blur.wplink",function(){d.queryNoticeTextDefault.show(),d.queryNoticeTextHint.addClass("screen-reader-text").hide()}),d.search.on("keyup input",function(){window.clearTimeout(e),e=window.setTimeout(function(){wpLink.searchInternalLinks()},500)}),d.url.on("paste",function(){setTimeout(wpLink.correctURL,0)}),d.url.on("blur",wpLink.correctURL)},correctURL:function(){var e=c.trim(d.url.val());e&&i!==e&&!/^(?:[a-z]+:|#|\?|\.|\/)/.test(e)&&(d.url.val("http://"+e),i=e)},open:function(e,t,n,i){var a,r=c(document.body);r.addClass("modal-open"),wpLink.modalOpen=!0,l=i,wpLink.range=null,e&&(window.wpActiveEditor=e),window.wpActiveEditor&&(this.textarea=c("#"+window.wpActiveEditor).get(0),"undefined"!=typeof window.tinymce&&(r.append(d.backdrop,d.wrap),a=window.tinymce.get(window.wpActiveEditor),s=a&&!a.isHidden()?a:null),!wpLink.isMCE()&&document.selection&&(this.textarea.focus(),this.range=document.selection.createRange()),d.wrap.show(),d.backdrop.show(),wpLink.refresh(t,n),c(document).trigger("wplink-open",d.wrap))},isMCE:function(){return s&&!s.isHidden()},refresh:function(e,t){a.search.refresh(),a.recent.refresh(),wpLink.isMCE()?wpLink.mceRefresh(e,t):(d.wrap.hasClass("has-text-field")||d.wrap.addClass("has-text-field"),document.selection?document.selection.createRange().text||t||"":"undefined"!=typeof this.textarea.selectionStart&&this.textarea.selectionStart!==this.textarea.selectionEnd&&(t=this.textarea.value.substring(this.textarea.selectionStart,this.textarea.selectionEnd)||t||""),d.text.val(t),wpLink.setDefaultValues()),r?d.url.focus().blur():window.setTimeout(function(){d.url[0].select(),d.url.focus()}),a.recent.ul.children().length||a.recent.ajax(),i=d.url.val().replace(/^http:\/\//,"")},hasSelectedText:function(e){var t,n,i,a=s.selection.getContent();if(/</.test(a)&&(!/^<a [^>]+>[^<]+<\/a>$/.test(a)||-1===a.indexOf("href=")))return!1;if(e){if(0===(n=e.childNodes).length)return!1;for(i=n.length-1;0<=i;i--)if(3!=(t=n[i]).nodeType&&!window.tinymce.dom.BookmarkManager.isBookmarkNode(t))return!1}return!0},mceRefresh:function(e,t){var n,i,a=k(),r=this.hasSelectedText(a);a?(n=a.textContent||a.innerText,i=s.dom.getAttrib(a,"href"),c.trim(n)||(n=t||""),e&&(p.test(e)||o.test(e))&&(i=e),"_wp_link_placeholder"!==i?(d.url.val(i),d.openInNewTab.prop("checked","_blank"===s.dom.getAttrib(a,"target")),d.submit.val(u.update)):this.setDefaultValues(n),e&&e!==i?d.search.val(e):d.search.val(""),window.setTimeout(function(){wpLink.searchInternalLinks()})):(n=s.selection.getContent({format:"text"})||t||"",this.setDefaultValues(n)),r?(d.text.val(n),d.wrap.addClass("has-text-field")):(d.text.val(""),d.wrap.removeClass("has-text-field"))},close:function(e){c(document.body).removeClass("modal-open"),wpLink.modalOpen=!1,"noReset"!==e&&(wpLink.isMCE()?(s.plugins.wplink&&s.plugins.wplink.close(),s.focus()):(wpLink.textarea.focus(),wpLink.range&&(wpLink.range.moveToBookmark(wpLink.range.getBookmark()),wpLink.range.select()))),d.backdrop.hide(),d.wrap.hide(),i=!1,c(document).trigger("wplink-close",d.wrap)},getAttrs:function(){return wpLink.correctURL(),{href:c.trim(d.url.val()),target:d.openInNewTab.prop("checked")?"_blank":null}},buildHtml:function(e){var t='<a href="'+e.href+'"';return e.target&&(t+=' rel="noopener" target="'+e.target+'"'),t+">"},update:function(){wpLink.isMCE()?wpLink.mceUpdate():wpLink.htmlUpdate()},htmlUpdate:function(){var e,t,n,i,a,r,s,l=wpLink.textarea;if(l){e=wpLink.getAttrs(),t=d.text.val();var o=document.createElement("a");o.href=e.href,"javascript:"!==o.protocol&&"data:"!==o.protocol||(e.href=""),e.href&&(n=wpLink.buildHtml(e),document.selection&&wpLink.range?(l.focus(),wpLink.range.text=n+(t||wpLink.range.text)+"</a>",wpLink.range.moveToBookmark(wpLink.range.getBookmark()),wpLink.range.select(),wpLink.range=null):"undefined"!=typeof l.selectionStart&&(i=l.selectionStart,a=l.selectionEnd,r=i+(n=n+(s=t||l.value.substring(i,a))+"</a>").length,i!==a||s||(r-=4),l.value=l.value.substring(0,i)+n+l.value.substring(a,l.value.length),l.selectionStart=l.selectionEnd=r),wpLink.close(),l.focus(),c(l).trigger("change"),h.a11y.speak(u.linkInserted))}},mceUpdate:function(){var e,t,n,i,a=wpLink.getAttrs(),r=document.createElement("a");if(r.href=a.href,"javascript:"!==r.protocol&&"data:"!==r.protocol||(a.href=""),!a.href)return s.execCommand("unlink"),void wpLink.close();e=s.$(k()),s.undoManager.transact(function(){e.length||(s.execCommand("mceInsertLink",!1,{href:"_wp_link_placeholder","data-wp-temp-link":1}),e=s.$('a[data-wp-temp-link="1"]').removeAttr("data-wp-temp-link"),n=c.trim(e.text())),e.length?(d.wrap.hasClass("has-text-field")&&((t=d.text.val())?e.text(t):n||e.text(a.href)),a["data-wplink-edit"]=null,a["data-mce-href"]=null,e.attr(a)):s.execCommand("unlink")}),wpLink.close("noReset"),s.focus(),e.length&&((i=e.parent("#_mce_caret")).length&&i.before(e.removeAttr("data-mce-bogus")),s.selection.select(e[0]),s.selection.collapse(),s.plugins.wplink&&s.plugins.wplink.checkLink(e[0])),s.nodeChanged(),h.a11y.speak(u.linkInserted)},updateFields:function(e,t){d.url.val(t.children(".item-permalink").val())},getUrlFromSelection:function(e){return e||(this.isMCE()?e=s.selection.getContent({format:"text"}):document.selection&&wpLink.range?e=wpLink.range.text:"undefined"!=typeof this.textarea.selectionStart&&(e=this.textarea.value.substring(this.textarea.selectionStart,this.textarea.selectionEnd))),(e=c.trim(e))&&o.test(e)?"mailto:"+e:e&&p.test(e)?e.replace(/&amp;|&#0?38;/gi,"&"):""},setDefaultValues:function(e){d.url.val(this.getUrlFromSelection(e)),d.search.val(""),wpLink.searchInternalLinks(),d.submit.val(u.save)},searchInternalLinks:function(){var e,t=d.search.val()||"";if(2<t.length){if(a.recent.hide(),a.search.show(),wpLink.lastSearch==t)return;wpLink.lastSearch=t,e=d.search.parent().find(".spinner").addClass("is-active"),a.search.change(t),a.search.ajax(function(){e.removeClass("is-active")})}else a.search.hide(),a.recent.show()},next:function(){a.search.next(),a.recent.next()},prev:function(){a.search.prev(),a.recent.prev()},keydown:function(e){var t,n;27===e.keyCode?(wpLink.close(),e.stopImmediatePropagation()):9===e.keyCode&&("wp-link-submit"!==(n=e.target.id)||e.shiftKey?"wp-link-close"===n&&e.shiftKey&&(d.submit.focus(),e.preventDefault()):(d.close.focus(),e.preventDefault())),38!==e.keyCode&&40!==e.keyCode||(!document.activeElement||"link-title-field"!==document.activeElement.id&&"url-field"!==document.activeElement.id)&&(t=38===e.keyCode?"prev":"next",clearInterval(wpLink.keyInterval),wpLink[t](),wpLink.keyInterval=setInterval(wpLink[t],wpLink.keySensitivity),e.preventDefault())},keyup:function(e){38!==e.keyCode&&40!==e.keyCode||(clearInterval(wpLink.keyInterval),e.preventDefault())},delayedCallback:function(e,t){var n,i,a,r;return t?(setTimeout(function(){if(i)return e.apply(r,a);n=!0},t),function(){if(n)return e.apply(this,arguments);a=arguments,r=this,i=!0}):e}},t=function(e,t){var n=this;this.element=e,this.ul=e.children("ul"),this.contentHeight=e.children("#link-selector-height"),this.waiting=e.find(".river-waiting"),this.change(t),this.refresh(),c("#wp-link .query-results, #wp-link #link-selector").scroll(function(){n.maybeLoad()}),e.on("click","li",function(e){n.select(c(this),e)})},c.extend(t.prototype,{refresh:function(){this.deselect(),this.visible=this.element.is(":visible")},show:function(){this.visible||(this.deselect(),this.element.show(),this.visible=!0)},hide:function(){this.element.hide(),this.visible=!1},select:function(e,t){var n,i,a,r;e.hasClass("unselectable")||e==this.selected||(this.deselect(),this.selected=e.addClass("selected"),n=e.outerHeight(),i=this.element.height(),a=e.position().top,r=this.element.scrollTop(),a<0?this.element.scrollTop(r+a):i<a+n&&this.element.scrollTop(r+a-i+n),this.element.trigger("river-select",[e,t,this]))},deselect:function(){this.selected&&this.selected.removeClass("selected"),this.selected=!1},prev:function(){var e;this.visible&&(this.selected&&(e=this.selected.prev("li")).length&&this.select(e))},next:function(){if(this.visible){var e=this.selected?this.selected.next("li"):c("li:not(.unselectable):first",this.element);e.length&&this.select(e)}},ajax:function(n){var i=this,e=1==this.query.page?0:wpLink.minRiverAJAXDuration,t=wpLink.delayedCallback(function(e,t){i.process(e,t),n&&n(e,t)},e);this.query.ajax(t)},change:function(e){this.query&&this._search==e||(this._search=e,this.query=new n(e),this.element.scrollTop(0))},process:function(e,t){var n="",i=!0,a="",r=1==t.page;e?c.each(e,function(){a=i?"alternate":"",a+=this.title?"":" no-title",n+=a?'<li class="'+a+'">':"<li>",n+='<input type="hidden" class="item-permalink" value="'+this.permalink+'" />',n+='<span class="item-title">',n+=this.title?this.title:u.noTitle,n+='</span><span class="item-info">'+this.info+"</span></li>",i=!i}):r&&(n+='<li class="unselectable no-matches-found"><span class="item-title"><em>'+u.noMatchesFound+"</em></span></li>"),this.ul[r?"html":"append"](n)},maybeLoad:function(){var n=this,i=this.element,e=i.scrollTop()+i.height();!this.query.ready()||e<this.contentHeight.height()-wpLink.riverBottomThreshold||setTimeout(function(){var e=i.scrollTop(),t=e+i.height();!n.query.ready()||t<n.contentHeight.height()-wpLink.riverBottomThreshold||(n.waiting.addClass("is-active"),i.scrollTop(e+n.waiting.outerHeight()),n.ajax(function(){n.waiting.removeClass("is-active")}))},wpLink.timeToTriggerRiver)}}),n=function(e){this.page=1,this.allLoaded=!1,this.querying=!1,this.search=e},c.extend(n.prototype,{ready:function(){return!(this.querying||this.allLoaded)},ajax:function(t){var n=this,i={action:"wp-link-ajax",page:this.page,_ajax_linking_nonce:d.nonce.val()};this.search&&(i.search=this.search),this.querying=!0,c.post(window.ajaxurl,i,function(e){n.page++,n.querying=!1,n.allLoaded=!e,t(e,i)},"json")}}),c(document).ready(wpLink.init)}(jQuery,window.wpLinkL10n,window.wp);