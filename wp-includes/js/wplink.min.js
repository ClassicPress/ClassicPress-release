!function(e,t,n){var i,a,r,s,l,o=/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,63}$/i,c=/^(https?|ftp):\/\/[A-Z0-9.-]+\.[A-Z]{2,63}[^ "]*$/i,u={},h={},p="ontouchend"in document;function d(){return i?i.$('a[data-wplink-edit="true"]'):null}window.wpLink={timeToTriggerRiver:150,minRiverAJAXDuration:200,riverBottomThreshold:5,keySensitivity:100,lastSearch:"",textarea:"",modalOpen:!1,init:function(){u.wrap=e("#wp-link-wrap"),u.dialog=e("#wp-link"),u.backdrop=e("#wp-link-backdrop"),u.submit=e("#wp-link-submit"),u.close=e("#wp-link-close"),u.text=e("#wp-link-text"),u.url=e("#wp-link-url"),u.nonce=e("#_ajax_linking_nonce"),u.openInNewTab=e("#wp-link-target"),u.search=e("#wp-link-search"),h.search=new r(e("#search-results")),h.recent=new r(e("#most-recent-results")),h.elements=u.dialog.find(".query-results"),u.queryNotice=e("#query-notice-message"),u.queryNoticeTextDefault=u.queryNotice.find(".query-notice-default"),u.queryNoticeTextHint=u.queryNotice.find(".query-notice-hint"),u.dialog.on("keydown",wpLink.keydown),u.dialog.on("keyup",wpLink.keyup),u.submit.on("click",(function(e){e.preventDefault(),wpLink.update()})),u.close.add(u.backdrop).add("#wp-link-cancel button").on("click",(function(e){e.preventDefault(),wpLink.close()})),h.elements.on("river-select",wpLink.updateFields),u.search.on("focus.wplink",(function(){u.queryNoticeTextDefault.hide(),u.queryNoticeTextHint.removeClass("screen-reader-text").show()})).on("blur.wplink",(function(){u.queryNoticeTextDefault.show(),u.queryNoticeTextHint.addClass("screen-reader-text").hide()})),u.search.on("keyup input",(function(){window.clearTimeout(a),a=window.setTimeout((function(){wpLink.searchInternalLinks()}),500)})),u.url.on("paste",(function(){setTimeout(wpLink.correctURL,0)})),u.url.on("blur",wpLink.correctURL)},correctURL:function(){var e=u.url.val().trim();e&&l!==e&&!/^(?:[a-z]+:|#|\?|\.|\/)/.test(e)&&(u.url.val("http://"+e),l=e)},open:function(t,n,a){var r,s=e(document.body);s.addClass("modal-open"),wpLink.modalOpen=!0,wpLink.range=null,t&&(window.wpActiveEditor=t),window.wpActiveEditor&&(this.textarea=e("#"+window.wpActiveEditor).get(0),"undefined"!=typeof window.tinymce&&(s.append(u.backdrop,u.wrap),r=window.tinymce.get(window.wpActiveEditor),i=r&&!r.isHidden()?r:null),!wpLink.isMCE()&&document.selection&&(this.textarea.focus(),this.range=document.selection.createRange()),u.wrap.show(),u.backdrop.show(),wpLink.refresh(n,a),e(document).trigger("wplink-open",u.wrap))},isMCE:function(){return i&&!i.isHidden()},refresh:function(e,t){h.search.refresh(),h.recent.refresh(),wpLink.isMCE()?wpLink.mceRefresh(e,t):(u.wrap.hasClass("has-text-field")||u.wrap.addClass("has-text-field"),document.selection?document.selection.createRange().text||t||"":"undefined"!=typeof this.textarea.selectionStart&&this.textarea.selectionStart!==this.textarea.selectionEnd&&(t=this.textarea.value.substring(this.textarea.selectionStart,this.textarea.selectionEnd)||t||""),u.text.val(t),wpLink.setDefaultValues()),p?u.url.trigger("focus").trigger("blur"):window.setTimeout((function(){u.url[0].select(),u.url.trigger("focus")})),h.recent.ul.children().length||h.recent.ajax(),l=u.url.val().replace(/^http:\/\//,"")},hasSelectedText:function(e){var t,n,a,r=i.selection.getContent();if(/</.test(r)&&(!/^<a [^>]+>[^<]+<\/a>$/.test(r)||-1===r.indexOf("href=")))return!1;if(e.length){if(!(n=e[0].childNodes)||!n.length)return!1;for(a=n.length-1;a>=0;a--)if(3!=(t=n[a]).nodeType&&!window.tinymce.dom.BookmarkManager.isBookmarkNode(t))return!1}return!0},mceRefresh:function(e,n){var a,r,s=d(),l=this.hasSelectedText(s);s.length?(a=s.text(),r=s.attr("href"),a.trim()||(a=n||""),e&&(c.test(e)||o.test(e))&&(r=e),"_wp_link_placeholder"!==r?(u.url.val(r),u.openInNewTab.prop("checked","_blank"===s.attr("target")),u.submit.val(t.update)):this.setDefaultValues(a),e&&e!==r?u.search.val(e):u.search.val(""),window.setTimeout((function(){wpLink.searchInternalLinks()}))):(a=i.selection.getContent({format:"text"})||n||"",this.setDefaultValues(a)),l?(u.text.val(a),u.wrap.addClass("has-text-field")):(u.text.val(""),u.wrap.removeClass("has-text-field"))},close:function(t){e(document.body).removeClass("modal-open"),wpLink.modalOpen=!1,"noReset"!==t&&(wpLink.isMCE()?(i.plugins.wplink&&i.plugins.wplink.close(),i.focus()):(wpLink.textarea.focus(),wpLink.range&&(wpLink.range.moveToBookmark(wpLink.range.getBookmark()),wpLink.range.select()))),u.backdrop.hide(),u.wrap.hide(),l=!1,e(document).trigger("wplink-close",u.wrap)},getAttrs:function(){return wpLink.correctURL(),{href:u.url.val().trim(),target:u.openInNewTab.prop("checked")?"_blank":null}},buildHtml:function(e){var t='<a href="'+e.href+'"';return e.target&&(t+=' rel="noopener" target="'+e.target+'"'),t+">"},update:function(){wpLink.isMCE()?wpLink.mceUpdate():wpLink.htmlUpdate()},htmlUpdate:function(){var i,a,r,s,l,o,c,h=wpLink.textarea;if(h){i=wpLink.getAttrs(),a=u.text.val();var p=document.createElement("a");p.href=i.href,"javascript:"!==p.protocol&&"data:"!==p.protocol||(i.href=""),i.href&&(r=wpLink.buildHtml(i),document.selection&&wpLink.range?(h.focus(),wpLink.range.text=r+(a||wpLink.range.text)+"</a>",wpLink.range.moveToBookmark(wpLink.range.getBookmark()),wpLink.range.select(),wpLink.range=null):"undefined"!=typeof h.selectionStart&&(s=h.selectionStart,l=h.selectionEnd,o=s+(r=r+(c=a||h.value.substring(s,l))+"</a>").length,s!==l||c||(o-=4),h.value=h.value.substring(0,s)+r+h.value.substring(l,h.value.length),h.selectionStart=h.selectionEnd=o),wpLink.close(),h.focus(),e(h).trigger("change"),n.a11y.speak(t.linkInserted))}},mceUpdate:function(){var e,a,r,s=wpLink.getAttrs(),l=document.createElement("a");if(l.href=s.href,"javascript:"!==l.protocol&&"data:"!==l.protocol||(s.href=""),!s.href)return i.execCommand("unlink"),void wpLink.close();e=d(),i.undoManager.transact((function(){e.length||(i.execCommand("mceInsertLink",!1,{href:"_wp_link_placeholder","data-wp-temp-link":1}),e=i.$('a[data-wp-temp-link="1"]').removeAttr("data-wp-temp-link"),r=e.text().trim()),e.length?(u.wrap.hasClass("has-text-field")&&((a=u.text.val())?e.text(a):r||e.text(s.href)),s["data-wplink-edit"]=null,s["data-mce-href"]=s.href,e.attr(s)):i.execCommand("unlink")})),wpLink.close("noReset"),i.focus(),e.length&&(i.selection.select(e[0]),i.plugins.wplink&&i.plugins.wplink.checkLink(e[0])),i.nodeChanged(),n.a11y.speak(t.linkInserted)},updateFields:function(e,t){u.url.val(t.children(".item-permalink").val()),u.wrap.hasClass("has-text-field")&&!u.text.val()&&u.text.val(t.children(".item-title").text())},getUrlFromSelection:function(e){return e||(this.isMCE()?e=i.selection.getContent({format:"text"}):document.selection&&wpLink.range?e=wpLink.range.text:"undefined"!=typeof this.textarea.selectionStart&&(e=this.textarea.value.substring(this.textarea.selectionStart,this.textarea.selectionEnd))),(e=(e=e||"").trim())&&o.test(e)?"mailto:"+e:e&&c.test(e)?e.replace(/&amp;|&#0?38;/gi,"&"):""},setDefaultValues:function(e){u.url.val(this.getUrlFromSelection(e)),u.search.val(""),wpLink.searchInternalLinks(),u.submit.val(t.save)},searchInternalLinks:function(){var e,n=u.search.val()||"",i=parseInt(t.minInputLength,10)||3;if(n.length>=i){if(h.recent.hide(),h.search.show(),wpLink.lastSearch==n)return;wpLink.lastSearch=n,e=u.search.parent().find(".spinner").addClass("is-active"),h.search.change(n),h.search.ajax((function(){e.removeClass("is-active")}))}else h.search.hide(),h.recent.show()},next:function(){h.search.next(),h.recent.next()},prev:function(){h.search.prev(),h.recent.prev()},keydown:function(e){var t,n;27===e.keyCode?(wpLink.close(),e.stopImmediatePropagation()):9===e.keyCode&&("wp-link-submit"!==(n=e.target.id)||e.shiftKey?"wp-link-close"===n&&e.shiftKey&&(u.submit.trigger("focus"),e.preventDefault()):(u.close.trigger("focus"),e.preventDefault())),e.shiftKey||38!==e.keyCode&&40!==e.keyCode||(!document.activeElement||"link-title-field"!==document.activeElement.id&&"url-field"!==document.activeElement.id)&&(t=38===e.keyCode?"prev":"next",clearInterval(wpLink.keyInterval),wpLink[t](),wpLink.keyInterval=setInterval(wpLink[t],wpLink.keySensitivity),e.preventDefault())},keyup:function(e){38!==e.keyCode&&40!==e.keyCode||(clearInterval(wpLink.keyInterval),e.preventDefault())},delayedCallback:function(e,t){var n,i,a,r;return t?(setTimeout((function(){if(i)return e.apply(r,a);n=!0}),t),function(){if(n)return e.apply(this,arguments);a=arguments,r=this,i=!0}):e}},r=function(t,n){var i=this;this.element=t,this.ul=t.children("ul"),this.contentHeight=t.children("#link-selector-height"),this.waiting=t.find(".river-waiting"),this.change(n),this.refresh(),e("#wp-link .query-results, #wp-link #link-selector").on("scroll",(function(){i.maybeLoad()})),t.on("click","li",(function(t){i.select(e(this),t)}))},e.extend(r.prototype,{refresh:function(){this.deselect(),this.visible=this.element.is(":visible")},show:function(){this.visible||(this.deselect(),this.element.show(),this.visible=!0)},hide:function(){this.element.hide(),this.visible=!1},select:function(e,t){var n,i,a,r;e.hasClass("unselectable")||e==this.selected||(this.deselect(),this.selected=e.addClass("selected"),n=e.outerHeight(),i=this.element.height(),a=e.position().top,r=this.element.scrollTop(),a<0?this.element.scrollTop(r+a):a+n>i&&this.element.scrollTop(r+a-i+n),this.element.trigger("river-select",[e,t,this]))},deselect:function(){this.selected&&this.selected.removeClass("selected"),this.selected=!1},prev:function(){var e;this.visible&&(this.selected&&(e=this.selected.prev("li")).length&&this.select(e))},next:function(){if(this.visible){var t=this.selected?this.selected.next("li"):e("li:not(.unselectable):first",this.element);t.length&&this.select(t)}},ajax:function(e){var t=this,n=1==this.query.page?0:wpLink.minRiverAJAXDuration,i=wpLink.delayedCallback((function(n,i){t.process(n,i),e&&e(n,i)}),n);this.query.ajax(i)},change:function(e){this.query&&this._search==e||(this._search=e,this.query=new s(e),this.element.scrollTop(0))},process:function(n,i){var a="",r=!0,s="",l=1==i.page;n?e.each(n,(function(){s=r?"alternate":"",s+=this.title?"":" no-title",a+=s?'<li class="'+s+'">':"<li>",a+='<input type="hidden" class="item-permalink" value="'+this.permalink+'" />',a+='<span class="item-title">',a+=this.title?this.title:t.noTitle,a+='</span><span class="item-info">'+this.info+"</span></li>",r=!r})):l&&(a+='<li class="unselectable no-matches-found"><span class="item-title"><em>'+t.noMatchesFound+"</em></span></li>"),this.ul[l?"html":"append"](a)},maybeLoad:function(){var e=this,t=this.element,n=t.scrollTop()+t.height();!this.query.ready()||n<this.contentHeight.height()-wpLink.riverBottomThreshold||setTimeout((function(){var n=t.scrollTop(),i=n+t.height();!e.query.ready()||i<e.contentHeight.height()-wpLink.riverBottomThreshold||(e.waiting.addClass("is-active"),t.scrollTop(n+e.waiting.outerHeight()),e.ajax((function(){e.waiting.removeClass("is-active")})))}),wpLink.timeToTriggerRiver)}}),s=function(e){this.page=1,this.allLoaded=!1,this.querying=!1,this.search=e},e.extend(s.prototype,{ready:function(){return!(this.querying||this.allLoaded)},ajax:function(t){var n=this,i={action:"wp-link-ajax",page:this.page,_ajax_linking_nonce:u.nonce.val()};this.search&&(i.search=this.search),this.querying=!0,e.post(window.ajaxurl,i,(function(e){n.page++,n.querying=!1,n.allLoaded=!e,t(e,i)}),"json")}}),e(wpLink.init)}(jQuery,window.wpLinkL10n,window.wp);